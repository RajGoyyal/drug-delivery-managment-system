<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MedDelivery - Drug Delivery Management System</title>
  <meta name="description" content="Efficient drug delivery management system for healthcare professionals" />
  <meta name="author" content="MedDelivery Team" />

  <meta property="og:title" content="MedDelivery - Drug Delivery Management System" />
  <meta property="og:description" content="Efficient drug delivery management system for healthcare professionals" />
  <meta property="og:type" content="website" />


    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body { font-feature-settings: "cv02","cv03","cv04","cv11"; background: linear-gradient(145deg,#0f172a,#020617 70%) fixed; position:relative; min-height:100vh; color:#f1f5f9; }
      body::before{content:"";position:fixed;inset:0;background:radial-gradient(circle at 18% 18%, rgba(99,102,241,0.40), transparent 62%), radial-gradient(circle at 82% 75%, rgba(14,165,233,0.32), transparent 68%);pointer-events:none;z-index:-2;}
      body::after{content:"";position:fixed;inset:0;background:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.85" numOctaves="3" stitchTiles="stitch"/></filter><rect width="100%" height="100%" filter="url(%23n)" opacity="0.14"/></svg>');mix-blend-mode:overlay;pointer-events:none;z-index:-1;opacity:.28;}
      .fade-enter { opacity:0; transform: translateY(4px); }
      .fade-enter-active { transition: all .25s; opacity:1; transform: translateY(0); }
      .spinner { width:18px; height:18px; border:3px solid rgba(255,255,255,.35); border-top-color: #6366f1; border-radius:50%; animation: spin 0.8s linear infinite; }
      @keyframes spin { to { transform: rotate(360deg);} }
  /* Removed glass effect */
      .card-hover { transition: all .45s cubic-bezier(.4,.2,.2,1); }
      .card-hover:hover { transform: translateY(-4px); box-shadow: 0 16px 40px -10px rgba(0,0,0,.65), 0 0 0 1px rgba(255,255,255,0.05) inset; }
  .heading-gradient { background: linear-gradient(92deg,#fff 0%,#93c5fd 40%,#818cf8 60%,#c7d2fe 90%); -webkit-background-clip: text; background-clip:text; color:transparent; }
  :root { --font-display: 'Poppins','Inter','Segoe UI',system-ui,-apple-system,Roboto,'Helvetica Neue',Arial,sans-serif; }
  .display-heading{ font-family: var(--font-display); font-weight:600; letter-spacing:-0.025em; }
  /* Theme switch */
  .theme-switch{ position:relative; width:54px; height:36px; border-radius:999px; display:inline-flex; align-items:center; justify-content:flex-start; padding:0 6px; background:linear-gradient(140deg,#1e293b,#334155); border:1px solid #475569; cursor:pointer; transition:background .4s,border-color .4s; font-size:12px; align-self:center; }
  .theme-switch .ts-track{ position:absolute; inset:0; border-radius:inherit; background:linear-gradient(140deg,#334155,#1e293b); opacity:0; transition:opacity .4s; }
  .theme-switch .ts-thumb{ position:relative; z-index:1; width:24px; height:24px; border-radius:50%; background:linear-gradient(135deg,#0d9488,#0f766e); color:#fff; display:flex; align-items:center; justify-content:center; font-size:12px; box-shadow:0 2px 5px -1px rgba(0,0,0,0.4),0 0 0 1px rgba(255,255,255,0.08) inset; transform:translateX(0); transition:transform .45s cubic-bezier(.65,.05,.36,1), background .4s, box-shadow .35s; }
  .theme-switch:hover .ts-thumb{ box-shadow:0 3px 8px -2px rgba(0,0,0,0.5),0 0 0 1px rgba(255,255,255,0.12) inset; }
  .theme-switch:focus-visible{ outline:2px solid #6366f1; outline-offset:3px; }
  /* Light (dark blue) switch styling */
  .theme-switch[data-mode="light"]{ background:linear-gradient(140deg,#93c5fd,#60a5fa); border-color:#3b82f6; }
  .theme-switch[data-mode="light"] .ts-track{ opacity:.28; background:linear-gradient(140deg,#bfdbfe,#93c5fd); }
  .theme-switch[data-mode="light"] .ts-thumb{ transform:translateX(28px); background:linear-gradient(135deg,#2563eb,#1d4ed8); }
      /* Refresh buttons subtle style */
      button[id^="refresh-"], #inv-refresh { 
        font-weight:500; /* medium */
        font-size:12px; 
        text-transform:none; 
        letter-spacing:.015em; 
        color:#e2e8f0; 
        text-shadow:none;
      }
  #main-nav { position:relative; z-index:30; }
  .sticky-nav{position:sticky;top:0;z-index:40;padding-top:.5rem;background:linear-gradient(180deg,rgba(15,23,42,.95),rgba(15,23,42,.85));backdrop-filter:blur(14px);}      
  /* Removed moving tab indicator */
  .pill-btn { position:relative; z-index:1; display:flex; align-items:center; justify-content:center; height:36px; line-height:1; }
  /* Horizontal nav: keep in one line, allow scroll if overflow */
  .nav-scroll { flex-wrap:nowrap !important; overflow-x:auto; -ms-overflow-style:none; scrollbar-width:none; }
  .nav-scroll::-webkit-scrollbar{display:none;}
      /* Panels (reduce see-through) */
      [data-view].bg-slate-800{background:linear-gradient(155deg,rgba(30,41,59,0.94),rgba(15,23,42,0.88));backdrop-filter:blur(18px) saturate(160%);-webkit-backdrop-filter:blur(18px) saturate(160%);border-color:rgba(255,255,255,0.07);}
      /* Table enhancements */
      table thead{backdrop-filter:blur(12px);} table tbody tr:nth-child(even){background:rgba(255,255,255,0.015);} table tbody tr:hover{background:rgba(255,255,255,0.05);} th{font-weight:600; letter-spacing:.5px;}
      /* Scrollbars */
      .soft-scroll::-webkit-scrollbar{width:10px;} .soft-scroll::-webkit-scrollbar-track{background:transparent;} .soft-scroll::-webkit-scrollbar-thumb{background:#475569;border-radius:6px;} .soft-scroll::-webkit-scrollbar-thumb:hover{background:#64748b;}
      /* Search dropdown layering */
      #global-search-results{z-index:100;}
  /* ---- Light Theme (calm / low-flash redesign v2) ------------------------ */
  body.theme-light{
  /* Cooler, slightly darker bluish slate palette */
  --c-bg:#e4e9f5;            /* main page background (cool blue-tinted) */
  --c-bg-alt:#f1f5fe;        /* alt light surface */
  --c-surface:#f6f9ff;       /* primary card surface */
  --c-surface-alt:#d9e4f7;   /* hovered / subtle blocks */
  --c-border:#c0d2ea;        /* soft border */
  --c-border-strong:#a2bedd; /* stronger divider */
  --c-text:#102036;          /* main text (deep blue) */
  --c-text-soft:#334861;     /* secondary */
  --c-text-faint:#587296;    /* tertiary */
  /* Dark blue accent */
  --c-accent:#2563eb;        /* refined accent */
  --c-accent-hover:#1d4ed8;  /* hover deeper */
  --c-accent-soft:#d9e8ff;   /* soft ring / subtle bg */
  --c-accent-grad:linear-gradient(135deg,#3b82f6 0%, #2563eb 45%, #1d4ed8 100%);
  --g-nav:linear-gradient(110deg,rgba(59,130,246,0.18),rgba(37,99,235,0.22) 55%,rgba(29,78,216,0.35));
  --g-surface:linear-gradient(145deg,rgba(255,255,255,0.92),rgba(224,235,252,0.55));
  --g-card:linear-gradient(135deg,rgba(255,255,255,0.88),rgba(207,225,247,0.55));
  --g-focus:linear-gradient(135deg,#3b82f6,#1d4ed8);
  --c-danger-soft:#f6dde0;   /* subtle danger bg (unchanged) */
    --radius:14px;
    background:var(--c-bg);
    color:var(--c-text);
    font-feature-settings:"ss01" 1;
  }
  /* Light theme heading gradient override (dark blue spectrum) */
  body.theme-light .heading-gradient{ background:linear-gradient(92deg,#1e3a8a 0%,#1d4ed8 35%,#2563eb 60%,#60a5fa 90%); -webkit-background-clip:text; background-clip:text; color:transparent; }
  body.theme-light ::selection{ background:var(--c-accent); color:#fff; }
  body.theme-light #offline-banner{ background:#cf222e; }
  /* Remove decorative radial backdrops for light */
  body.theme-light::before, body.theme-light::after{ content:none; }
  /* Generic surfaces */
  body.theme-light .bg-slate-800\/60,
  body.theme-light .bg-slate-800\/70,
  body.theme-light .bg-slate-800,
  body.theme-light [data-view].bg-slate-800{ background:var(--c-surface)!important; border:1px solid var(--c-border)!important; backdrop-filter:none; -webkit-backdrop-filter:none; }
  body.theme-light .border-slate-700, body.theme-light .border-slate-700\/60, body.theme-light .border-slate-700\/70{ border-color:var(--c-border)!important; }
  /* Text remap */
  body.theme-light .text-slate-100, body.theme-light .text-slate-200{ color:var(--c-text)!important; }
  body.theme-light .text-slate-300{ color:var(--c-text-soft)!important; }
  body.theme-light .text-slate-400{ color:var(--c-text-soft)!important; }
  body.theme-light .text-slate-500, body.theme-light .text-slate-600{ color:var(--c-text-faint)!important; }
  /* Nav */
  body.theme-light #main-nav{ background:var(--g-nav); border:1px solid var(--c-border); box-shadow:0 2px 4px -2px rgba(0,0,0,0.08); backdrop-filter:blur(6px); }
  body.theme-light .tab-btn{ color:var(--c-text-soft); background:transparent; border:1px solid transparent; }
  body.theme-light .tab-btn.bg-indigo-600{ background:var(--c-accent)!important; background-image:var(--c-accent-grad)!important; color:#fff!important; box-shadow:0 3px 8px -3px rgba(0,0,0,0.25),0 0 0 1px rgba(255,255,255,0.15) inset; border-color:var(--c-accent-hover); }
  /* Other primary accent buttons (seed, export, etc.) */
  body.theme-light button.bg-indigo-600:not(.tab-btn){ background:var(--c-accent); background-image:var(--c-accent-grad); color:#fff; border:1px solid var(--c-accent-hover); box-shadow:0 2px 6px -2px rgba(0,0,0,0.25); transition:filter .25s, box-shadow .25s; }
  body.theme-light button.bg-indigo-600:not(.tab-btn):hover{ filter:brightness(1.07); box-shadow:0 3px 10px -2px rgba(0,0,0,0.3); }
  body.theme-light button.bg-indigo-600:not(.tab-btn):focus-visible{ outline:2px solid transparent; box-shadow:0 0 0 3px rgba(255,255,255,0.6),0 0 0 5px #446ac4; }
  body.theme-light .tab-btn:not(.bg-indigo-600):hover{ background:var(--c-surface-alt); color:var(--c-text); }
  /* Quiet buttons */
  body.theme-light .bg-slate-700, body.theme-light .bg-slate-700\/60, body.theme-light .bg-slate-700\/70{ background:var(--c-surface-alt)!important; color:var(--c-text-soft); }
  body.theme-light .bg-slate-600{ background:var(--c-surface-alt)!important; color:var(--c-text-soft); }
  body.theme-light .hover\:bg-slate-600:hover{ background:var(--c-surface-alt)!important; }
  body.theme-light .hover\:bg-slate-700:hover{ background:var(--c-surface-alt)!important; }
  body.theme-light .border-slate-600{ border-color:var(--c-border)!important; }
  /* Cards */
  body.theme-light .card-hover{ position:relative; background:var(--g-card); transition:box-shadow .3s, transform .3s; border-radius:var(--radius); }
  body.theme-light .card-hover::before{ content:""; position:absolute; inset:0; background:linear-gradient(160deg,rgba(255,255,255,0.35),rgba(255,255,255,0)); pointer-events:none; border-radius:inherit; }
  body.theme-light .card-hover:hover{ box-shadow:0 4px 14px -4px rgba(52,86,168,0.25),0 2px 6px -2px rgba(0,0,0,0.12); transform:translateY(-2px); }
  /* Tables */
  body.theme-light table thead{ background:var(--c-bg-alt); }
  body.theme-light table tbody tr:nth-child(even){ background:var(--c-bg); }
  body.theme-light table tbody tr:hover{ background:var(--c-surface-alt); }
  body.theme-light th{ color:var(--c-text-soft); font-weight:600; }
  /* Inputs */
  body.theme-light input, body.theme-light textarea, body.theme-light select{ background:var(--c-bg-alt)!important; border:1px solid var(--c-border)!important; color:var(--c-text)!important; box-shadow:none; }
  body.theme-light input:focus, body.theme-light textarea:focus, body.theme-light select:focus{ outline:2px solid var(--c-accent-soft); outline-offset:2px; border-color:var(--c-accent-hover)!important; box-shadow:0 0 0 2px rgba(62,95,167,0.15); }
  /* Scrollbars */
  body.theme-light .soft-scroll::-webkit-scrollbar-thumb{ background:var(--c-border-strong); }
  body.theme-light .soft-scroll::-webkit-scrollbar-thumb:hover{ background:var(--c-text-faint); }
  /* Force section panels that still carry dark utility classes to light surfaces */
  body.theme-light [data-view="deliveries"],
  body.theme-light [data-view="inventory"],
  body.theme-light [data-view="patients"],
  body.theme-light [data-view="deliveries"],
  body.theme-light [data-view="inventory"],
  body.theme-light [data-view="patients"],
  body.theme-light [data-view="all-deliveries"],
  body.theme-light [data-view="analytics"],
  body.theme-light [data-view="alerts"],
  body.theme-light [data-view="history"],
  body.theme-light [data-view="calendar"],
  body.theme-light [data-view="insights"]{
    background:var(--g-surface)!important;
    border-color:var(--c-border)!important;
    box-shadow:0 1px 3px rgba(0,0,0,0.05),0 0 0 1px rgba(255,255,255,0.4) inset;
  }
  body.theme-light #toast-wrap .bg-white{ background:var(--c-bg-alt)!important; border:1px solid var(--c-border); }
  /* Low stock badge */
  body.theme-light #nav-low-stock{ background:var(--c-danger-soft)!important; color:#9f2f2f!important; border-color:#edcaca!important; }
  /* Section separators subtle */
  body.theme-light [data-view] hr, body.theme-light .divide-y > * + *{ border-color:var(--c-border); }
  /* Dark-only accent fallback */
  body.theme-light .dark\:text-slate-300{ color:var(--c-text-faint)!important; }
  /* Fix low-contrast Tailwind opacity variant (text-slate-300/80) in light theme */
  body.theme-light .text-slate-300\/80{ color:var(--c-text-soft)!important; opacity:0.9!important; }
  /* General safeguard: any element with data-lowcontrast can be boosted in light mode */
  body.theme-light [data-lowcontrast]{ color:var(--c-text-soft)!important; opacity:0.95!important; }
  /* Smooth global theme transition */
  :root, body, body * { transition: background-color .55s ease, color .55s ease, border-color .55s ease, box-shadow .55s ease; }
  /* Avoid heavy transition on large images / canvases */
  canvas, img { transition: none !important; }
  /* Keyframe overlay flash suppression */
  .theme-xfade-enter{ position:relative; }
  .theme-xfade-enter::after{ content:""; position:fixed; inset:0; pointer-events:none; background:var(--c-bg,rgba(255,255,255,0.6)); opacity:0; animation: themeFlash .6s ease; mix-blend-mode:normal; }
  @keyframes themeFlash { 0%{opacity:.35;} 100%{opacity:0;} }
  /* Respect reduced motion */
  @media (prefers-reduced-motion: reduce){ :root, body, body * { transition:none !important; } .theme-xfade-enter::after{animation:none; display:none;} }
    </style>
  </head>
  <body class="min-h-screen bg-slate-900 text-slate-100 transition-colors">
  <div id="offline-banner" class="hidden fixed top-0 inset-x-0 z-50 bg-red-600 text-white text-center text-xs py-1 font-medium tracking-wide">OFFLINE – changes may fail to sync</div>
  <div class="max-w-6xl mx-auto p-6 space-y-10 pt-10">
  <header class="flex flex-col gap-4 pb-2 border-b border-slate-700/60">
        <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-2">
          <div>
            <h1 class="heading-gradient text-4xl font-semibold tracking-tight flex items-center gap-2">Friendly Med Pal <span class="text-xs font-medium px-2 py-0.5 rounded bg-indigo-600/20 text-indigo-300 border border-indigo-500/30 backdrop-blur-sm">v2</span></h1>
            <p class="text-slate-400 text-sm tracking-wide">Drug delivery & adherence tracking dashboard</p>
          </div>
          <div class="flex items-center gap-3 text-xs text-slate-400">
            <span id="api-indicator" class="inline-flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-slate-300 animate-pulse" id="api-dot"></span> API: checking</span>
          </div>
        </div>
        <div class="relative max-w-xl">
          <input id="global-search" placeholder="Search patients, drugs, deliveries…" class="w-full bg-slate-800/60 border border-slate-700 rounded px-3 py-2 pr-8 text-xs placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-indigo-600" />
          <svg class="w-4 h-4 absolute right-2 top-1/2 -translate-y-1/2 text-slate-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="7"/><path d="m21 21-4.35-4.35"/></svg>
          <div id="global-search-results" class="hidden absolute z-40 mt-1 inset-x-0 bg-slate-800 border border-slate-700 rounded shadow-lg max-h-72 overflow-auto text-xs"></div>
        </div>
      </header>
  <nav id="main-nav" class="sticky-nav nav-scroll flex gap-1 text-sm mt-2 p-1 rounded-full bg-slate-800/60 backdrop-blur border border-slate-700/70 relative">
  <button data-tab="dashboard" class="tab-btn pill-btn px-4 rounded-full bg-indigo-600 text-white shadow-inner whitespace-nowrap">Dashboard</button>
  <button data-tab="patients" class="tab-btn pill-btn px-4 rounded-full text-slate-300 hover:text-white whitespace-nowrap">Patients <span class="text-[10px] ml-1 opacity-60" data-count="patients"></span></button>
  <!-- Removed All Drugs tab (overview merged into Inventory) -->
  <!-- Merged Add Drug into Inventory: removed separate Add Drug tab -->
        <button data-tab="all-deliveries" class="tab-btn pill-btn px-4 rounded-full text-slate-300 hover:text-white whitespace-nowrap">All Deliveries <span class="text-[10px] ml-1 opacity-60" data-count="deliveries"></span></button>
  <button data-tab="deliveries" class="tab-btn pill-btn px-4 rounded-full text-slate-300 hover:text-white whitespace-nowrap">Schedule</button>
  <button data-tab="inventory" class="tab-btn pill-btn px-4 rounded-full text-slate-300 hover:text-white whitespace-nowrap">Inventory</button>
  <button data-tab="insights" class="tab-btn pill-btn px-4 rounded-full text-slate-300 hover:text-white whitespace-nowrap">Insights</button>
  <button data-tab="analytics" class="tab-btn pill-btn px-4 rounded-full text-slate-300 hover:text-white whitespace-nowrap">Analytics</button>
  <button data-tab="calendar" class="tab-btn pill-btn px-4 rounded-full text-slate-300 hover:text-white whitespace-nowrap">Calendar</button>
  <button data-tab="alerts" class="tab-btn pill-btn px-4 rounded-full text-slate-300 hover:text-white whitespace-nowrap">Alerts</button>
  <button data-tab="history" class="tab-btn pill-btn px-4 rounded-full text-slate-300 hover:text-white whitespace-nowrap">History</button>
  <button data-tab="settings" class="tab-btn pill-btn px-4 rounded-full text-slate-300 hover:text-white whitespace-nowrap">Settings</button>
  <button id="theme-toggle" class="theme-switch ml-1" role="switch" aria-checked="false" aria-label="Toggle light/dark theme" title="Toggle light/dark">
    <span class="ts-track"></span>
    <span class="ts-thumb" data-icon>☀️</span>
  </button>
      </nav>

  <section data-view="dashboard" class="space-y-8">
  <div class="relative overflow-hidden rounded-2xl bg-slate-800/70 p-10 card-hover border border-slate-700">
          <div class="absolute inset-0 opacity-[0.15] pointer-events-none" style="background-image: radial-gradient(circle at 25% 15%, #6366f1 0, transparent 60%), radial-gradient(circle at 75% 85%, #0ea5e9 0, transparent 55%);"></div>
          <div class="relative space-y-4">
  <h2 class="text-3xl display-heading tracking-tight heading-gradient flex items-center gap-3">Welcome back 👋 <button id="refresh-dashboard" class="text-xs px-3 py-1.5 rounded bg-slate-700 hover:bg-slate-600 border border-slate-600">Refresh</button></h2>
      <p class="text-sm text-slate-300/80 leading-relaxed max-w-prose">Monitor medication logistics, track adherence, and keep patient therapy on schedule. Use quick stats & distribution to spot issues early.</p>
            <div class="flex flex-wrap gap-2">
              <button id="seed-btn" class="text-xs px-3 py-1.5 rounded bg-indigo-600 hover:bg-indigo-500 text-white flex items-center gap-2 disabled:opacity-50" title="Insert demo data">Seed Demo Data</button>
              <button id="export-all" class="text-xs px-3 py-1.5 rounded bg-slate-700 hover:bg-slate-600 border border-slate-600" title="Export all data to CSV">Export All CSV</button>
            </div>
          </div>
        </div>
        <div id="stats" class="grid gap-4 sm:grid-cols-3"></div>
        <!-- Added low stock dashboard container -->
<div id="low-stock-dash" class="rounded-xl p-4 hidden bg-slate-800/70 border border-slate-700">
  <h3 class="text-sm font-medium mb-2">Low Stock</h3>
  <ul id="low-stock-list" class="text-[11px] space-y-1"></ul>
</div>
        <div class="grid gap-6 md:grid-cols-2">
          <div id="status-distribution" class="rounded-xl p-5 card-hover hidden bg-slate-800/70 border border-slate-700">
            <div class="flex items-center justify-between mb-3"><h3 class="text-sm font-medium flex items-center gap-2">Delivery Status Distribution <span id="dist-total" class="text-[11px] font-normal text-slate-400"></span></h3><canvas id="dist-chart" width="120" height="120" class="w-16 h-16"></canvas></div>
            <div id="dist-bars" class="space-y-3"></div>
          </div>
          <div id="activity-panel" class="rounded-xl p-5 flex flex-col card-hover bg-slate-800/70 border border-slate-700">
            <div class="flex items-center mb-3 gap-2"><h3 class="text-sm font-medium flex-1">Recent Activity</h3><input id="activity-search" placeholder="Filter" class="text-[11px] px-2 py-1 rounded bg-slate-700 border border-slate-600 w-32" /><button id="clear-activity" class="text-[10px] px-2 py-1 rounded bg-slate-700 hover:bg-slate-600">Clear</button></div>
            <div id="activity-empty" class="text-[11px] text-slate-500">No activity yet. Actions you take will appear here.</div>
            <ul id="activity-log" class="space-y-2 text-[11px] overflow-auto max-h-64 soft-scroll"></ul>
          </div>
        </div>
      </section>

      <!-- Patients View (merged overview + add form) -->
  <section data-view="patients" class="bg-slate-800 border border-slate-700 rounded-lg shadow p-5 space-y-6 hidden">
    <div class="flex flex-col sm:flex-row sm:items-center gap-3">
  <h2 class="text-lg display-heading heading-gradient flex items-center gap-3">Patients <button id="refresh-patients" class="text-[10px] px-2 py-1 rounded bg-slate-700 hover:bg-slate-600 border border-slate-600">Refresh</button></h2>
      <div class="flex items-center gap-2 ml-auto">
        <input id="all-patients-search" placeholder="Search" class="bg-slate-900/40 border border-slate-600 rounded px-2 py-1 text-xs placeholder-slate-500" />
        <button id="export-all-patients" class="text-[10px] px-2 py-1 rounded bg-indigo-600 hover:bg-indigo-500 text-white">Export All</button>
        <button id="export-all-patients-filtered" class="text-[10px] px-2 py-1 rounded bg-slate-700 hover:bg-slate-600 text-slate-200">Export Filtered</button>
        <select id="all-patients-pagesize" class="bg-slate-900/40 border border-slate-600 rounded px-2 py-1 text-[10px]">
          <option>25</option><option>50</option><option>100</option>
        </select>
      </div>
    </div>
    <details open class="rounded border border-slate-700/70 bg-slate-900/30 p-4">
      <summary class="cursor-pointer text-sm font-medium mb-2">Add Patient</summary>
      <form id="patient-form" class="grid gap-3 text-sm mt-2">
        <input name="name" required placeholder="Name" class="border border-slate-600 rounded px-3 py-2 bg-slate-700 placeholder-slate-400 text-slate-100" />
        <input name="age" type="number" min="0" placeholder="Age" class="border border-slate-600 rounded px-3 py-2 bg-slate-700 placeholder-slate-400 text-slate-100" />
        <input name="condition" placeholder="Condition" class="border border-slate-600 rounded px-3 py-2 bg-slate-700 placeholder-slate-400 text-slate-100" />
        <div class="flex items-center gap-3">
          <button class="bg-indigo-600 hover:bg-indigo-500 text-white rounded px-4 py-2 font-medium disabled:opacity-50 flex items-center gap-2" id="patient-submit"><span>Add Patient</span><span class="hidden spinner" id="patient-spinner"></span></button>
          <p class="text-xs text-red-500" id="patient-error"></p>
        </div>
      </form>
    </details>
    <div class="overflow-auto soft-scroll max-h-[60vh] rounded-lg border border-slate-700/70">
      <table class="w-full text-left text-xs" id="tbl-all-patients">
        <thead class="bg-slate-800/60 sticky top-0 backdrop-blur select-none">
          <tr class="text-slate-400">
            <th data-sort="id" class="py-2 px-3 font-medium cursor-pointer">ID</th>
            <th data-sort="name" class="py-2 px-3 font-medium cursor-pointer">Name</th>
            <th data-sort="age" class="py-2 px-3 font-medium cursor-pointer">Age</th>
            <th data-sort="condition" class="py-2 px-3 font-medium cursor-pointer">Condition</th>
            <th data-sort="contact" class="py-2 px-3 font-medium cursor-pointer">Contact</th>
          </tr>
        </thead>
        <tbody id="all-patients-body" class="divide-y divide-slate-800"></tbody>
      </table>
    </div>
    <div class="flex items-center justify-between text-[10px] mt-1">
      <div id="all-patients-info" class="text-slate-400"></div>
      <div class="flex gap-1" id="all-patients-pager"></div>
    </div>
    <div id="all-patients-empty" class="text-[11px] text-slate-500"></div>
    <ul id="patient-list" class="hidden"></ul>
  </section>

  <!-- (Removed separate Drugs View: merged into Inventory section) -->

      <!-- Deliveries View -->
  <section data-view="deliveries" class="bg-slate-800 border border-slate-700 rounded-lg shadow p-5 space-y-4 hidden">
  <h2 class="font-semibold flex items-center gap-4">Deliveries <span class="text-xs font-normal text-slate-400" id="refresh-countdown"></span><button id="refresh-deliveries" class="text-[10px] px-2 py-1 rounded border border-slate-600 bg-slate-700 hover:bg-slate-600">Refresh</button><label class="ml-auto inline-flex items-center gap-1 text-xs cursor-pointer select-none"><input type="checkbox" id="auto-refresh" class="accent-indigo-500" checked /> Auto</label><button id="toggle-overdue" class="text-[10px] px-2 py-1 rounded border border-slate-600 bg-slate-700 hover:bg-slate-600" title="Toggle overdue pending deliveries">Overdue</button><button id="export-deliveries" class="text-[10px] px-2 py-1 rounded bg-slate-700 hover:bg-slate-600 border border-slate-600">Export</button></h2>
    <div id="delivery-status-filters" class="flex flex-wrap gap-2 text-[11px]"></div>
        <form id="delivery-form" class="grid gap-3 md:grid-cols-2 text-sm">
  <div class="relative" id="patient-picker-wrap">
    <input type="hidden" name="patient_id" />
    <button type="button" id="patient-picker-btn" class="w-full border border-slate-600 rounded px-3 py-2 bg-slate-700 text-left text-slate-300 text-xs flex items-center justify-between">Select patient<span id="patient-picker-current" class="truncate ml-2 font-medium"></span><span class="text-[10px] text-slate-400 ml-auto">▾</span></button>
    <div id="patient-picker-panel" class="hidden absolute z-30 mt-1 w-72 max-h-64 overflow-auto bg-slate-800 border border-slate-700 rounded shadow-lg p-2 space-y-2">
      <input id="patient-picker-search" placeholder="Search patients" class="w-full px-2 py-1 rounded bg-slate-700 border border-slate-600 text-[11px]" />
      <ul id="patient-picker-list" class="text-[11px] space-y-1"></ul>
      <div id="patient-picker-empty" class="text-[10px] text-slate-500 hidden">No matches</div>
    </div>
  </div>
  <div class="relative" id="drug-picker-wrap">
    <input type="hidden" name="drug_id" />
    <button type="button" id="drug-picker-btn" class="w-full border border-slate-600 rounded px-3 py-2 bg-slate-700 text-left text-slate-300 text-xs flex items-center justify-between">Select drug<span id="drug-picker-current" class="truncate ml-2 font-medium"></span><span class="text-[10px] text-slate-400 ml-auto">▾</span></button>
    <div id="drug-picker-panel" class="hidden absolute z-30 mt-1 w-72 max-h-64 overflow-auto bg-slate-800 border border-slate-700 rounded shadow-lg p-2 space-y-2">
      <input id="drug-picker-search" placeholder="Search drugs" class="w-full px-2 py-1 rounded bg-slate-700 border border-slate-600 text-[11px]" />
      <ul id="drug-picker-list" class="text-[11px] space-y-1"></ul>
      <div id="drug-picker-empty" class="text-[10px] text-slate-500 hidden">No matches</div>
    </div>
  </div>
  <input type="datetime-local" name="scheduled_for" required class="border border-slate-600 rounded px-3 py-2 md:col-span-2 bg-slate-700 text-slate-100" />
  <input type="number" min="1" name="quantity" value="1" required placeholder="Qty" class="border border-slate-600 rounded px-3 py-2 bg-slate-700 text-slate-100" />
  <input name="notes" placeholder="Notes" class="border border-slate-600 rounded px-3 py-2 md:col-span-2 bg-slate-700 placeholder-slate-400 text-slate-100" />
          <div class="flex items-center gap-3 md:col-span-2">
            <button class="bg-indigo-600 hover:bg-indigo-500 text-white rounded px-4 py-2 font-medium flex items-center gap-2 disabled:opacity-50" id="delivery-submit"><span>Schedule Delivery</span><span class="hidden spinner" id="delivery-spinner"></span></button>
            <p class="text-xs text-red-500" id="delivery-error"></p>
          </div>
        </form>
        <div id="deliveries" class="space-y-2 text-xs"></div>
      </section>

      <!-- History View -->
    <section data-view="history" class="bg-slate-800 border border-slate-700 rounded-lg shadow p-5 space-y-4 hidden">
  <h2 class="font-semibold flex items-center gap-4">History <span class="text-xs font-normal text-slate-400" id="history-count"></span><button id="refresh-history" class="text-[10px] px-2 py-1 rounded border border-slate-600 bg-slate-700 hover:bg-slate-600 ml-auto">Refresh</button></h2>
        <div class="flex flex-wrap gap-3 text-xs items-end">
          <label class="flex flex-col gap-1">Status
            <select id="history-status" class="border border-slate-600 rounded px-2 py-1 bg-slate-700 text-slate-100">
              <option value="">All</option>
              <option>pending</option>
              <option>delivered</option>
              <option>missed</option>
              <option>cancelled</option>
            </select>
          </label>
          <label class="flex flex-col gap-1">Search
            <input id="history-search" placeholder="patient/drug/id" class="border border-slate-600 rounded px-2 py-1 bg-slate-700 placeholder-slate-400 text-slate-100" />
          </label>
          <button id="history-refresh" class="ml-auto px-3 py-1 rounded bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600">Refresh</button>
        </div>
    <div id="history-list" class="divide-y divide-slate-100 text-xs max-h-80 overflow-auto"></div>
      </section>

      <!-- Analytics View -->
      <section data-view="analytics" class="bg-slate-800 border border-slate-700 rounded-lg shadow p-5 space-y-5 hidden">
  <h2 class="font-semibold flex items-center gap-3">Analytics <span id="analytics-range" class="text-xs font-normal text-slate-400"></span>
    <select id="analytics-range-select" class="text-[10px] bg-slate-700 border border-slate-600 rounded px-2 py-1">
      <option value="7">7d</option>
      <option value="14" selected>14d</option>
      <option value="30">30d</option>
    </select>
    <button id="refresh-analytics" class="text-[10px] px-2 py-1 rounded bg-slate-700 hover:bg-slate-600 border border-slate-600 ml-auto">Refresh</button>
  </h2>
        <div id="analytics-metrics" class="grid gap-3 sm:grid-cols-2 lg:grid-cols-4"></div>
        <div class="grid gap-4 md:grid-cols-2">
          <div class="space-y-3">
            <h3 class="text-sm font-medium flex items-center gap-2">Daily Delivery Volume <button id="analytics-refresh" class="text-[10px] px-2 py-0.5 rounded bg-slate-700 hover:bg-slate-600">Reload</button></h3>
            <canvas id="daily-line" height="160" class="w-full bg-slate-900/40 rounded border border-slate-700"></canvas>
          </div>
          <div class="space-y-3">
            <h3 class="text-sm font-medium">Status Mix</h3>
            <div id="analytics-status" class="text-[11px] space-y-2"></div>
            <canvas id="status-bars" height="160" class="w-full bg-slate-900/40 rounded border border-slate-700"></canvas>
          </div>
        </div>
        <div class="space-y-2">
          <h3 class="text-sm font-medium">Top Patients by Deliveries</h3>
          <ol id="top-patients" class="text-[11px] space-y-1 list-decimal list-inside"></ol>
        </div>
        <div class="space-y-2">
          <h3 class="text-sm font-medium">Top Drugs by Quantity</h3>
          <ol id="top-drugs" class="text-[11px] space-y-1 list-decimal list-inside"></ol>
        </div>
      </section>

      <!-- Calendar View -->
      <section data-view="calendar" class="bg-slate-800 border border-slate-700 rounded-lg shadow p-5 space-y-5 hidden">
        <div class="flex items-center gap-3">
          <h2 class="font-semibold flex-1 flex items-center gap-3" id="cal-title">Calendar <button id="refresh-calendar" class="text-[10px] px-2 py-1 rounded bg-slate-700 hover:bg-slate-600 border border-slate-600">Refresh</button></h2>
          <div class="flex gap-1">
            <button id="cal-prev" class="px-2 py-1 text-xs rounded bg-slate-700 hover:bg-slate-600">Prev</button>
            <button id="cal-today" class="px-2 py-1 text-xs rounded bg-slate-700 hover:bg-slate-600">Today</button>
            <button id="cal-next" class="px-2 py-1 text-xs rounded bg-slate-700 hover:bg-slate-600">Next</button>
          </div>
        </div>
        <div id="cal-grid" class="grid grid-cols-7 gap-2 text-center text-[11px]"></div>
        <div>
          <h3 class="text-sm font-medium mb-2">Selected Day</h3>
          <div id="cal-day-list" class="space-y-2 text-[11px] max-h-60 overflow-auto"></div>
        </div>
      </section>

      <!-- Alerts View -->
      <section data-view="alerts" class="bg-slate-800 border border-slate-700 rounded-lg shadow p-5 space-y-4 hidden">
  <h2 class="font-semibold flex items-center gap-2">Alerts <span id="alert-count" class="text-xs font-normal text-slate-400"></span><button id="refresh-alerts" class="text-[10px] px-2 py-1 rounded bg-slate-700 hover:bg-slate-600 border border-slate-600 ml-auto">Refresh</button></h2>
        <div id="alert-list" class="space-y-2 text-[11px]"></div>
      </section>

      <!-- Settings View -->
      <section data-view="settings" class="bg-slate-800 border border-slate-700 rounded-lg shadow p-5 space-y-6 hidden">
  <h2 class="font-semibold flex items-center gap-3">Settings <button id="refresh-settings" class="text-[10px] px-2 py-1 rounded bg-slate-700 hover:bg-slate-600 border border-slate-600">Reload Defaults</button></h2>
        <form id="settings-form" class="space-y-4 text-sm max-w-md">
          <div class="flex flex-col gap-1">
            <label for="set-refresh" class="text-xs uppercase tracking-wide text-slate-400">Auto Refresh Interval (seconds)</label>
            <input type="number" min="5" max="300" id="set-refresh" class="bg-slate-700 border border-slate-600 rounded px-3 py-2" />
            <p class="text-[11px] text-slate-500">Controls deliveries + stats auto-refresh cadence.</p>
          </div>
          <div class="flex flex-col gap-1">
            <label for="set-activity-display" class="text-xs uppercase tracking-wide text-slate-400">Activity Display Limit</label>
            <input type="number" min="10" max="200" id="set-activity-display" class="bg-slate-700 border border-slate-600 rounded px-3 py-2" />
          </div>
          <div class="flex flex-col gap-1">
            <label for="set-activity-store" class="text-xs uppercase tracking-wide text-slate-400">Activity Store Limit</label>
            <input type="number" min="50" max="1000" id="set-activity-store" class="bg-slate-700 border border-slate-600 rounded px-3 py-2" />
          </div>
          <div class="flex items-center gap-2">
            <button class="bg-indigo-600 hover:bg-indigo-500 text-white rounded px-4 py-2 text-sm" type="submit">Save Settings</button>
            <span id="settings-status" class="text-[11px] text-slate-400"></span>
          </div>
        </form>
        <div class="text-[11px] text-slate-500">Shortcuts: Alt+1..8 switch tabs, / focus search, Ctrl+Shift+S seed, Ctrl+Shift+E export all.</div>
      </section>

      <!-- Insights View -->
      <section data-view="insights" class="bg-slate-800 border border-slate-700 rounded-lg shadow p-5 space-y-6 hidden">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold flex items-center gap-2">AI Insights <span id="ai-badge" class="text-[10px] px-2 py-0.5 rounded bg-slate-700 text-slate-300 border border-slate-600">Loading</span></h2>
          <div class="flex gap-2">
            <button id="insights-refresh" class="text-xs px-3 py-1.5 rounded bg-slate-700 hover:bg-slate-600 border border-slate-600">Refresh</button>
            <button id="insights-toggle-structured" class="text-xs px-3 py-1.5 rounded bg-slate-700 hover:bg-slate-600 border border-slate-600" title="Show/hide structured data backing the summary">Show Data</button>
            <button id="insights-explain-summary" class="text-xs px-3 py-1.5 rounded bg-slate-700 hover:bg-slate-600 border border-slate-600" title="Ask AI to explain how it formed the summary">Explain</button>
            <button id="insights-challenge" class="text-xs px-3 py-1.5 rounded bg-slate-700 hover:bg-slate-600 border border-slate-600" title="Cross‑examine / challenge potential assumptions">Cross Examine</button>
          </div>
        </div>
        <div id="ai-summary" class="text-sm leading-relaxed text-slate-300 whitespace-pre-wrap bg-slate-900/40 border border-slate-700 rounded p-4 relative min-h-[90px] flex items-start"><span class="spinner mr-3"></span>Generating summary…</div>
        <div id="insights-structured" class="hidden space-y-5 text-[13px]">
          <div id="insights-adherence" class="bg-slate-900/40 border border-slate-700 rounded p-4 space-y-3">
            <h3 class="text-xs uppercase tracking-wide text-slate-400 flex items-center gap-2">Adherence <button data-explain-adherence class="text-[10px] px-2 py-0.5 rounded bg-slate-700 hover:bg-slate-600 border border-slate-600">Explain</button></h3>
            <div id="adherence-summary" class="text-slate-300"></div>
            <div class="flex gap-2 pt-1">
              <button id="btn-explain-adherence" class="text-[10px] px-2 py-0.5 rounded bg-indigo-600/20 text-indigo-300 border border-indigo-600/40 hover:bg-indigo-600/30">Explain</button>
            </div>
            <ul id="risk-patients" class="space-y-1"></ul>
          </div>
          <div id="insights-inventory" class="bg-slate-900/40 border border-slate-700 rounded p-4 space-y-3">
            <h3 class="text-xs uppercase tracking-wide text-slate-400 flex items-center gap-2">Inventory Issues <button data-explain-inventory class="text-[10px] px-2 py-0.5 rounded bg-slate-700 hover:bg-slate-600 border border-slate-600">Explain</button></h3>
            <ul id="inventory-issues" class="space-y-1"></ul>
          </div>
          <div id="insights-recommendations" class="bg-slate-900/40 border border-slate-700 rounded p-4 space-y-3">
            <h3 class="text-xs uppercase tracking-wide text-slate-400 flex items-center gap-2">Recommendations <button data-explain-recs class="text-[10px] px-2 py-0.5 rounded bg-slate-700 hover:bg-slate-600 border border-slate-600">Explain</button></h3>
            <ol id="recommendations-list" class="space-y-1 list-decimal list-inside"></ol>
          </div>
          <div class="text-[10px] text-slate-500" id="insights-disclaimer"></div>
        </div>
        <div class="space-y-3">
          <h3 class="text-sm font-medium">Operational Q&A</h3>
          <div class="mt-0 border-t border-slate-700 pt-0">
            <div class="flex items-center justify-between mb-2">
              <h4 class="text-xs font-semibold text-slate-400 tracking-wide">RAG Question Answering</h4>
              <button id="rag-toggle-context" class="text-[10px] px-2 py-0.5 rounded bg-slate-800 border border-slate-700 hover:bg-slate-700">Show Context Keys</button>
            </div>
            <form id="rag-form" class="flex flex-col gap-2 mb-2">
              <div class="flex gap-2">
                <input id="rag-input" type="text" placeholder="Ask about patients, drugs, adherence, inventory..." class="flex-1 bg-slate-800 border border-slate-600 rounded px-2 py-1 text-sm outline-none focus:ring focus:ring-indigo-600/40" />
                <button id="rag-send" type="submit" class="px-3 py-1 rounded bg-indigo-600 hover:bg-indigo-500 text-white text-sm">Ask</button>
              </div>
              <label class="flex items-center gap-2 text-[11px] text-slate-400 select-none"><input id="rag-include-context" type="checkbox" class="scale-90"> Include context excerpt (debug)</label>
            </form>
            <div id="rag-status" class="text-[11px] text-slate-500 mb-1"></div>
            <div id="rag-answer" class="prose prose-invert max-w-none text-sm leading-relaxed"></div>
            <pre id="rag-context-keys" class="hidden mt-3 max-h-32 overflow-auto bg-slate-900/60 border border-slate-700 rounded p-2 text-[10px]"></pre>
          </div>
          <h4 class="text-xs font-semibold text-slate-400 tracking-wide pt-2 border-t border-slate-700">Free-form Assistant Chat</h4>
          <div id="ai-chat-log" class="space-y-2 max-h-64 overflow-auto soft-scroll bg-slate-900/40 border border-slate-700 rounded p-3 text-sm"></div>
          <div class="flex flex-wrap gap-2 mt-2 text-[10px]">
            <label class="flex items-center gap-1">W <input id="ai-img-width" type="number" min="64" max="1024" value="512" class="w-16 bg-slate-800 border border-slate-600 rounded px-1 py-0.5" /></label>
            <label class="flex items-center gap-1">H <input id="ai-img-height" type="number" min="64" max="1024" value="512" class="w-16 bg-slate-800 border border-slate-600 rounded px-1 py-0.5" /></label>
            <select id="ai-img-style" class="bg-slate-800 border border-slate-600 rounded px-2 py-1">
              <option value="cool">Cool</option>
              <option value="warm">Warm</option>
              <option value="mono">Mono</option>
            </select>
            <button id="ai-rewrite-btn" class="ml-auto px-2 py-1 rounded bg-slate-700 hover:bg-slate-600 border border-slate-600">Rewrite Last</button>
            <select id="ai-rewrite-mode" class="bg-slate-800 border border-slate-600 rounded px-2 py-1">
              <option value="simplify">Simplify</option>
              <option value="bulletize">Bulletize</option>
            </select>
          </div>
          <div id="ai-image-gallery" class="grid grid-cols-2 gap-2 mt-3"></div>
          <form id="ai-chat-form" class="flex gap-2">
            <input id="ai-chat-input" placeholder="Chat or /img prompt (e.g. /img adherence trend icon)…" class="flex-1 px-3 py-2 rounded bg-slate-700 border border-slate-600 text-sm placeholder-slate-400" />
            <button class="px-4 py-2 rounded bg-indigo-600 hover:bg-indigo-500 text-white text-sm disabled:opacity-50" id="ai-chat-send">Send</button>
          </form>
          <div id="ai-chat-hint" class="text-[11px] text-slate-500">Use /img to generate a placeholder image (no external AI key needed).</div>
        </div>
      </section>

  <!-- (All Patients Overview merged into Patients section above) -->

  <!-- (Removed standalone All Drugs section: now embedded in Inventory) -->

      <!-- All Deliveries Overview -->
  <section data-view="all-deliveries" class="rounded-xl p-6 space-y-4 hidden bg-slate-800/70 border border-slate-700">
        <div class="flex flex-col sm:flex-row sm:items-center gap-3">
          <h2 class="text-lg display-heading heading-gradient flex items-center gap-3">All Deliveries <button id="refresh-all-deliveries" class="text-[10px] px-2 py-1 rounded bg-slate-700 hover:bg-slate-600 border border-slate-600">Refresh</button></h2>
          <div class="flex items-center gap-2 ml-auto">
            <input id="all-deliveries-search" placeholder="Search (id / status / notes)" class="bg-slate-900/40 border border-slate-600 rounded px-2 py-1 text-xs placeholder-slate-500" />
            <button id="export-all-deliveries" class="text-[10px] px-2 py-1 rounded bg-indigo-600 hover:bg-indigo-500 text-white">Export All</button>
            <button id="export-all-deliveries-filtered" class="text-[10px] px-2 py-1 rounded bg-slate-700 hover:bg-slate-600 text-slate-200">Export Filtered</button>
            <select id="all-deliveries-pagesize" class="bg-slate-900/40 border border-slate-600 rounded px-2 py-1 text-[10px]">
              <option>25</option><option>50</option><option>100</option>
            </select>
            <input type="date" id="deliveries-date-from" class="bg-slate-900/40 border border-slate-600 rounded px-2 py-1 text-[10px]" title="From date" />
            <input type="date" id="deliveries-date-to" class="bg-slate-900/40 border border-slate-600 rounded px-2 py-1 text-[10px]" title="To date" />
            <div class="relative" id="delivery-columns-wrap">
              <button id="delivery-columns-btn" class="text-[10px] px-2 py-1 rounded border border-slate-600 bg-slate-700 hover:bg-slate-600">Columns</button>
              <div id="delivery-columns-menu" class="hidden absolute right-0 mt-1 w-40 bg-slate-800 border border-slate-700 rounded shadow-lg p-2 text-[11px] space-y-1">
                <label class="flex items-center gap-2"><input type="checkbox" data-col="patient" checked class="accent-indigo-500"/> Patient</label>
                <label class="flex items-center gap-2"><input type="checkbox" data-col="drug" checked class="accent-indigo-500"/> Drug</label>
                <label class="flex items-center gap-2"><input type="checkbox" data-col="scheduled_for" checked class="accent-indigo-500"/> Scheduled</label>
                <label class="flex items-center gap-2"><input type="checkbox" data-col="status" checked class="accent-indigo-500"/> Status</label>
                <label class="flex items-center gap-2"><input type="checkbox" data-col="notes" checked class="accent-indigo-500"/> Notes</label>
              </div>
            </div>
            <button id="export-json" class="text-[10px] px-2 py-1 rounded bg-emerald-600 hover:bg-emerald-500 text-white" title="Download JSON backup">JSON</button>
          </div>
        </div>
        <div class="overflow-auto soft-scroll max-h-[60vh] rounded-lg border border-slate-700/70">
          <table class="w-full text-left text-[11px]" id="tbl-all-deliveries">
            <thead class="bg-slate-800/60 sticky top-0 backdrop-blur select-none">
              <tr class="text-slate-400">
                <th class="py-2 px-3 font-medium"><input type="checkbox" id="deliveries-select-all" class="accent-indigo-500" title="Select all on page" /></th>
                <th data-sort="id" class="py-2 px-3 font-medium cursor-pointer">ID</th>
                <th data-sort="quantity" class="py-2 px-3 font-medium cursor-pointer">Qty</th>
                <th data-sort="patient_id" class="py-2 px-3 font-medium cursor-pointer">Patient</th>
                <th data-sort="drug_id" class="py-2 px-3 font-medium cursor-pointer">Drug</th>
                <th data-sort="scheduled_for" class="py-2 px-3 font-medium cursor-pointer">Scheduled</th>
                <th data-sort="status" class="py-2 px-3 font-medium cursor-pointer">Status</th>
                <th data-sort="notes" class="py-2 px-3 font-medium cursor-pointer">Notes</th>
              </tr>
            </thead>
            <tbody id="all-deliveries-body" class="divide-y divide-slate-800"></tbody>
          </table>
        </div>
        <div id="deliveries-bulk-bar" class="hidden bg-slate-800/70 border border-slate-700 rounded p-2 text-[11px] flex flex-wrap items-center gap-2">
          <span id="deliveries-bulk-count" class="font-medium"></span>
          <button data-bulk-status="delivered" class="px-2 py-1 rounded bg-emerald-600/70 hover:bg-emerald-600">Mark Delivered</button>
          <button data-bulk-status="missed" class="px-2 py-1 rounded bg-red-600/70 hover:bg-red-600">Mark Missed</button>
          <button data-bulk-status="cancelled" class="px-2 py-1 rounded bg-slate-600/70 hover:bg-slate-600">Cancel</button>
          <button id="bulk-delete-deliveries" class="ml-2 px-2 py-1 rounded bg-red-700/80 hover:bg-red-700">Delete</button>
          <button id="bulk-clear" class="px-2 py-1 rounded bg-slate-700 hover:bg-slate-600">Clear</button>
        </div>
        <div class="flex items-center justify-between text-[10px] mt-1">
          <div id="all-deliveries-info" class="text-slate-400"></div>
          <div class="flex gap-1" id="all-deliveries-pager"></div>
        </div>
        <div id="all-deliveries-empty" class="text-[11px] text-slate-500"></div>
      </section>

      <!-- Inventory View -->
      <section data-view="inventory" class="hidden bg-slate-800/90 border border-slate-700 rounded-xl shadow p-5 space-y-5 relative">
        <div id="inv-loading" class="hidden absolute inset-0 backdrop-blur-sm bg-slate-900/40 z-20 flex flex-col items-center justify-center gap-3 text-xs text-slate-300">
          <div class="spinner"></div>
          <span>Loading inventory…</span>
        </div>
        <div class="flex flex-wrap items-center gap-3">
          <h2 class="font-semibold flex-1 flex items-center gap-3 text-lg">Inventory <span id="inv-low-count" class="text-[11px] text-rose-300/80 hidden"></span></h2>
          <div id="inv-metrics" class="flex flex-wrap gap-2 text-[10px]"></div>
          <button id="inv-refresh" class="text-[11px] px-3 py-1.5 rounded bg-indigo-600 hover:bg-indigo-500 text-white">Refresh</button>
          <button id="inv-export" class="text-[11px] px-3 py-1.5 rounded bg-slate-700 hover:bg-slate-600">Export CSV</button>
          <button id="inv-add-drug-jump" class="text-[11px] px-3 py-1.5 rounded bg-emerald-600 hover:bg-emerald-500 text-white" title="Open Add Drug">+ Drug</button>
        </div>
        <!-- Inline Add Drug Panel (merged) -->
        <details id="inv-add-drug-panel" class="rounded-lg border border-slate-700/70 bg-slate-900/40 p-4 space-y-4">
          <summary class="cursor-pointer list-none flex items-center gap-3 text-sm font-medium">
            <span class="flex items-center gap-2"><span class="inline-block w-2 h-2 rounded-full bg-indigo-500 animate-pulse"></span>Add New Drug</span>
            <span class="text-[11px] text-slate-400 font-normal">(Form from merged Drugs view)</span>
          </summary>
          <div class="flex flex-wrap items-center gap-2 text-[11px]">
            <input id="drug-filter" placeholder="Filter" class="px-2 py-1 rounded bg-slate-700 border border-slate-600 w-40" />
            <button id="refresh-drugs" class="text-[10px] px-2 py-1 rounded bg-slate-700 hover:bg-slate-600 border border-slate-600">Refresh</button>
            <button id="export-drugs" class="text-[10px] px-2 py-1 rounded bg-slate-700 hover:bg-slate-600 border border-slate-600">Export</button>
          </div>
          <form id="drug-form" class="grid gap-3 md:grid-cols-2 text-sm">
            <input name="name" required placeholder="Name" class="border border-slate-600 rounded px-3 py-2 bg-slate-700 placeholder-slate-400 text-slate-100 md:col-span-1" />
            <input name="dosage" placeholder="Dosage" class="border border-slate-600 rounded px-3 py-2 bg-slate-700 placeholder-slate-400 text-slate-100 md:col-span-1" />
            <input name="stock" type="number" min="0" placeholder="Initial Stock" class="border border-slate-600 rounded px-3 py-2 bg-slate-700 placeholder-slate-400 text-slate-100" />
            <input name="reorder_level" type="number" min="0" placeholder="Reorder Level" class="border border-slate-600 rounded px-3 py-2 bg-slate-700 placeholder-slate-400 text-slate-100" />
            <div class="md:col-span-2 flex items-center gap-2 mt-1">
              <button type="button" id="drug-batch-toggle" class="text-[11px] px-2 py-1 rounded bg-slate-600 hover:bg-slate-500 border border-slate-500">Batch Details</button>
              <span class="text-[11px] text-slate-400">Provide batch metadata when adding initial stock.</span>
            </div>
            <div id="drug-batch-extra" class="md:col-span-2 grid gap-3 md:grid-cols-2 hidden bg-slate-700/30 p-3 rounded border border-slate-600/60">
              <input name="batch_no" placeholder="Batch No *" class="border border-slate-600 rounded px-3 py-2 bg-slate-800 placeholder-slate-400 text-slate-100" />
              <input name="isbn" placeholder="ISBN" class="border border-slate-600 rounded px-3 py-2 bg-slate-800 placeholder-slate-400 text-slate-100" />
              <input name="producer" placeholder="Producer" class="border border-slate-600 rounded px-3 py-2 bg-slate-800 placeholder-slate-400 text-slate-100" />
              <input name="transporter" placeholder="Transporter" class="border border-slate-600 rounded px-3 py-2 bg-slate-800 placeholder-slate-400 text-slate-100" />
              <label class="flex flex-col gap-1 text-[11px]">Mfg Date <input type="date" name="mfg_date" class="border border-slate-600 rounded px-2 py-1 bg-slate-800 text-slate-100" /></label>
              <label class="flex flex-col gap-1 text-[11px]">Exp Date <input type="date" name="exp_date" class="border border-slate-600 rounded px-2 py-1 bg-slate-800 text-slate-100" /></label>
              <textarea name="batch_notes" rows="2" placeholder="Batch Notes" class="md:col-span-2 border border-slate-600 rounded px-3 py-2 bg-slate-800 placeholder-slate-400 text-slate-100 resize-y"></textarea>
              <div class="md:col-span-2 text-[10px] text-slate-400">If you enter an Initial Stock value, batch details are required (at least Batch No). Stock will be added via batch record.</div>
            </div>
            <div class="md:col-span-2 flex items-center gap-3">
              <button class="bg-indigo-600 hover:bg-indigo-500 text-white rounded px-4 py-2 font-medium disabled:opacity-50 flex items-center gap-2" id="drug-submit"><span>Add Drug</span><span class="hidden spinner" id="drug-spinner"></span></button>
              <p class="text-xs text-red-500" id="drug-error"></p>
            </div>
          </form>
          <ul id="drug-list" class="text-xs space-y-1 max-h-40 overflow-auto divide-y divide-slate-700/60"></ul>
        </details>
        <div class="grid gap-6 lg:grid-cols-3 items-start">
          <!-- Left side: controls, table, pagination, modals triggers (spans 2 columns) -->
          <div class="flex flex-col gap-3 lg:col-span-2">
          <div class="flex flex-wrap items-center gap-2 text-[11px]">
            <input id="inv-search" placeholder="Search by name / dosage / id" class="px-3 py-1.5 rounded bg-slate-700/70 border border-slate-600 flex-1 focus:outline-none focus:ring-2 focus:ring-indigo-600" />
            <label class="flex items-center gap-1 select-none px-2 py-1 rounded bg-slate-700/60 border border-slate-600 cursor-pointer">
              <input type="checkbox" id="inv-low-toggle" class="accent-indigo-500">
              <span>Low only</span>
            </label>
            <select id="inv-pagesize" class="bg-slate-700 border border-slate-600 rounded px-2 py-1">
              <option>10</option><option selected>25</option><option>50</option><option>100</option>
            </select>
          </div>
          <div class="overflow-auto soft-scroll border border-slate-700 rounded-lg relative" id="inv-table-wrap">
            <table class="w-full text-[12px]" id="inv-table">
              <thead class="bg-slate-900/70 backdrop-blur sticky top-0 text-slate-300 select-none">
                <tr>
                  <th data-sort="id" class="px-3 py-2 text-left cursor-pointer">ID</th>
                  <th data-sort="name" class="px-3 py-2 text-left cursor-pointer">Name</th>
                  <th data-sort="dosage" class="px-3 py-2 text-left cursor-pointer">Dosage</th>
                  <th data-sort="stock" class="px-3 py-2 text-left cursor-pointer">Stock</th>
                  <th data-sort="reorder_level" class="px-3 py-2 text-left cursor-pointer">Reorder</th>
                  <th data-sort="pending_quantity" class="px-3 py-2 text-left cursor-pointer">Pend Qty</th>
                  <th data-sort="daily_avg" class="px-3 py-2 text-left cursor-pointer">Daily Avg</th>
                  <th data-sort="days_supply" class="px-3 py-2 text-left cursor-pointer">Days Supply</th>
                  <th class="px-3 py-2 text-left">Status</th>
                  <th class="px-3 py-2 text-right">Actions</th>
                </tr>
              </thead>
              <tbody id="inv-body" class="divide-y divide-slate-700/60"></tbody>
            </table>
            <div id="inv-empty" class="text-center text-[11px] text-slate-500 py-6 hidden">No drugs</div>
          </div>
          <div class="flex items-center justify-between text-[11px] text-slate-400" id="inv-pager-bar">
            <div id="inv-page-info"></div>
            <div class="flex items-center gap-1">
              <button id="inv-prev" class="px-2 py-1 rounded bg-slate-700 disabled:opacity-40">Prev</button>
              <button id="inv-next" class="px-2 py-1 rounded bg-slate-700 disabled:opacity-40">Next</button>
            </div>
          </div>
          </div>
          <!-- Right side: Transactions panel -->
          <aside class="space-y-4">
            <div class="bg-slate-900/40 border border-slate-700 rounded-lg p-4 flex flex-col h-full max-h-[640px]">
              <div class="flex items-center justify-between mb-2">
                <h3 class="text-sm font-medium">Transactions</h3>
                <div class="flex items-center gap-2">
                  <select id="inv-trx-filter" class="text-[11px] bg-slate-700 border border-slate-600 rounded px-2 py-1">
                    <option value="">All</option>
                    <option value="reserve">Reserve</option>
                    <option value="re-reserve">Re-Reserve</option>
                    <option value="cancel">Cancel</option>
                    <option value="delete">Delete</option>
                    <option value="manual">Manual</option>
                  </select>
                  <button id="inv-trx-refresh" class="text-[11px] px-2 py-1 rounded bg-slate-700 hover:bg-slate-600">↻</button>
                </div>
              </div>
              <div class="overflow-auto soft-scroll border border-slate-700/70 rounded-md flex-1" id="inv-trx-wrap">
                <ul id="inv-trx" class="text-[11px] divide-y divide-slate-700/60"></ul>
                <div id="inv-trx-empty" class="text-center text-[11px] text-slate-500 py-4 hidden">No transactions</div>
              </div>
            </div>
          </aside>
        </div>
        <!-- Adjustment Modal -->
        <div id="inv-adjust-modal" class="hidden fixed inset-0 z-40 items-center justify-center bg-slate-900/70 backdrop-blur-sm">
          <div class="w-full max-w-sm bg-slate-800 border border-slate-700 rounded-xl p-5 flex flex-col gap-4">
            <div class="flex items-center justify-between"><h3 class="font-semibold text-sm" id="inv-adjust-title">Adjust Stock</h3><button id="inv-adjust-close" class="text-slate-400 hover:text-slate-200">&times;</button></div>
            <form id="inv-adjust-form" class="flex flex-col gap-3 text-xs">
              <div class="flex flex-col gap-1"><label for="inv-adjust-name" class="text-slate-400">Drug</label><input id="inv-adjust-name" class="px-2 py-1 rounded bg-slate-700 border border-slate-600" disabled></div>
              <div class="grid grid-cols-2 gap-3">
                <div class="flex flex-col gap-1"><label for="inv-adjust-current" class="text-slate-400">Current Stock</label><input id="inv-adjust-current" class="px-2 py-1 rounded bg-slate-700 border border-slate-600" disabled></div>
                <div class="flex flex-col gap-1"><label for="inv-adjust-reorder" class="text-slate-400">Reorder Level</label><input id="inv-adjust-reorder" class="px-2 py-1 rounded bg-slate-700 border border-slate-600" disabled></div>
              </div>
              <div class="flex flex-col gap-1"><label for="inv-adjust-delta" class="text-slate-400">Delta (+/-)</label><input id="inv-adjust-delta" type="number" class="px-2 py-1 rounded bg-slate-700 border border-slate-600" required placeholder="e.g. 25 or -10"></div>
              <div class="flex flex-col gap-1"><label for="inv-adjust-reason" class="text-slate-400">Reason</label><input id="inv-adjust-reason" class="px-2 py-1 rounded bg-slate-700 border border-slate-600" placeholder="manual"></div>
              <div class="flex items-center justify-between -mb-1">
                <button type="button" id="inv-adjust-batch-toggle" class="text-[10px] px-2 py-1 rounded bg-slate-600 hover:bg-slate-500 border border-slate-500">Batch Details</button>
                <span class="text-[10px] text-slate-500">Provide metadata for additions</span>
              </div>
              <div id="inv-adjust-batch-extra" class="hidden flex flex-col gap-2 border border-slate-600/60 rounded p-3 bg-slate-700/30">
                <div class="text-[10px] text-slate-400 -mt-1">Batch details required when increasing stock.</div>
                <div class="grid grid-cols-2 gap-2">
                  <input id="inv-adjust-batch_no" placeholder="Batch No *" class="px-2 py-1 rounded bg-slate-800 border border-slate-600 text-[11px]" />
                  <input id="inv-adjust-isbn" placeholder="ISBN" class="px-2 py-1 rounded bg-slate-800 border border-slate-600 text-[11px]" />
                  <input id="inv-adjust-producer" placeholder="Producer" class="px-2 py-1 rounded bg-slate-800 border border-slate-600 text-[11px]" />
                  <input id="inv-adjust-transporter" placeholder="Transporter" class="px-2 py-1 rounded bg-slate-800 border border-slate-600 text-[11px]" />
                  <label class="flex flex-col gap-1 text-[10px]">Mfg<input type="date" id="inv-adjust-mfg_date" class="px-2 py-1 rounded bg-slate-800 border border-slate-600 text-[11px]"></label>
                  <label class="flex flex-col gap-1 text-[10px]">Exp<input type="date" id="inv-adjust-exp_date" class="px-2 py-1 rounded bg-slate-800 border border-slate-600 text-[11px]"></label>
                  <textarea id="inv-adjust-notes" rows="2" placeholder="Batch Notes" class="col-span-2 px-2 py-1 rounded bg-slate-800 border border-slate-600 text-[11px] resize-y"></textarea>
                </div>
              </div>
              <div class="flex items-center justify-end gap-2 pt-2">
                <button type="button" id="inv-adjust-cancel" class="text-[11px] px-3 py-1.5 rounded bg-slate-600 hover:bg-slate-500">Cancel</button>
                <button type="submit" class="text-[11px] px-3 py-1.5 rounded bg-indigo-600 hover:bg-indigo-500 text-white flex items-center gap-2"><span>Apply</span><span class="spinner hidden" id="inv-adjust-spin"></span></button>
              </div>
              <div id="inv-adjust-error" class="text-[11px] text-rose-400"></div>
            </form>
          </div>
        </div>
        <!-- Add Batch Modal -->
        <div id="inv-batch-modal" class="hidden fixed inset-0 z-40 items-start justify-center pt-16 bg-slate-900/70 backdrop-blur-sm">
          <div class="w-full max-w-lg bg-slate-800 border border-slate-700 rounded-xl p-5 flex flex-col gap-4 max-h-[80vh]">
            <div class="flex items-center justify-between"><h3 class="font-semibold text-sm" id="inv-batch-title">Add Drug Batch</h3><button id="inv-batch-close" class="text-slate-400 hover:text-slate-200">&times;</button></div>
            <form id="inv-batch-form" class="grid gap-3 text-xs md:grid-cols-2 overflow-auto pr-1">
              <input type="hidden" id="inv-batch-drug-id" />
              <div class="md:col-span-2 flex flex-col gap-1"><label class="text-slate-400 text-[11px]">Drug</label><input id="inv-batch-drug-name" disabled class="px-2 py-1 rounded bg-slate-700 border border-slate-600" /></div>
              <div class="flex flex-col gap-1"><label class="text-slate-400 text-[11px]">Batch No</label><input id="inv-batch-batch_no" placeholder="Batch code" class="px-2 py-1 rounded bg-slate-700 border border-slate-600" /></div>
              <div class="flex flex-col gap-1"><label class="text-slate-400 text-[11px]">ISBN</label><input id="inv-batch-isbn" placeholder="ISBN" class="px-2 py-1 rounded bg-slate-700 border border-slate-600" /></div>
              <div class="flex flex-col gap-1"><label class="text-slate-400 text-[11px]">Producer</label><input id="inv-batch-producer" placeholder="Producer" class="px-2 py-1 rounded bg-slate-700 border border-slate-600" /></div>
              <div class="flex flex-col gap-1"><label class="text-slate-400 text-[11px]">Transporter</label><input id="inv-batch-transporter" placeholder="Transporter" class="px-2 py-1 rounded bg-slate-700 border border-slate-600" /></div>
              <div class="flex flex-col gap-1"><label class="text-slate-400 text-[11px]">Mfg Date</label><input type="date" id="inv-batch-mfg_date" class="px-2 py-1 rounded bg-slate-700 border border-slate-600" /></div>
              <div class="flex flex-col gap-1"><label class="text-slate-400 text-[11px]">Exp Date</label><input type="date" id="inv-batch-exp_date" class="px-2 py-1 rounded bg-slate-700 border border-slate-600" /></div>
              <div class="flex flex-col gap-1"><label class="text-slate-400 text-[11px]">Quantity <span class="text-rose-400">*</span></label><input type="number" id="inv-batch-quantity" min="1" required placeholder="e.g. 100" class="px-2 py-1 rounded bg-slate-700 border border-slate-600" /></div>
              <div class="md:col-span-2 flex flex-col gap-1"><label class="text-slate-400 text-[11px]">Notes</label><textarea id="inv-batch-notes" rows="2" class="px-2 py-1 rounded bg-slate-700 border border-slate-600 resize-y" placeholder="Optional notes"></textarea></div>
              <div class="md:col-span-2 flex items-center justify-end gap-2 pt-1">
                <button type="button" id="inv-batch-cancel" class="px-3 py-1.5 rounded bg-slate-600 hover:bg-slate-500 text-[11px]">Cancel</button>
                <button type="submit" class="px-3 py-1.5 rounded bg-indigo-600 hover:bg-indigo-500 text-white text-[11px] flex items-center gap-2"><span>Save Batch</span><span class="spinner hidden" id="inv-batch-spin"></span></button>
              </div>
              <div id="inv-batch-error" class="md:col-span-2 text-[11px] text-rose-400"></div>
              <div class="md:col-span-2 grid grid-cols-2 gap-4 border-t border-slate-700 pt-3 mt-1">
                <div class="flex flex-col gap-1 text-[11px]"><span class="uppercase tracking-wide text-slate-400">Recent Batches</span><ul id="inv-batch-recent" class="space-y-1 max-h-32 overflow-auto"></ul></div>
                <div class="flex flex-col gap-1 text-[11px]"><span class="uppercase tracking-wide text-slate-400">Recent Removals</span><ul id="inv-batch-removals" class="space-y-1 max-h-32 overflow-auto"></ul></div>
              </div>
            </form>
          </div>
        </div>
        <!-- Remove Stock Modal -->
        <div id="inv-remove-modal" class="hidden fixed inset-0 z-40 items-start justify-center pt-24 bg-slate-900/70 backdrop-blur-sm">
          <div class="w-full max-w-md bg-slate-800 border border-slate-700 rounded-xl p-5 flex flex-col gap-4 max-h-[70vh]">
            <div class="flex items-center justify-between"><h3 class="font-semibold text-sm" id="inv-remove-title">Remove Stock</h3><button id="inv-remove-close" class="text-slate-400 hover:text-slate-200">&times;</button></div>
            <form id="inv-remove-form" class="flex flex-col gap-3 text-xs overflow-auto pr-1">
              <input type="hidden" id="inv-remove-drug-id" />
              <div class="flex flex-col gap-1"><label class="text-slate-400 text-[11px]">Drug</label><input id="inv-remove-drug-name" disabled class="px-2 py-1 rounded bg-slate-700 border border-slate-600" /></div>
              <div class="flex flex-col gap-1"><label class="text-slate-400 text-[11px]">Batch No (optional)</label><input id="inv-remove-batch_no" placeholder="Batch reference" class="px-2 py-1 rounded bg-slate-700 border border-slate-600" /></div>
              <div class="flex flex-col gap-1"><label class="text-slate-400 text-[11px]">Quantity <span class="text-rose-400">*</span></label><input type="number" id="inv-remove-quantity" min="1" required placeholder="e.g. 5" class="px-2 py-1 rounded bg-slate-700 border border-slate-600" /></div>
              <div class="flex flex-col gap-1"><label class="text-slate-400 text-[11px]">Reason <span class="text-rose-400">*</span></label><input id="inv-remove-reason" placeholder="expired / damaged / return" class="px-2 py-1 rounded bg-slate-700 border border-slate-600" required /></div>
              <div class="flex flex-col gap-1"><label class="text-slate-400 text-[11px]">Notes</label><textarea id="inv-remove-notes" rows="2" class="px-2 py-1 rounded bg-slate-700 border border-slate-600 resize-y" placeholder="Optional notes"></textarea></div>
              <div class="flex items-center justify-end gap-2 pt-1">
                <button type="button" id="inv-remove-cancel" class="px-3 py-1.5 rounded bg-slate-600 hover:bg-slate-500 text-[11px]">Cancel</button>
                <button type="submit" class="px-3 py-1.5 rounded bg-rose-600 hover:bg-rose-500 text-white text-[11px] flex items-center gap-2"><span>Remove</span><span class="spinner hidden" id="inv-remove-spin"></span></button>
              </div>
              <div id="inv-remove-error" class="text-[11px] text-rose-400"></div>
              <div class="grid grid-cols-2 gap-4 border-t border-slate-700 pt-3">
                <div class="flex flex-col gap-1 text-[11px]"><span class="uppercase tracking-wide text-slate-400">Recent Batches</span><ul id="inv-remove-recent-batches" class="space-y-1 max-h-32 overflow-auto"></ul></div>
                <div class="flex flex-col gap-1 text-[11px]"><span class="uppercase tracking-wide text-slate-400">Recent Removals</span><ul id="inv-remove-recent-removals" class="space-y-1 max-h-32 overflow-auto"></ul></div>
              </div>
            </form>
          </div>
        </div>
      </section>

      <footer class="text-center text-xs text-slate-400 py-8">&copy; 2025 Friendly Med Pal 2.0</footer>
    </div>

    <!-- Patient Detail Modal -->
    <div id="patient-modal" class="hidden fixed inset-0 z-50 items-start justify-center pt-20 px-4 bg-slate-900/70 backdrop-blur-sm">
      <div class="w-full max-w-lg bg-slate-800 border border-slate-700 rounded-lg shadow-xl flex flex-col max-h-[80vh]">
        <div class="flex items-center gap-2 px-4 py-3 border-b border-slate-700">
          <h3 id="pm-title" class="font-semibold text-sm flex-1">Patient</h3>
          <button id="pm-close" class="text-slate-400 hover:text-slate-200 text-lg leading-none">&times;</button>
        </div>
        <div id="pm-body" class="p-4 space-y-4 overflow-auto text-xs"></div>
      </div>
    </div>

    <template id="tpl-stat">
  <div class="bg-slate-800 border border-slate-700 rounded-lg p-4 shadow flex flex-col gap-1">
        <span class="text-[10px] uppercase tracking-wide text-slate-400" data-part="label"></span>
        <span class="text-2xl font-semibold" data-part="value"></span>
      </div>
    </template>

    <div id="toast-wrap" class="fixed top-4 right-4 z-50 space-y-2 w-64"></div>
    <div id="loading-overlay" class="hidden fixed inset-0 bg-slate-900/30 backdrop-blur-sm flex items-center justify-center z-40">
      <div class="bg-white px-6 py-4 rounded shadow flex items-center gap-3 text-sm"><span class="spinner !w-6 !h-6 !border-4 !border-slate-300 !border-t-indigo-600"></span> <span id="loading-text">Working...</span></div>
    </div>

    <script>
      // Global early flags (avoid temporal dead zone in later handlers)
      let inventoryBooted = false;
      // Adaptive API base detection
      let API_BASE = localStorage.getItem('apiBase') || 'http://127.0.0.1:8000';
      async function probe(url){
        const r= await fetch(url+'/api/health',{method:'GET'}).catch(()=>null);
        return !!(r && r.ok);
      }
      async function detectAPIBase(){
        const overrideParam=new URLSearchParams(location.search).get('api');
        if(overrideParam){ API_BASE=overrideParam; localStorage.setItem('apiBase', API_BASE); updateAPIIndicator('override '+API_BASE,'pending'); }
        const candidates=[];
        const origins=new Set();
        if(location.protocol.startsWith('http')) origins.add(location.origin);
        ['127.0.0.1','localhost'].forEach(h=>{ [8000,5000].forEach(p=> origins.add('http://'+h+':'+p)); });
        for(const o of origins) candidates.push(o);
        for(const c of candidates){ updateAPIIndicator('trying '+c,'pending'); if(await probe(c)){ API_BASE=c; localStorage.setItem('apiBase', API_BASE); updateAPIIndicator('connected '+API_BASE,'ok'); return; } }
        updateAPIIndicator('unreachable','error');
      }
  function updateAPIIndicator(text, state){
          const span=document.getElementById('api-indicator');
          const dot=document.getElementById('api-dot');
          if(!span||!dot) return;
          if(text){ span.lastChild.textContent=' '+text; }
          let cls='w-2 h-2 rounded-full ';
          if(state==='ok') cls+='bg-green-500';
          else if(state==='error') cls+='bg-red-500 animate-pulse';
          else cls+='bg-slate-300 animate-pulse';
          dot.className=cls;
  }

      let globalLoading = 0;
      function setLoading(on, label='Working...'){
        globalLoading += on?1:-1; if(globalLoading<0) globalLoading=0;
        const ov = document.getElementById('loading-overlay');
        const txt = document.getElementById('loading-text');
        if(label) txt.textContent = label;
        if(globalLoading>0) ov.classList.remove('hidden'); else ov.classList.add('hidden');
      }
      function toast(msg, type='info'){
        const wrap=document.getElementById('toast-wrap');
        const el=document.createElement('div');
        el.className='fade-enter bg-white dark:bg-slate-800 border text-slate-700 dark:text-slate-200 text-xs px-3 py-2 rounded shadow flex items-start gap-2';
        const colors={info:'border-slate-200 dark:border-slate-700', success:'border-emerald-300 dark:border-emerald-600', error:'border-red-300 dark:border-red-600'};
        el.className += ' '+(colors[type]||colors.info);
        el.innerHTML=`<span>${msg}</span><button class='ml-auto text-slate-400 hover:text-slate-600 dark:hover:text-slate-300'>&times;</button>`;
        el.querySelector('button').onclick=()=>{el.remove();};
        wrap.append(el);
        requestAnimationFrame(()=>{el.classList.add('fade-enter-active');});
        setTimeout(()=>{el.classList.remove('fade-enter-active'); el.style.opacity='0'; setTimeout(()=>el.remove(),250);}, 4000);
      }
      function savePref(key,val){ try{ localStorage.setItem(key, String(val)); }catch{} }
      function loadPref(key,def){ try{ const v=localStorage.getItem(key); return v!==null?v:def; }catch{ return def; } }
      function loadPrefs(){
        // Load settings into form fields
        try {
          const refreshInput = document.getElementById('set-refresh');
          const activityDisplayInput = document.getElementById('set-activity-display');
          const activityStoreInput = document.getElementById('set-activity-store');
          
          if(refreshInput) refreshInput.value = loadPref('refreshInterval', '10');
          if(activityDisplayInput) activityDisplayInput.value = loadPref('activityDisplayLimit', '50');
          if(activityStoreInput) activityStoreInput.value = loadPref('activityStoreLimit', '200');
        } catch(e) {
          console.error('Failed to load preferences:', e);
        }
      }
      function loadSettings(){
        // Alias for loadPrefs for consistency with refresh button text
        loadPrefs();
      }

      // Theme handling
      function applyTheme(t){
        const body=document.body; if(!body) return;
  // add cross-fade helper class (removed after animation)
  body.classList.add('theme-xfade-enter');
        if(t==='light'){ body.classList.add('theme-light'); body.classList.remove('theme-dark'); }
        else { body.classList.add('theme-dark'); body.classList.remove('theme-light'); }
        const btn=document.getElementById('theme-toggle');
        if(btn){
          btn.setAttribute('aria-checked', String(t==='light'));
          btn.dataset.mode = t;
          const ico = btn.querySelector('[data-icon]');
          if(ico) ico.textContent = t==='light' ? '🌙' : '☀️';
        }
  // remove helper class after transition finishes
  clearTimeout(window.__themeXFadeTimer);
  window.__themeXFadeTimer = setTimeout(()=> body.classList.remove('theme-xfade-enter'), 650);
      }
      const storedTheme= loadPref('theme','dark');
      applyTheme(storedTheme);
      document.addEventListener('click', e=>{
        const tEl = e.target && (e.target.id==='theme-toggle' ? e.target : e.target.closest && e.target.closest('#theme-toggle'));
        if(tEl){
          const cur= loadPref('theme','dark');
          const next = cur==='dark'? 'light':'dark';
          savePref('theme', next);
          applyTheme(next);
        }
      });

      // Settings form handler
      document.getElementById('settings-form')?.addEventListener('submit', e => {
        e.preventDefault();
        try {
          let refreshInterval = document.getElementById('set-refresh').value;
          const activityDisplayLimit = document.getElementById('set-activity-display').value;
          const activityStoreLimit = document.getElementById('set-activity-store').value;
          
          savePref('refreshInterval', refreshInterval);
          savePref('activityDisplayLimit', activityDisplayLimit);
          savePref('activityStoreLimit', activityStoreLimit);
          
          // Update runtime variables
          ACTIVITY_DISPLAY_LIMIT = Number(activityDisplayLimit) || 50;
          ACTIVITY_STORE_LIMIT = Number(activityStoreLimit) || 200;
          refreshInterval = Number(refreshInterval) || 10; // normalize
          // Update the in-memory interval used by auto-refresh loop if defined
          if(typeof window !== 'undefined' && typeof window.refreshInterval !== 'undefined') {
            window.refreshInterval = refreshInterval;
          }
          
          document.getElementById('settings-status').textContent = 'Settings saved!';
          toast('Settings saved successfully', 'success');
          setTimeout(() => {
            document.getElementById('settings-status').textContent = '';
          }, 3000);
        } catch(e) {
          console.error('Failed to save settings:', e);
          toast('Failed to save settings', 'error');
        }
      });

      function renderAlerts(){
        // Simple alerts implementation - shows low stock items
        const alertList = document.getElementById('alert-list');
        const alertCount = document.getElementById('alert-count');
        if(!alertList || !alertCount) return;
        
        const drugs = window.__drugs || [];
        const lowStockDrugs = drugs.filter(d => (d.stock || 0) <= (d.reorder_level || 0));
        
        if(lowStockDrugs.length){
          const plural = lowStockDrugs.length === 1 ? '' : 's';
          alertCount.textContent = `${lowStockDrugs.length} alert${plural}`;
        } else {
          alertCount.textContent = '';
        }
        
        if(lowStockDrugs.length === 0) {
          alertList.innerHTML = '<div class="text-slate-400 text-center py-4">No alerts</div>';
          return;
        }
        
        alertList.innerHTML = lowStockDrugs.map(drug => 
          `<div class="flex items-center justify-between p-2 rounded bg-red-600/20 border border-red-600/30 text-red-300">
            <div class="flex-1">
              <div class="font-medium">${escapeHTML(drug.name)}</div>
              <div class="text-[10px] text-red-400">Stock: ${drug.stock || 0} / Reorder level: ${drug.reorder_level || 0}</div>
            </div>
            <div class="text-[10px] bg-red-600/40 px-2 py-1 rounded">LOW STOCK</div>
          </div>`
        ).join('');
      }

      async function call(path, opts={}) {
        const url = (path.startsWith('http')? path : API_BASE + path);
        const controller = new AbortController();
        const t=setTimeout(()=> controller.abort(), 8000);
        let res; const started=Date.now();
        try {
          res = await fetch(url, {headers:{'Content-Type':'application/json'}, signal:controller.signal, ...opts});
        } catch(e){
          updateAPIIndicator('network error','error');
          console.error('[call] network error', {path, url, error:e});
          throw new Error('Network error while calling '+path+': '+e.message);
        } finally { clearTimeout(t); }
        if(!res.ok){
          let msg;
          try { msg = (await res.json()).detail || await res.text(); } catch { msg = res.statusText; }
          console.error('[call] http error', {path, url, status:res.status, message:msg});
          throw new Error('HTTP '+res.status+' '+msg+' ['+path+']');
        }
        updateAPIIndicator('', 'ok');
        if(res.status===204) return null;
        const ct = res.headers.get('content-type')||'';
        if(!ct.includes('application/json')){
          try { const txt= await res.text(); console.warn('[call] non-json response', {path, url, time:Date.now()-started}); return txt; } catch { return null; }
        }
        try { const json= await res.json(); return json; }
        catch(e){ console.error('[call] json parse error', {path, url, error:e}); throw new Error('Invalid JSON from '+path+': '+e.message); }
       }

      function stat(label, value){
        const node = document.getElementById('tpl-stat').content.cloneNode(true);
        node.querySelector('[data-part=label]').textContent = label;
        node.querySelector('[data-part=value]').textContent = value;
        return node;
      }

      async function loadStats(){
        try {
          const data= await call('/api/stats');
          const elP=document.querySelector('[data-count="patients"]'); if(elP) elP.textContent=data.patients;
          const elD=document.querySelector('[data-count="drugs"]'); if(elD) elD.textContent=data.drugs;
          const elDel=document.querySelector('[data-count="deliveries"]'); if(elDel) elDel.textContent=data.deliveries;
          // (nav utilities & low stock badge removed)
          const statsBox=document.getElementById('stats');
          statsBox.innerHTML='';
          const items=[
            {label:'Patients', value:data.patients},
            {label:'Drugs', value:data.drugs},
            {label:'Deliveries', value:data.deliveries},
            {label:'Low Stock', value:data.low_stock_drugs}
          ];
          items.forEach(it=>{ const card=document.createElement('div'); card.className='rounded-xl p-4 flex flex-col gap-1 card-hover bg-slate-800/70 border border-slate-700'; card.innerHTML=`<span class="text-[11px] uppercase tracking-wide text-slate-400">${it.label}</span><span class="text-xl font-semibold">${it.value}</span>`; statsBox.append(card); });
          // low stock list
          const lowWrap=document.getElementById('low-stock-dash');
          const list=document.getElementById('low-stock-list');
          if(data.low_stock_list && data.low_stock_list.length){
            lowWrap.classList.remove('hidden');
            list.innerHTML = data.low_stock_list.slice(0,8).map(r=> `<li class='flex justify-between'><span class='truncate max-w-[140px]'>${escapeHTML(r.name)}</span><span class='text-rose-300 ml-2 font-mono'>${r.stock}/${r.reorder_level}</span></li>`).join('');
          } else { lowWrap.classList.add('hidden'); }
        } catch(e){ console.error('stats', e); }
      }

      function renderStatusDistribution(breakdown){
        const total = Object.values(breakdown).reduce((a,b)=>a+b,0);
        const box = document.getElementById('status-distribution');
        const bars = document.getElementById('dist-bars');
        if(!total){ box.classList.add('hidden'); return; }
        box.classList.remove('hidden');
        document.getElementById('dist-total').textContent = total + ' total';
        const order=['pending','delivered','missed','cancelled'];
        const color={pending:'bg-amber-500', delivered:'bg-emerald-500', missed:'bg-red-500', cancelled:'bg-slate-500'};
        bars.innerHTML='';
        order.filter(k=>breakdown[k]).forEach(k=>{
          const count = breakdown[k];
          const pct = ((count/total)*100).toFixed(1);
          const row=document.createElement('div');
          row.innerHTML=`<div class='flex justify-between text-[11px] mb-1'><span class='flex items-center gap-2'><span class='inline-block w-2 h-2 rounded-full ${color[k]||'bg-slate-500'}'></span>${k}</span><span>${count} • ${pct}%</span></div><div class='h-2 w-full rounded bg-slate-700 overflow-hidden'><div class='h-full ${color[k]||'bg-slate-500'}' style='width:${pct}%' aria-label='${k} ${pct}%'></div></div>`;
          bars.append(row);
        });
        drawDonutChart(breakdown, total);
        // Inject adherence metric (delivered / (delivered+missed+cancelled))
        try {
          const denom=(breakdown.delivered||0)+(breakdown.missed||0)+(breakdown.cancelled||0);
          if(denom){
            const adherence=((breakdown.delivered||0)/denom*100).toFixed(1)+'%';
            const title=box.querySelector('h3');
            if(title){
              let badge=title.querySelector('.adherence-badge');
              if(!badge){
                badge=document.createElement('span');
                badge.className='adherence-badge ml-2 text-[10px] px-1.5 py-0.5 rounded bg-indigo-600/30 text-indigo-300 border border-indigo-600/40';
                title.append(badge);
              }
              badge.textContent='Adherence '+adherence;
            }
          }
        } catch{}
      }

      function drawDonutChart(breakdown,total){
        const cv=document.getElementById('dist-chart'); if(!cv){ return; } const ctx=cv.getContext('2d'); const segments=['pending','delivered','missed','cancelled'].filter(s=>breakdown[s]); if(!segments.length){ ctx.clearRect(0,0,cv.width,cv.height); return; }
        const colors={pending:'#f59e0b',delivered:'#10b981',missed:'#ef4444',cancelled:'#64748b'}; let start= -Math.PI/2; ctx.clearRect(0,0,cv.width,cv.height); const r=Math.min(cv.width,cv.height)/2; const cx=cv.width/2, cy=cv.height/2; segments.forEach(s=>{ const val=breakdown[s]; const angle=(val/total)*Math.PI*2; ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,r,start,start+angle); ctx.closePath(); ctx.fillStyle=colors[s]; ctx.fill(); start+=angle; }); ctx.globalCompositeOperation='destination-out'; ctx.beginPath(); ctx.arc(cx,cy,r*0.55,0,Math.PI*2); ctx.fill(); ctx.globalCompositeOperation='source-over'; }

      function drawLineChart(canvasId, points){
        const cv=document.getElementById(canvasId); if(!cv){ return; }
        const ctx=cv.getContext('2d'); const w=cv.width=cv.clientWidth; const h=cv.height=cv.clientHeight;
        ctx.clearRect(0,0,w,h);
        if(!points.length){ ctx.fillStyle='#64748b'; ctx.font='12px sans-serif'; ctx.fillText('No data',8,16); return; }
  const ys=points.map(p=>p.y);
  const maxY=Math.max(...ys,1);
        // grid
        ctx.strokeStyle='#1e293b'; ctx.lineWidth=1; for(let i=0;i<=4;i++){ const y=h-(i/4)*h; ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke(); }
        // line
        ctx.strokeStyle='#6366f1'; ctx.lineWidth=2; ctx.beginPath(); points.forEach((p,i)=>{ const px=(i/(points.length-1))*w; const py= h - (p.y/maxY)*h; if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py); }); ctx.stroke();
        // area
        ctx.fillStyle='rgba(99,102,241,0.15)'; ctx.lineTo(w,h); ctx.lineTo(0,h); ctx.closePath(); ctx.fill();
        // points
        ctx.fillStyle='#6366f1'; points.forEach((p,i)=>{ const px=(i/(points.length-1))*w; const py= h - (p.y/maxY)*h; ctx.beginPath(); ctx.arc(px,py,3,0,Math.PI*2); ctx.fill(); });
      }

      let activityStore=[];
      let ACTIVITY_DISPLAY_LIMIT = Number(loadPref('activityDisplayLimit',50));
      let ACTIVITY_STORE_LIMIT = Number(loadPref('activityStoreLimit',200));
      function persistActivity(){ try{ localStorage.setItem('activityLog', JSON.stringify(activityStore.slice(0,200))); }catch{} }
      function loadActivity(){
        try { activityStore=JSON.parse(localStorage.getItem('activityLog')||'[]'); }catch{ activityStore=[]; }
        const list=document.getElementById('activity-log'); const empty=document.getElementById('activity-empty');
        list.innerHTML='';
        if(!activityStore.length){ empty.classList.remove('hidden'); return; }
        empty.classList.add('hidden');
        activityStore.forEach(a=>{
          const li=document.createElement('li'); li.className='py-1 flex items-center justify-between gap-2';
            li.innerHTML=`<span class='mt-0.5 w-1.5 h-1.5 rounded-full bg-indigo-500'></span><div class='flex-1'><div class='font-medium'>${a.action}</div><div class='text-[10px] text-slate-500'>${a.time}${a.meta? ' • '+a.meta:''}</div></div>`;
          list.append(li);
        });
      }
      function logActivity(action, meta=''){
  const list=document.getElementById('activity-log'); const empty=document.getElementById('activity-empty'); if(!list){ return; }
  if(empty){ empty.classList.add('hidden'); }
  const time=new Date().toLocaleTimeString();
  const li=document.createElement('li'); li.className='flex items-start gap-2';
  li.innerHTML=`<span class='mt-0.5 w-1.5 h-1.5 rounded-full bg-indigo-500'></span><div class='flex-1'><div class='font-medium'>${action}</div><div class='text-[10px] text-slate-500'>${time}${meta? ' • '+meta:''}</div></div>`;
  list.prepend(li);
        activityStore.unshift({action,time,meta});
        while(activityStore.length>ACTIVITY_STORE_LIMIT){ activityStore.pop(); }
        persistActivity();
        while(list.children.length>ACTIVITY_DISPLAY_LIMIT){ list.lastChild.remove(); }
      }
  function renderActivity(){
    const list=document.getElementById('activity-log'); const empty=document.getElementById('activity-empty');
    if(!list||!empty) return;
    list.innerHTML='';
    if(!activityStore.length){ empty.classList.remove('hidden'); return; }
    empty.classList.add('hidden');
    activityStore.slice(0, ACTIVITY_DISPLAY_LIMIT).forEach(a=>{
      const li=document.createElement('li'); li.className='py-1 flex items-center justify-between gap-2';
      li.innerHTML=`<span class='mt-0.5 w-1.5 h-1.5 rounded-full bg-indigo-500'></span><div class='flex-1'><div class='font-medium'>${a.action}</div><div class='text-[10px] text-slate-500'>${a.time}${a.meta? ' • '+a.meta:''}</div></div>`;
      list.append(li);
    });
  }
  document.addEventListener('click', e=>{ if(e.target && e.target.id==='clear-activity'){ const list=document.getElementById('activity-log'); if(list){ list.innerHTML=''; } activityStore=[]; persistActivity(); const empty=document.getElementById('activity-empty'); if(empty){ empty.classList.remove('hidden'); } }});

      function escapeHTML(str){ return str.replace(/[&<>"]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"})); }
      function confirmAction(msg){ return window.confirm(msg); }

      async function refreshPatients(){
        console.debug('[refreshPatients] start', {API_BASE});
        let pts=[];
        try {
          pts = await call('/api/patients');
        } catch(e){
          console.error('[refreshPatients] failed', e);
          toast('Failed loading patients: '+ e.message, 'error');
          return;
        }
        window.__patients = pts;
        const list = document.getElementById('patient-list');
        list.innerHTML='';
        const listEl=document.getElementById('patient-picker-list'); const empty=document.getElementById('patient-picker-empty'); const searchInput=document.getElementById('patient-picker-search');
        if(listEl){
          listEl.innerHTML='';
          const term=(searchInput? searchInput.value.toLowerCase(): '');
          let rows=filterPatients();
          if(term){ rows=rows.filter(p=> p.name.toLowerCase().includes(term) || String(p.id)===term); }
          if(!rows.length){ empty.classList.remove('hidden'); } else { empty.classList.add('hidden'); }
          rows.forEach(p=>{
            const li=document.createElement('li');
            let cond=''; if(p.condition){ cond="<span class=\"text-[9px] px-1 rounded bg-indigo-600/30\">"+escapeHTML(p.condition)+"</span>"; }
            li.innerHTML="<button type='button' data-pick-patient='"+p.id+"' class='w-full text-left px-2 py-1 rounded hover:bg-slate-700 flex items-center gap-2'><span class='text-[10px] px-1 py-0.5 rounded bg-slate-700 border border-slate-600'>#"+p.id+"</span><span class='flex-1 truncate'>"+escapeHTML(p.name)+"</span>"+cond+"</button>";
            listEl.append(li);
          });
        }
        filterPatients().forEach(p=>{
          const li=document.createElement('li');
          li.className='py-1 flex items-center justify-between gap-2';
          li.innerHTML = `<span class='truncate'>${p.id}. <strong>${escapeHTML(p.name)}</strong>${p.age? ' ('+p.age+')':''} ${p.condition?'<span class="ml-1 text-[10px] px-1 py-0.5 rounded bg-slate-100 dark:bg-slate-700">'+escapeHTML(p.condition)+'</span>':''}</span>`;
          const actions=document.createElement('div');
          actions.className='flex gap-1';
          const details=document.createElement('button'); details.className='px-2 py-0.5 text-[10px] rounded bg-indigo-600/70 hover:bg-indigo-600'; details.textContent='Details'; details.onclick=()=> openPatientModal(p.id);
          const edit=document.createElement('button'); edit.className='px-2 py-0.5 text-[10px] rounded bg-slate-700 hover:bg-slate-600'; edit.textContent='Edit';
          edit.onclick=async()=>{
            const name=prompt('Name', p.name); if(name===null) return;
            const age=prompt('Age', p.age||''); if(age===null) return;
            const condition=prompt('Condition', p.condition||''); if(condition===null) return;
            try {
              await call(`/api/patients/${p.id}`, {method:'PATCH', body: JSON.stringify({name, age: age?Number(age):null, condition})});
              toast('Patient updated','success');
              refreshPatients();
            } catch(e){
              console.error('Patient update failed', e);
              toast('Update failed','error');
            }
          };
          const del=document.createElement('button'); del.className='px-2 py-0.5 text-[10px] rounded bg-red-600/80 hover:bg-red-600'; del.textContent='Del';
          del.onclick=async()=>{
            if(!confirmAction('Delete patient and related deliveries?')) { return; }
            try {
              await call(`/api/patients/${p.id}`, {method:'DELETE'});
              toast('Patient deleted','success');
              refreshPatients();
              refreshDeliveries();
              loadStats();
            } catch(e){
              console.error('Patient delete failed', e);
              toast('Delete failed','error');
            }
          };
          actions.append(details, edit, del); li.append(actions); list.append(li);
        });
      }
  // Minimal render helpers (avoid refresh errors if referenced)
  function renderPatients(){ /* list already rebuilt inside refreshPatients; provided for delegated refresh safety */ }

  function renderDrugs(){ /* drug list rebuilt inside refreshDrugs */ }

  function renderDeliveries(){ /* deliveries list rebuilt inside refreshDeliveries */ }

  // Provide no-op stubs for legacy overview renderers (in case still referenced)
  if(typeof window.renderAllPatients !== 'function') { window.renderAllPatients = function(){}; }
  if(typeof window.renderAllDeliveries !== 'function') { window.renderAllDeliveries = function(){}; }

      async function refreshDrugs(){
        console.debug('[refreshDrugs] start', {API_BASE});
        let drugs=[];
        try {
          drugs = await call('/api/drugs');
        } catch(e){
          console.error('[refreshDrugs] failed', e);
          toast('Failed loading drugs: '+ e.message, 'error');
          return;
        }
        window.__drugs = drugs;
        const list = document.getElementById('drug-list');
        list.innerHTML='';
        const dList=document.getElementById('drug-picker-list'); const dEmpty=document.getElementById('drug-picker-empty'); const dSearch=document.getElementById('drug-picker-search');
        if(dList){
          dList.innerHTML='';
          let rows=filterDrugs();
          const term=(dSearch? dSearch.value.toLowerCase(): '');
            if(term){ rows=rows.filter(d=> d.name.toLowerCase().includes(term) || String(d.id)===term); }
          if(!rows.length){ dEmpty.classList.remove('hidden'); } else { dEmpty.classList.add('hidden'); }
          rows.forEach(d=>{
            const li=document.createElement('li');
            const low=(d.stock??0) <= (d.reorder_level??0);
            let dosage=''; if(d.dosage){ dosage="<span class=\"text-[9px] px-1 rounded bg-slate-600/50\">"+escapeHTML(d.dosage)+"</span>"; }
            const stockBadgeClass= low? 'bg-red-600/30 text-red-300':'bg-slate-600/40 text-slate-300';
            li.innerHTML="<button type='button' data-pick-drug='"+d.id+"' class='w-full text-left px-2 py-1 rounded hover:bg-slate-700 flex items-center gap-2'><span class='text-[10px] px-1 py-0.5 rounded bg-slate-700 border border-slate-600'>#"+d.id+"</span><span class='flex-1 truncate'>"+escapeHTML(d.name)+"</span>"+dosage+"<span class='text-[9px] px-1 rounded "+stockBadgeClass+"'>"+(d.stock??0)+"</span></button>";
            dList.append(li);
          });
        }
        filterDrugs().forEach(d=>{
          const li=document.createElement('li');
            li.className='py-1 flex items-center justify-between gap-2';
            li.innerHTML = `<span class='truncate'>${d.id}. <strong>${escapeHTML(d.name)}</strong>${d.dosage? ' <span class="text-[10px] px-1 py-0.5 rounded bg-indigo-100 dark:bg-indigo-600/30">'+escapeHTML(d.dosage)+'</span>':''}
              <span class="ml-1 text-[10px] px-1 py-0.5 rounded ${(d.stock??0) <= (d.reorder_level??0) ? 'bg-red-600/30 text-red-300' : 'bg-slate-600/40 text-slate-300'}">stk:${d.stock??0}</span>
              <span class="ml-1 text-[10px] px-1 py-0.5 rounded bg-slate-700/60 text-slate-300">rl:${d.reorder_level??0}</span></span>`;
          const actions=document.createElement('div'); actions.className='flex gap-1';
          const edit=document.createElement('button'); edit.className='px-2 py-0.5 text-[10px] rounded bg-slate-700 hover:bg-slate-600'; edit.textContent='Edit';
          edit.onclick=async()=>{
            const name=prompt('Name', d.name); if(name===null) return;
            const dosage=prompt('Dosage', d.dosage||''); if(dosage===null) return;
            const stockStr=prompt('Stock', d.stock??'0'); if(stockStr===null) return;
            const reorderStr=prompt('Reorder level', d.reorder_level??'0'); if(reorderStr===null) return;
            try { await call(`/api/drugs/${d.id}`, {method:'PATCH', body: JSON.stringify({name, dosage, stock:Number(stockStr)||0, reorder_level:Number(reorderStr)||0})}); toast('Drug updated','success'); refreshDrugs(); renderAlerts(); }
            catch(e){ console.error('Drug update failed', e); toast('Update failed','error'); }
          };
          const del=document.createElement('button'); del.className='px-2 py-0.5 text-[10px] rounded bg-red-600/80 hover:bg-red-600'; del.textContent='Del';
          del.onclick=async()=>{ if(!confirmAction('Delete drug and related deliveries?')) { return; } try { await call(`/api/drugs/${d.id}`, {method:'DELETE'}); toast('Drug deleted','success'); refreshDrugs(); refreshDeliveries(); loadStats(); } catch(e){ console.error('Drug delete failed', e); toast('Delete failed','error'); } };
          actions.append(edit, del); li.append(actions); list.append(li);
        });
      }

      function statusBadge(status){
        const colors={pending:'bg-amber-100 text-amber-700 dark:bg-amber-500/20 dark:text-amber-300', delivered:'bg-emerald-100 text-emerald-700 dark:bg-emerald-500/20 dark:text-emerald-300', missed:'bg-red-100 text-red-700 dark:bg-red-500/20 dark:text-red-300', cancelled:'bg-slate-200 text-slate-700 dark:bg-slate-600/40 dark:text-slate-300'};
        return `<span class="px-2 py-0.5 rounded text-[10px] font-medium ${colors[status]||'bg-slate-200'}">${status}</span>`;
      }
      let deliveryStatusFilter='';
      function buildDeliveryStatusFilters(){
        const container=document.getElementById('delivery-status-filters');
  if(!container){ return; }
  container.innerHTML='';
        ['all','pending','delivered','missed','cancelled'].forEach(st=>{
          const btn=document.createElement('button');
          const active = (st==='all' && !deliveryStatusFilter) || deliveryStatusFilter===st;
          btn.className='px-2 py-1 rounded border text-[11px] '+(active?'bg-indigo-600 border-indigo-600 text-white':'border-slate-600 hover:bg-slate-700');
          btn.textContent=st;
          btn.onclick=()=>{ deliveryStatusFilter = (st==='all')?'':st; buildDeliveryStatusFilters(); refreshDeliveries(); };
          container.append(btn);
        });
      }
      let overdueOnly=false;
      async function refreshDeliveries(){
        const deliveries = await call('/api/deliveries');
        window.__deliveries = deliveries;
        const wrap = document.getElementById('deliveries');
        wrap.innerHTML='';
        const now=Date.now();
        const filteredAll = deliveryStatusFilter? deliveries.filter(d=>d.status===deliveryStatusFilter): deliveries;
        const filtered = overdueOnly? filteredAll.filter(d=> d.status==='pending' && new Date(d.scheduled_for).getTime() < now): filteredAll;
        filtered.forEach(d=>{
          const row = document.createElement('div');
          row.className='group border rounded p-2 flex flex-col gap-2 hover:shadow transition bg-white dark:bg-slate-900/40 border-slate-200 dark:border-slate-700';
          const top = document.createElement('div');
          top.className='flex flex-wrap items-center justify-between gap-2';
          const overdue = d.status==='pending' && new Date(d.scheduled_for).getTime() < now;
          if(overdue){ row.classList.add('border-red-500','animate-pulse'); }
          top.innerHTML = `<span class='font-medium'>#${d.id} ${statusBadge(d.status)}${overdue? ' <span class="ml-1 px-1.5 py-0.5 rounded bg-red-600/20 text-red-400 text-[10px]">overdue</span>':''}</span><span class='text-[11px] text-slate-500 dark:text-slate-400'>P${d.patient_id} • D${d.drug_id} • ${d.scheduled_for}</span>`;
          const actions = document.createElement('div');
          actions.className='flex flex-wrap';
          ['pending','delivered','missed','cancelled'].forEach(st=>{
            const b=document.createElement('button');
            b.textContent=st;
            b.className='text-[10px] px-2 py-1 rounded border mr-1 mb-1 '+(d.status===st?'bg-indigo-600 border-indigo-600 text-white':'border-slate-300 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-700');
            b.onclick=async()=>{ await call(`/api/deliveries/${d.id}/status`, {method:'PATCH', body: JSON.stringify({status: st})}); toast('Status updated','success'); refreshDeliveries(); loadStats(); };
            actions.append(b);
          });
          const del=document.createElement('button'); del.textContent='Delete'; del.className='text-[10px] px-2 py-1 rounded border mb-1 bg-red-600/80 hover:bg-red-600 border-red-700 text-white';
          del.onclick=async()=>{
            if(!confirmAction('Delete this delivery?')) { return; }
            try {
              await call(`/api/deliveries/${d.id}`, {method:'DELETE'});
              toast('Delivery deleted','success');
              refreshDeliveries();
              loadStats();
            } catch(e){
              console.error('Delete delivery failed', e);
              toast('Delete failed','error');
            }
          };
          actions.append(del);
          const notes = document.createElement('div');
          notes.className='hidden text-[11px] text-slate-600 dark:text-slate-400 pl-1';
          notes.textContent = d.notes? 'Notes: '+d.notes : 'No notes';
          row.onclick=(e)=>{ if(e.target.tagName==='BUTTON'){ return; } notes.classList.toggle('hidden'); };
          row.append(top, actions, notes);
          wrap.append(row);
        });
        renderHistory();
        // Recompute distribution if we have raw list and no stats endpoint breakdown (fallback)
        try { renderStatusDistribution(deliveries.reduce((a,d)=>{a[d.status]=(a[d.status]||0)+1; return a;},{})); } catch {}
      }

      // Patient form submit (single binding guarded by __bound flag)
      const patientForm=document.getElementById('patient-form');
      if(patientForm && !patientForm.__bound){
        patientForm.__bound=true;
        patientForm.addEventListener('submit', async e=>{
          e.preventDefault();
          const fd=new FormData(patientForm);
          const body=Object.fromEntries(fd.entries());
          const btn=document.getElementById('patient-submit'); const sp=document.getElementById('patient-spinner'); const err=document.getElementById('patient-error');
          err.textContent=''; btn.disabled=true; sp.classList.remove('hidden');
          try { await call('/api/patients', {method:'POST', body: JSON.stringify(body)}); patientForm.reset(); toast('Patient added','success'); refreshPatients(); loadStats(); }
          catch(ex){ err.textContent=ex.message; toast('Add patient failed','error'); }
          finally { btn.disabled=false; sp.classList.add('hidden'); }
        });
      }

      document.getElementById('drug-form').addEventListener('submit', async e=>{
        e.preventDefault();
        const fd = new FormData(e.target);
        const raw = Object.fromEntries(fd.entries());
        const initialStock = parseInt(raw.stock||'0',10)||0;
        const btn=document.getElementById('drug-submit'); const sp=document.getElementById('drug-spinner'); const err=document.getElementById('drug-error');
        err.textContent=''; btn.disabled=true; sp.classList.remove('hidden');
        try {
          // Always create drug with zero stock if user provided stock so batch metadata can capture it
            let createPayload={...raw};
            if(initialStock>0){ createPayload.stock=0; }
            const created = await call('/api/drugs', {method:'POST', body: JSON.stringify(createPayload)});
            toast('Drug added','success');
            await refreshDrugs(); loadStats();
            if(typeof inventoryBooted !== 'undefined' && inventoryBooted && typeof loadInventoryData==='function'){
              try { await loadInventoryData(); } catch{}
            }
            // If user intended to set starting stock, open batch modal prefilled to collect batch details
            if(initialStock>0 && created && created.id){
              // If inline batch section visible and has batch_no, create batch directly without modal
              const inlineBatchVisible = !document.getElementById('drug-batch-extra').classList.contains('hidden');
              const batchNo = raw.batch_no && raw.batch_no.trim();
              if(!inlineBatchVisible && !batchNo){
                // Force user to provide batch metadata instead of silent modal; auto open inline section
                document.getElementById('drug-batch-extra').classList.remove('hidden');
                err.textContent='Batch No required when starting stock > 0';
                return; // keep form populated
              }
              if(inlineBatchVisible && !batchNo){
                err.textContent='Batch No required when starting stock > 0';
                return;
              }
              if(inlineBatchVisible && batchNo){
                // validate dates
                if(raw.mfg_date && raw.exp_date && raw.exp_date < raw.mfg_date){ throw new Error('Expiry before manufacturing'); }
                await call('/api/drug_batches',{method:'POST', body: JSON.stringify({drug_id: created.id, batch_no: batchNo, isbn: raw.isbn||null, producer: raw.producer||null, transporter: raw.transporter||null, mfg_date: raw.mfg_date||null, exp_date: raw.exp_date||null, quantity: initialStock, notes: raw.batch_notes||null})});
                toast('Initial batch recorded','success');
                await loadInventoryData(); fetchInventoryTransactions();
                e.target.reset();
              } else {
                // Fallback to modal approach
                openBatchModal(created.id, created);
                const qtyEl=document.getElementById('inv-batch-quantity'); if(qtyEl){ qtyEl.value=String(initialStock); }
                const notesEl=document.getElementById('inv-batch-notes'); if(notesEl){ notesEl.placeholder='Notes (optional)'; }
              }
            } else {
              e.target.reset();
            }
        } catch(ex){
          console.error(ex); err.textContent=ex.message||'Failed'; toast('Add drug failed','error');
        } finally {
          btn.disabled=false; sp.classList.add('hidden');
        }
      });
      // Toggle inline batch details
      const batchToggle=document.getElementById('drug-batch-toggle');
      if(batchToggle){ batchToggle.addEventListener('click', ()=>{ const box=document.getElementById('drug-batch-extra'); box.classList.toggle('hidden'); }); }

      document.getElementById('delivery-form').addEventListener('submit', async e=>{
        e.preventDefault();
        const fd = new FormData(e.target);
        const body = Object.fromEntries(fd.entries());
        const btn=document.getElementById('delivery-submit'); const sp=document.getElementById('delivery-spinner'); const err=document.getElementById('delivery-error');
        err.textContent=''; btn.disabled=true; sp.classList.remove('hidden');
        try {
          // Client-side stock validation (pre-flight)
          const qty = Number(body.quantity)||1;
          const drugId = Number(body.drug_id);
          const drug = (window.__drugs||[]).find(d=> d.id==drugId);
          if(!drug){ throw new Error('Select a drug'); }
          if((drug.stock||0) < qty){ throw new Error(`Insufficient stock (have ${drug.stock||0})`); }
          await call('/api/deliveries', {method:'POST', body: JSON.stringify(body)});
          e.target.reset();
          toast('Delivery scheduled','success');
          await Promise.all([refreshDeliveries(), refreshDrugs()]);
          loadStats();
          // Refresh insights to update adherence ratios / recommendations
          try { fetchInsights(); fetchInsightsSummary(); } catch{}
          if(typeof inventoryBooted !== 'undefined' && inventoryBooted && typeof loadInventoryData==='function'){
            try { await loadInventoryData(); } catch{}
          }
        }
        catch(ex){ err.textContent=ex.message; toast('Schedule failed','error'); }
        finally { btn.disabled=false; sp.classList.add('hidden'); }
      });

    async function checkAPI(){
        const dot = document.getElementById('api-dot');
        try {
          await call('/api/health');
          dot.className='w-2 h-2 rounded-full bg-green-500';
          document.getElementById('api-indicator').lastChild.textContent='';
        } catch {
          dot.className='w-2 h-2 rounded-full bg-red-500 animate-pulse';
        }
      }

  function filterPatients(){
    const el=document.getElementById('patient-filter') || document.getElementById('all-patients-search');
    const term=(el && el.value ? el.value : '').toLowerCase();
    if(!window.__patients){ return []; }
    if(!term) return window.__patients.slice();
    return window.__patients.filter(p=> p.name.toLowerCase().includes(term) || (p.condition||'').toLowerCase().includes(term));
  }
  function filterDrugs(){ const term=(document.getElementById('drug-filter').value||'').toLowerCase(); if(!window.__drugs){ return []; } return window.__drugs.filter(d=> d.name.toLowerCase().includes(term) || (d.dosage||'').toLowerCase().includes(term)); }
  const pfEl=document.getElementById('patient-filter'); if(pfEl){ pfEl.addEventListener('input', ()=> refreshPatients()); }
    document.getElementById('drug-filter').addEventListener('input', ()=> refreshDrugs());
    const themeBtn=document.getElementById('theme-toggle');
  // Dark theme removed; placeholder functions retained for other prefs.
    let countdown = 10; const cdEl=document.getElementById('refresh-countdown'); const auto=document.getElementById('auto-refresh');
  let refreshInterval = Number(loadPref('refreshInterval',10));
  setInterval(()=>{ if(!auto.checked){ cdEl.textContent=''; return; } countdown--; if(countdown<=0){ countdown=refreshInterval; refreshDeliveries(); loadStats(); renderAnalytics && renderAnalytics(); renderAlerts(); renderCalendar(); } cdEl.textContent='Refresh in '+countdown+'s'; },1000);

    // --- Enhanced Analytics Implementation ---
    function renderAnalytics(){
      const deliveries=(window.__deliveries||[]).slice();
      const daysSel= parseInt(document.getElementById('analytics-range-select')?.value||'14',10);
      const now = new Date();
      const from = new Date(now.getTime() - daysSel*24*60*60*1000);
      const rangeEl=document.getElementById('analytics-range');
      if(rangeEl){ rangeEl.textContent=`(${from.toLocaleDateString()} - ${now.toLocaleDateString()})`; }
      const inRange=deliveries.filter(d=> d.scheduled_for && new Date(d.scheduled_for) >= from);
      // Daily aggregation
      const dayMap=new Map();
      inRange.forEach(d=>{
        if(!d.scheduled_for){ return; }
        const key=d.scheduled_for.slice(0,10);
        const o=dayMap.get(key)||{pending:0,delivered:0,missed:0,cancelled:0,total:0};
        o[d.status]=(o[d.status]||0)+1; o.total++; dayMap.set(key,o);
      });
      const days=[...Array(daysSel).keys()].map(i=>{ const dt=new Date(from.getTime()+ i*24*60*60*1000); return dt.toISOString().slice(0,10); });
      // Metrics
      const total=inRange.length;
      const delivered=inRange.filter(d=> d.status==='delivered').length;
      const missed=inRange.filter(d=> d.status==='missed').length;
      const onTimeRate = delivered? Math.round(delivered/total*100):0;
      const missRate = total? Math.round(missed/total*100):0;
      const todayKey=new Date().toISOString().slice(0,10);
      const todayCount=(dayMap.get(todayKey)||{}).total||0;
      const prevDayKey=new Date(Date.now()-24*60*60*1000).toISOString().slice(0,10);
      const prevDayCount=(dayMap.get(prevDayKey)||{}).total||0;
      const dayChange = prevDayCount? (((todayCount-prevDayCount)/prevDayCount)*100).toFixed(1):'0.0';
      const metrics=[
        {label:'Total Deliveries', value: total},
        {label:'Delivered %', value: onTimeRate+'%'},
        {label:'Missed %', value: missRate+'%'},
        {label:'Today vs Prev', value: (dayChange>=0?'+':'')+dayChange+'%'},
      ];
      const mWrap=document.getElementById('analytics-metrics');
      if(mWrap){ mWrap.innerHTML=''; metrics.forEach(m=>{ const div=document.createElement('div'); div.className='bg-slate-900/40 border border-slate-700 rounded p-3 flex flex-col gap-1'; div.innerHTML=`<span class="text-[10px] uppercase tracking-wide text-slate-400">${m.label}</span><span class="text-xl font-semibold">${m.value}</span>`; mWrap.append(div); }); }
      // Daily line chart
      const line=document.getElementById('daily-line');
      if(line){ const ctx=line.getContext('2d'); ctx.clearRect(0,0,line.width,line.height); const vals=days.map(d=> (dayMap.get(d)||{}).total||0); const max=Math.max(5, ...vals); const pad=20; ctx.strokeStyle='#334155'; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(pad, line.height-pad); ctx.lineTo(line.width-pad, line.height-pad); ctx.stroke(); // axis
        // line path
        ctx.strokeStyle='#6366f1'; ctx.lineWidth=2; ctx.beginPath(); vals.forEach((v,i)=>{ const x=pad + (i/(vals.length-1 || 1))*(line.width-2*pad); const y=line.height-pad - (v/max)*(line.height-2*pad); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); }); ctx.stroke();
        // fill
        const grad=ctx.createLinearGradient(0,0,0,line.height); grad.addColorStop(0,'rgba(99,102,241,0.35)'); grad.addColorStop(1,'rgba(99,102,241,0)'); ctx.fillStyle=grad; ctx.beginPath(); vals.forEach((v,i)=>{ const x=pad + (i/(vals.length-1||1))*(line.width-2*pad); const y=line.height-pad - (v/max)*(line.height-2*pad); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); }); ctx.lineTo(line.width-pad,line.height-pad); ctx.lineTo(pad,line.height-pad); ctx.closePath(); ctx.fill();
        ctx.fillStyle='#94a3b8'; ctx.font='9px sans-serif'; const step=Math.ceil(vals.length/6); for(let i=0;i<vals.length;i+=step){ const x=pad + (i/(vals.length-1||1))*(line.width-2*pad); ctx.fillText(days[i].slice(5), x-10, line.height-6); } }
      // Status mix list & bar chart
      const statusAgg=inRange.reduce((a,d)=>{a[d.status]=(a[d.status]||0)+1; return a;},{});
      const sWrap=document.getElementById('analytics-status');
      if(sWrap){
        sWrap.innerHTML='';
        Object.entries(statusAgg).sort((a,b)=>b[1]-a[1]).forEach(([k,v])=>{
          const pct= total? Math.round(v/total*100):0;
          let colorClass='bg-amber-500';
          if(k==='delivered') colorClass='bg-emerald-500';
          else if(k==='missed') colorClass='bg-red-500';
          else if(k==='cancelled') colorClass='bg-slate-500';
          const row=document.createElement('div');
          row.className='flex items-center gap-2';
            row.innerHTML=`<span class='w-20 capitalize'>${k}</span><div class='flex-1 h-2 bg-slate-700 rounded overflow-hidden'><div style='width:${pct}%' class='h-2 ${colorClass}'></div></div><span class='w-10 text-right'>${pct}%</span>`;
          sWrap.append(row);
        });
      }
      const bars=document.getElementById('status-bars');
      if(bars){
        const ctx=bars.getContext('2d');
        ctx.clearRect(0,0,bars.width,bars.height);
        const keys=['delivered','pending','missed','cancelled'];
        const vals=keys.map(k=> statusAgg[k]||0);
        const max=Math.max(5,...vals);
        const bw= (bars.width-40)/keys.length;
        keys.forEach((k,i)=>{
          const v=vals[i];
          const h=((v/max)||0)*(bars.height-30);
          const x=20 + i*bw;
          const y=bars.height-10-h;
          let fill='#f59e0b';
          if(k==='delivered') fill='#10b981'; else if(k==='missed') fill='#ef4444'; else if(k==='cancelled') fill='#64748b';
          ctx.fillStyle=fill; ctx.fillRect(x+8,y,bw-16,h);
          ctx.fillStyle='#94a3b8'; ctx.font='9px sans-serif'; ctx.fillText(String(v), x+8, y-4);
          ctx.save(); ctx.translate(x+ (bw/2), bars.height-2); ctx.rotate(-Math.PI/3); ctx.fillText(k, -10,0); ctx.restore();
        });
      }
      // Top patients & drugs
      const tPatients=document.getElementById('top-patients'); if(tPatients){ const patientCounts={}; inRange.forEach(d=>{ patientCounts[d.patient_id]=(patientCounts[d.patient_id]||0)+1; }); const top=Object.entries(patientCounts).sort((a,b)=>b[1]-a[1]).slice(0,10); tPatients.innerHTML=''; top.forEach(([pid,c])=>{ const patient=(window.__patients||[]).find(p=> p.id==pid); const li=document.createElement('li'); li.textContent=`${patient?patient.name:'Patient '+pid} – ${c}`; tPatients.append(li); }); }
      const tDrugs=document.getElementById('top-drugs'); if(tDrugs){ const drugQty={}; inRange.forEach(d=>{ drugQty[d.drug_id]=(drugQty[d.drug_id]||0)+ (d.quantity||1); }); const topD=Object.entries(drugQty).sort((a,b)=>b[1]-a[1]).slice(0,10); tDrugs.innerHTML=''; topD.forEach(([did,c])=>{ const drug=(window.__drugs||[]).find(dr=> dr.id==did); const li=document.createElement('li'); li.textContent=`${drug?drug.name:'Drug '+did} – ${c}`; tDrugs.append(li); }); }
    }
    
    // Alias for buildAnalytics to handle both function names
    function buildAnalytics(){
      renderAnalytics();
    }

    // --- Calendar Implementation (added) ---
    const calendarState = { month: new Date(), selected: null };
    function startOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
    function endOfMonth(d){ return new Date(d.getFullYear(), d.getMonth()+1, 0); }
    function fmtDate(d){ return d.toISOString().slice(0,10); }
    function renderCalendar(){
      const grid=document.getElementById('cal-grid'); if(!grid) return;
      const title=document.getElementById('cal-title');
      const month=startOfMonth(calendarState.month);
      const end=endOfMonth(calendarState.month);
      const firstWeekday=(month.getDay()+6)%7; // make Monday=0
      const days=[];
      for(let i=0;i<firstWeekday;i++){ days.push(null); }
      for(let day=1; day<=end.getDate(); day++){ days.push(new Date(month.getFullYear(), month.getMonth(), day)); }
      while(days.length%7!==0) days.push(null);
      title.querySelector && (title.querySelector('span[data-cal-range]') || (function(){ const sp=document.createElement('span'); sp.dataset.calRange='1'; sp.className='text-xs font-normal text-slate-400'; title.appendChild(sp); })());
      const label = month.toLocaleString(undefined,{month:'long', year:'numeric'});
      // deliveries grouped by date
      const deliveries=(window.__deliveries||[]).slice();
      const byDate=new Map();
      deliveries.forEach(d=>{
        if(!d.scheduled_for) return;
        const key=d.scheduled_for.slice(0,10);
        if(!byDate.has(key)) byDate.set(key, []);
        byDate.get(key).push(d);
      });
      grid.innerHTML=days.map(d=>{
        if(!d) return `<div class='h-20 rounded bg-slate-900/40 border border-slate-800'></div>`;
        const key=fmtDate(d);
        const list=byDate.get(key)||[];
        let statusCount={pending:0, delivered:0, missed:0, cancelled:0};
        list.forEach(x=>{ statusCount[x.status]=(statusCount[x.status]||0)+1; });
        let badge='';
        if(list.length){
          const parts = Object.entries(statusCount)
            .filter(([k,v])=>v)
            .map(([k,v])=>{
              let color='text-slate-400';
              if(k==='pending') color='text-amber-300';
              else if(k==='delivered') color='text-emerald-300';
              else if(k==='missed') color='text-rose-300';
              return `<span class='px-1 rounded bg-slate-700 ${color}'>${k[0]}:${v}</span>`;
            });
          badge = `<div class='mt-1 flex flex-wrap gap-0.5 text-[9px]'>${parts.join('')}</div>`;
        }
        const todayKey=fmtDate(new Date());
        const isToday= key===todayKey;
        const sel= calendarState.selected && fmtDate(calendarState.selected)===key;
        return `<button data-cal-day='${key}' class='h-20 w-full flex flex-col items-start text-left p-1 rounded border ${sel? 'border-indigo-500 bg-indigo-500/10': 'border-slate-700'} ${isToday?'ring-1 ring-indigo-400':''} hover:border-indigo-400 focus:outline-none focus:ring-1 focus:ring-indigo-400'>
          <span class='text-[11px] font-medium ${list.length? 'text-white':'text-slate-300'}'>${d.getDate()}</span>
          <span class='mt-auto text-[9px] text-slate-500'>${list.length||''}</span>
          ${badge}
        </button>`;
      }).join('');
      // Selected day list
      updateCalendarDayList();
      // Month label update
      const rangeSpan=title.querySelector('[data-cal-range]'); if(rangeSpan){ rangeSpan.textContent='\u00A0'+label; }
    }
    function updateCalendarDayList(){
      const listEl=document.getElementById('cal-day-list'); if(!listEl) return;
      if(!calendarState.selected){ listEl.innerHTML='<p class="text-slate-500">No day selected.</p>'; return; }
      const key=fmtDate(calendarState.selected);
      const items=(window.__deliveries||[]).filter(d=> d.scheduled_for && d.scheduled_for.slice(0,10)===key);
      if(!items.length){ listEl.innerHTML='<p class="text-slate-500">No deliveries.</p>'; return; }
      listEl.innerHTML=items.sort((a,b)=> a.scheduled_for.localeCompare(b.scheduled_for)).map(d=>`<div class='p-2 rounded bg-slate-900/50 border border-slate-700 flex justify-between gap-2'>
        <span class='truncate'>#${d.id} P${d.patient_id} D${d.drug_id}</span>
        <span class='text-[10px] uppercase tracking-wide'>${d.status}</span>
      </div>`).join('');
    }
    document.addEventListener('click', e=>{
      const dayBtn=e.target.closest && e.target.closest('[data-cal-day]');
      if(dayBtn){ calendarState.selected=new Date(dayBtn.getAttribute('data-cal-day')); renderCalendar(); }
      if(e.target.id==='cal-prev'){ calendarState.month=new Date(calendarState.month.getFullYear(), calendarState.month.getMonth()-1, 1); renderCalendar(); }
      if(e.target.id==='cal-next'){ calendarState.month=new Date(calendarState.month.getFullYear(), calendarState.month.getMonth()+1, 1); renderCalendar(); }
      if(e.target.id==='cal-today'){ calendarState.month=new Date(); calendarState.selected=new Date(); renderCalendar(); }
    });

    function renderHistory(){
      const list = document.getElementById('history-list'); if(!list) return;
      const deliveries = (window.__deliveries||[]).slice();
      const status = (document.getElementById('history-status').value||'').trim();
      const term = (document.getElementById('history-search').value||'').toLowerCase();
      const filtered = deliveries.filter(d=>{
        if(status && d.status!==status) return false;
        if(term){ const hay = `#${d.id} p${d.patient_id} d${d.drug_id} ${d.notes||''}`.toLowerCase(); if(!hay.includes(term)) return false; }
        return true;
      });
      document.getElementById('history-count').textContent = filtered.length+ ' / '+deliveries.length;
      list.innerHTML = filtered.map(d=>`<div class='py-2 flex flex-col gap-1'>
        <div class='flex justify-between'><span class='font-medium'>#${d.id}</span><span class='text-[10px] uppercase tracking-wide'>${d.status}</span></div>
        <div class='text-[10px] text-slate-500 dark:text-slate-400'>P${d.patient_id} • D${d.drug_id} • ${d.scheduled_for}</div>
        <div class='text-[10px] text-slate-600 dark:text-slate-300'>${d.notes? d.notes: '<em class="not-italic text-slate-400">no notes</em>'}</div>
      </div>`).join('');
    }
    document.getElementById('history-status').addEventListener('change', renderHistory);
    document.getElementById('history-search').addEventListener('input', renderHistory);
    document.getElementById('history-refresh').addEventListener('click', (e)=>{ e.preventDefault(); refreshDeliveries(); });

    // --- Overview table state (moved earlier to avoid TDZ in early tab activation) ---
    const overviewState={
      patients:{sortKey:'id',sortDir:'asc',page:1,pageSize:25,search:''},
      drugs:{sortKey:'id',sortDir:'asc',page:1,pageSize:25,search:''},
      deliveries:{sortKey:'id',sortDir:'asc',page:1,pageSize:25,search:'',dateFrom:'',dateTo:'',selected:new Set(),visibleCols:{patient:true,drug:true,scheduled_for:true,status:true,notes:true}}
    };
    function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; }
    function applySort(rows,key,dir){ return rows.sort((a,b)=>{ const av=a[key]??''; const bv=b[key]??''; if(av<bv) return dir==='asc'? -1:1; if(av>bv) return dir==='asc'? 1:-1; return 0; }); }
    function slicePage(rows,page,pageSize){ const start=(page-1)*pageSize; return rows.slice(start,start+pageSize); }
    function pager(total,page,pageSize,el,prefix,renderFn){ el.innerHTML=''; const pages=Math.max(1,Math.ceil(total/pageSize)); if(page>pages){ page=pages; } overviewState[prefix].page=page; if(pages<=1) return; const mk=(p,l)=>{ const b=document.createElement('button'); b.textContent=l; b.className='px-2 py-0.5 rounded border text-[10px] '+(p===page?'bg-indigo-600 border-indigo-600 text-white':'border-slate-600 hover:bg-slate-700'); b.onclick=()=>{ overviewState[prefix].page=p; renderFn(); }; return b; }; el.append(mk(Math.max(1,page-1),'‹')); for(let p=1;p<=pages && p<=6;p++){ if(p===6 && pages>6){ const more=document.createElement('span'); more.textContent='…'; more.className='px-1 text-slate-500'; el.append(more); el.append(mk(pages,pages)); break; } el.append(mk(p,p)); } el.append(mk(Math.min(pages,page+1),'›')); }
    function updateCounts(){ ['patients','drugs','deliveries'].forEach(k=>{ const span=document.querySelector(`[data-count=${k}]`); if(span){ const data=window['__'+k]||[]; span.textContent=data.length; } }); }
    function sortIndicator(th,active,dir){ th.querySelectorAll('.sort-ind').forEach(e=>e.remove()); const span=document.createElement('span'); span.className='sort-ind ml-1 opacity-60'; if(active){ span.textContent= dir==='asc'? '▲':'▼'; } th.append(span); }
  function renderAllPatients(){ const body=document.getElementById('all-patients-body'); if(!body) return; const empty=document.getElementById('all-patients-empty'); const info=document.getElementById('all-patients-info'); const pagerEl=document.getElementById('all-patients-pager'); const st=overviewState.patients; st.pageSize=Number(document.getElementById('all-patients-pagesize').value)||25; st.search=(document.getElementById('all-patients-search').value||'').toLowerCase(); let rows=(window.__patients||[]).filter(p=> !st.search || p.name.toLowerCase().includes(st.search) || (p.condition||'').toLowerCase().includes(st.search) || String(p.id)===st.search); rows=applySort(rows, st.sortKey, st.sortDir); const total=rows.length; rows=slicePage(rows, st.page, st.pageSize); body.innerHTML=rows.map(p=>`<tr class='hover:bg-slate-700/40 transition group'><td class='px-3 py-2 font-medium text-slate-300'>${p.id}</td><td class='px-3 py-2 flex items-center gap-2'>${escapeHTML(p.name)}<button data-patient-ai='${p.id}' title='AI summary' class='opacity-0 group-hover:opacity-100 transition text-[10px] px-1.5 py-0.5 rounded bg-indigo-600/20 text-indigo-300 border border-indigo-600/40 hover:bg-indigo-600/30'>AI</button></td><td class='px-3 py-2 text-slate-400'>${p.age??'—'}</td><td class='px-3 py-2 text-slate-400'>${p.condition? escapeHTML(p.condition):'—'}</td><td class='px-3 py-2 text-slate-400'>${p.contact? escapeHTML(p.contact):'—'}</td></tr>`).join(''); empty.textContent= total? '' : 'No patients found'; info.textContent= total? `Showing ${(st.page-1)*st.pageSize+1}-${Math.min(total, st.page*st.pageSize)} of ${total}` : ''; pager(total, st.page, st.pageSize, pagerEl, 'patients', renderAllPatients); updateCounts(); document.querySelectorAll('#tbl-all-patients thead th').forEach(th=> sortIndicator(th, th.dataset.sort===st.sortKey, st.sortDir)); }
    function renderAllDeliveries(){ const body=document.getElementById('all-deliveries-body'); if(!body) return; const empty=document.getElementById('all-deliveries-empty'); const info=document.getElementById('all-deliveries-info'); const pagerEl=document.getElementById('all-deliveries-pager'); const st=overviewState.deliveries; st.pageSize=Number(document.getElementById('all-deliveries-pagesize')?.value)||25; st.search=(document.getElementById('all-deliveries-search')?.value||'').toLowerCase(); st.dateFrom=document.getElementById('deliveries-date-from')?.value||''; st.dateTo=document.getElementById('deliveries-date-to')?.value||''; const patientMap=new Map((window.__patients||[]).map(p=>[p.id,p])); const drugMap=new Map((window.__drugs||[]).map(d=>[d.id,d])); let rows=(window.__deliveries||[]).map(d=> ({...d,_patient:patientMap.get(d.patient_id), _drug:drugMap.get(d.drug_id)})); if(st.search){ rows=rows.filter(d=> String(d.id)===st.search || d.status.toLowerCase().includes(st.search) || (d.notes||'').toLowerCase().includes(st.search) || (d._patient && d._patient.name.toLowerCase().includes(st.search)) || (d._drug && d._drug.name.toLowerCase().includes(st.search)) ); } if(st.dateFrom){ rows=rows.filter(r=> r.scheduled_for && r.scheduled_for.substring(0,10)>=st.dateFrom); } if(st.dateTo){ rows=rows.filter(r=> r.scheduled_for && r.scheduled_for.substring(0,10)<=st.dateTo); } rows=applySort(rows, st.sortKey, st.sortDir); const total=rows.length; rows=slicePage(rows, st.page, st.pageSize); body.innerHTML=rows.map(d=>{ const sel= st.selected.has(d.id); const when=d.scheduled_for? new Date(d.scheduled_for): null; let rel=''; if(when){ const diff= Date.now()- when.getTime(); const mins=Math.round(diff/60000); if(Math.abs(mins)<60){ rel=`${mins>0?mins+'m ago':'in '+(-mins)+'m'}`;} else { const hrs=Math.round(mins/60); if(Math.abs(hrs)<24){ rel=`${hrs>0?hrs+'h ago':'in '+(-hrs)+'h'}`;} else { const days=Math.round(hrs/24); rel=`${days>0?days+'d ago':'in '+(-days)+'d'}`; } } } return `<tr class='hover:bg-slate-700/40 transition ${sel?'bg-indigo-600/10':''}'>`+
      `<td class='px-3 py-2'><input type='checkbox' data-row-select='${d.id}' class='accent-indigo-500' ${sel?'checked':''} /></td>`+
      `<td class='px-3 py-2 font-medium text-slate-300'>${d.id}</td>`+
      `<td class='px-3 py-2 text-slate-400'>${d.quantity||1}</td>`+
      `<td class='px-3 py-2 text-slate-400'>${d._patient? escapeHTML(d._patient.name):'#'+d.patient_id}</td>`+
      `<td class='px-3 py-2 text-slate-400'>${d._drug? escapeHTML(d._drug.name):'#'+d.drug_id}</td>`+
      `<td class='px-3 py-2 text-slate-400 whitespace-nowrap'>${d.scheduled_for||'—'}${rel?`<div class='text-[10px] text-slate-500'>${rel}</div>`:''}</td>`+
      `<td class='px-3 py-2'>${statusBadge(d.status)}</td>`+
      `<td class='px-3 py-2 text-slate-400 max-w-[200px] truncate' title='${d.notes? escapeHTML(d.notes):''}'>${d.notes? escapeHTML(d.notes):'—'}</td>`+
      `</tr>`; }).join(''); empty.textContent= total? '' : 'No deliveries found'; const qtySum=rows.reduce((a,r)=> a+(r.quantity||1),0); info.textContent= total? `Showing ${(st.page-1)*st.pageSize+1}-${Math.min(total, st.page*st.pageSize)} of ${total} • Page Qty Total: ${qtySum}` : ''; pager(total, st.page, st.pageSize, pagerEl, 'deliveries', renderAllDeliveries); updateCounts(); document.querySelectorAll('#tbl-all-deliveries thead th').forEach(th=> sortIndicator(th, th.dataset.sort===st.sortKey, st.sortDir)); }
    // End moved overview block

    // Tabs
    const tabButtons = document.querySelectorAll('#main-nav .tab-btn');
    function activateTab(name){
      if(name==='all-patients') name='patients';
      document.querySelectorAll('[data-view]').forEach(v=>{
        const show = v.getAttribute('data-view')===name;
        v.classList.toggle('hidden', !show);
      });
      tabButtons.forEach(b=>{
        const active = b.getAttribute('data-tab')===name;
        b.classList.toggle('bg-indigo-600', active);
        b.classList.toggle('text-white', active);
        b.classList.toggle('shadow', active);
        if(!active){
          b.classList.add('border','border-slate-300','dark:border-slate-600');
        } else {
          b.classList.remove('border','border-slate-300','dark:border-slate-600');
        }
      });
      savePref('activeTab', name);
  // Indicator removed; simplified active state only
  if(name==='patients') renderAllPatients();
      // Smooth scroll to top of activated section (adjusting for sticky header/nav)
      const target = document.querySelector(`[data-view="${name}"]`);
      if(target){
  const header = document.querySelector('body > .max-w-6xl > header') || document.querySelector('header');
  const nav = document.getElementById('main-nav');
  const headerH = header ? header.getBoundingClientRect().height : 0;
  const navH = nav ? nav.getBoundingClientRect().height : 0;
  const gap = 12; // space below header
  const offset = headerH + navH + gap;
  const top = target.getBoundingClientRect().top + window.scrollY - offset;
  const behavior = window.matchMedia('(prefers-reduced-motion: reduce)').matches ? 'auto' : 'smooth';
  window.scrollTo({ top: top<0?0:top, behavior });
      }
    }
    // Tab button click handling (event delegation so later overrides of activateTab still apply)
    document.addEventListener('click', e=>{
      const btn = e.target.closest && e.target.closest('.tab-btn');
      if(btn && btn.hasAttribute('data-tab')){
        const tab = btn.getAttribute('data-tab');
        if(tab){ activateTab(tab); }
      }
    });
  // Debounced search & page size
  const debouncedOverviewSearch = debounce(()=>{ overviewState.patients.page=1; overviewState.drugs.page=1; overviewState.deliveries.page=1; renderAllPatients(); renderAllDeliveries(); },250);
  document.addEventListener('input', e=>{
        if(['all-patients-search','all-deliveries-search','deliveries-date-from','deliveries-date-to'].includes(e.target.id)){
          debouncedOverviewSearch();
        }
        if(['all-patients-pagesize','all-deliveries-pagesize'].includes(e.target.id)){
          overviewState.patients.page=1; overviewState.drugs.page=1; overviewState.deliveries.page=1; renderAllPatients(); renderAllDeliveries();
        }
        if(e.target.id==='activity-search'){
          const term=e.target.value.toLowerCase();
          const list=document.getElementById('activity-log');
          [...list.children].forEach(li=>{ const txt=li.textContent.toLowerCase(); li.classList.toggle('hidden', term && !txt.includes(term)); });
        }
      });
  // Sorting handlers
  document.addEventListener('click', e=>{
  const th=e.target.closest('#tbl-all-patients th[data-sort], #tbl-all-deliveries th[data-sort]');
        if(!th){ return; }
        const tableId=th.closest('table').id;
        let group;
        if(tableId==='tbl-all-patients'){ group='patients'; }
        else { group='deliveries'; }
        const key=th.dataset.sort;
        const st=overviewState[group];
        if(st.sortKey===key){ st.sortDir= st.sortDir==='asc' ? 'desc' : 'asc'; }
        else { st.sortKey=key; st.sortDir='asc'; }
        st.page=1;
  if(group==='patients'){ renderAllPatients(); }
  else { renderAllDeliveries(); }
      });
  const btnExpAllPatients = document.getElementById('export-all-patients');
  if(btnExpAllPatients) btnExpAllPatients.addEventListener('click', ()=>{ if(!window.__patients){ toast('No data','error'); return; } downloadFile('patients.csv', toCSV(window.__patients)); });
  const btnExpAllPatientsFiltered = document.getElementById('export-all-patients-filtered');
  if(btnExpAllPatientsFiltered) btnExpAllPatientsFiltered.addEventListener('click', ()=>{ const st=overviewState.patients; const term=st.search; const rows=(window.__patients||[]).filter(p=> !term || p.name.toLowerCase().includes(term) || (p.condition||'').toLowerCase().includes(term) || String(p.id)===term); downloadFile('patients_filtered.csv', toCSV(rows)); });
  const btnExpAllDrugs = document.getElementById('export-all-drugs');
  if(btnExpAllDrugs) btnExpAllDrugs.addEventListener('click', ()=>{ if(!window.__drugs){ toast('No data','error'); return; } downloadFile('drugs.csv', toCSV(window.__drugs)); });
  const btnExpAllDrugsFiltered = document.getElementById('export-all-drugs-filtered');
  if(btnExpAllDrugsFiltered) btnExpAllDrugsFiltered.addEventListener('click', ()=>{ const st=overviewState.drugs; const term=st.search; const rows=(window.__drugs||[]).filter(d=> !term || d.name.toLowerCase().includes(term) || (d.dosage||'').toLowerCase().includes(term) || String(d.id)===term); downloadFile('drugs_filtered.csv', toCSV(rows)); });
  const btnExpAllDeliveries = document.getElementById('export-all-deliveries');
  if(btnExpAllDeliveries) btnExpAllDeliveries.addEventListener('click', ()=>{ if(!window.__deliveries){ toast('No data','error'); return; } downloadFile('deliveries.csv', toCSV(window.__deliveries)); });
  const btnExpAllDeliveriesFiltered = document.getElementById('export-all-deliveries-filtered');
  if(btnExpAllDeliveriesFiltered) btnExpAllDeliveriesFiltered.addEventListener('click', ()=>{
        const st=overviewState.deliveries;
        const term=st.search;
        const rows=(window.__deliveries||[]).filter(d=>{
          if(!term){ return true; }
          return String(d.id)===term || d.status.toLowerCase().includes(term) || (d.notes||'').toLowerCase().includes(term);
        });
        downloadFile('deliveries_filtered.csv', toCSV(rows));
      });
  document.getElementById('export-json').addEventListener('click', ()=>{
        const payload={
          generated:new Date().toISOString(),
          patients:window.__patients||[],
          drugs:window.__drugs||[],
            deliveries:window.__deliveries||[]
        };
        const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
        const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='backup.json'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1000);
        toast('JSON exported','success');
      });
  // Column menu toggle
  document.getElementById('delivery-columns-btn').addEventListener('click', ()=>{ document.getElementById('delivery-columns-menu').classList.toggle('hidden'); });
  document.addEventListener('click', e=>{
        const m=document.getElementById('delivery-columns-menu');
        if(!m){ return; }
        const wrap=document.getElementById('delivery-columns-wrap');
        if(!wrap.contains(e.target)){
          m.classList.add('hidden');
        }
      });
  document.getElementById('delivery-columns-menu').addEventListener('change', e=>{
        if(e.target.matches('input[type=checkbox][data-col]')){
          const col=e.target.getAttribute('data-col'); overviewState.deliveries.visibleCols[col]=e.target.checked; renderAllDeliveries();
        }
      });
  // Bulk selection handlers
  document.addEventListener('change', e=>{
        if(e.target.id==='deliveries-select-all'){
          const st=overviewState.deliveries; const body=document.getElementById('all-deliveries-body');
          const ids=[...body.querySelectorAll('input[data-row-select]')].map(cb=> Number(cb.getAttribute('data-row-select')));
          if(e.target.checked){ ids.forEach(id=> st.selected.add(id)); } else { ids.forEach(id=> st.selected.delete(id)); }
          renderAllDeliveries();
        }
        if(e.target.matches('input[data-row-select]')){
          const id=Number(e.target.getAttribute('data-row-select')); const st=overviewState.deliveries; if(e.target.checked){ st.selected.add(id);} else { st.selected.delete(id);} renderAllDeliveries();
        }
      });
  document.getElementById('bulk-clear').addEventListener('click', ()=>{ overviewState.deliveries.selected.clear(); renderAllDeliveries(); });
  document.getElementById('bulk-delete-deliveries').addEventListener('click', async ()=>{
        const st=overviewState.deliveries;
        if(!st.selected.size){ return; }
        if(!confirmAction('Delete selected deliveries?')){ return; }
        setLoading(true,'Deleting');
        try {
          await Promise.all([...st.selected].map(id=> call(`/api/deliveries/${id}`, {method:'DELETE'})));
          toast('Deleted','success');
          st.selected.clear();
          await refreshDeliveries();
          renderAllDeliveries();
          loadStats();
        }
        catch(e){ console.error(e); toast('Bulk delete failed','error'); }
        finally { setLoading(false); }
      });
  document.querySelectorAll('#deliveries-bulk-bar [data-bulk-status]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const status=btn.getAttribute('data-bulk-status'); const st=overviewState.deliveries; if(!st.selected.size){ return; }
          setLoading(true,'Updating');
          try { await Promise.all([...st.selected].map(id=> call(`/api/deliveries/${id}/status`, {method:'PATCH', body: JSON.stringify({status})}))); toast('Statuses updated','success'); st.selected.clear(); await refreshDeliveries(); renderAllDeliveries(); loadStats(); }
          catch(e){ console.error(e); toast('Bulk update failed','error'); }
          finally { setLoading(false); }
        });
      });
  // Offline / online detection
  function updateOnline(){ const b=document.getElementById('offline-banner'); if(navigator.onLine){ b.classList.add('hidden'); } else { b.classList.remove('hidden'); } }
  window.addEventListener('online', updateOnline); window.addEventListener('offline', updateOnline); updateOnline();

      // INVENTORY FEATURE (revamped)
      const inventoryState={ sort:{key:'name',dir:'asc'}, page:1, pageSize:25, cache:[], summary:[], merged:[], loading:false };
      function setInventoryLoading(v){ inventoryState.loading=v; document.getElementById('inv-loading').classList.toggle('hidden', !v); }
      async function loadInventoryData(){
        setInventoryLoading(true);
        let attempt=0; let lastErr=null;
        const statusEl=document.getElementById('inv-error');
        if(statusEl){ statusEl.textContent=''; statusEl.classList.add('hidden'); }
        try {
          while(attempt<3){
            try {
              attempt++;
              await refreshDrugs();
              const summary = await call('/api/inventory/summary');
              inventoryState.summary=summary||[];
              inventoryState.cache=(window.__drugs||[]).slice();
              mergeInventorySummary();
              renderInventory();
              updateInventoryMetrics();
              lastErr=null; break;
            } catch(e){
              lastErr=e; console.warn('inventory load attempt', attempt, e);
              await new Promise(r=> setTimeout(r, 400*attempt));
            }
          }
          if(lastErr){
            console.error('inventory load failed', lastErr);
            toast('Inventory load failed','error');
            if(statusEl){ statusEl.textContent='Failed to load inventory ('+ lastErr.message +'). Retry later.'; statusEl.classList.remove('hidden'); }
          }
        } finally { setInventoryLoading(false); }
      }
      function mergeInventorySummary(){
        const map=new Map(inventoryState.summary.map(s=>[s.id,s]));
  inventoryState.merged=inventoryState.cache.map(d=> ({...d, ...(map.get(d.id)||{})}));
      }
      function updateInventoryMetrics(){
        const el=document.getElementById('inv-metrics'); if(!el) return;
        const rows=inventoryState.merged;
        if(!rows.length){ el.innerHTML=''; return; }
  let low=0, total=0, pending=0; rows.forEach(r=>{ total+= (r.stock||0); if((r.stock||0) <= (r.reorder_level||0)){ low++; } pending += (r.pending_quantity||0); });
        el.innerHTML=`<div class='px-2 py-1 rounded bg-slate-700/60 border border-slate-600'>Items: ${rows.length}</div>
          <div class='px-2 py-1 rounded bg-slate-700/60 border border-slate-600'>Total Stock: ${total}</div>
          <div class='px-2 py-1 rounded bg-slate-700/60 border border-slate-600 ${low? 'text-rose-300':''}'>Low: ${low}</div>
          <div class='px-2 py-1 rounded bg-slate-700/60 border border-slate-600'>Pending: ${pending}</div>`;
        const lowCountEl=document.getElementById('inv-low-count');
        lowCountEl.textContent= low? low+' low stock' : '';
        lowCountEl.classList.toggle('hidden', !low);
      }
      function inventoryFiltered(){
        const search=(document.getElementById('inv-search').value||'').toLowerCase();
        const lowOnly=document.getElementById('inv-low-toggle').checked;
        let rows=inventoryState.merged.slice();
        if(search){ rows=rows.filter(d=> d.name.toLowerCase().includes(search)|| (d.dosage||'').toLowerCase().includes(search) || String(d.id)===search); }
        if(lowOnly){ rows=rows.filter(d=> (d.stock||0) <= (d.reorder_level||0)); }
        // sort
        const {key,dir}=inventoryState.sort;
        rows.sort((a,b)=>{
          let av=a[key]; let bv=b[key];
          av = (av===undefined||av===null)? '' : av;
          bv = (bv===undefined||bv===null)? '' : bv;
          if(typeof av==='string'){ av=av.toLowerCase(); bv=bv.toLowerCase(); }
          if(av < bv) return dir==='asc'? -1: 1;
          if(av > bv) return dir==='asc'? 1: -1;
          return 0;
        });
        return rows;
      }
      function renderInventory(){
        const body=document.getElementById('inv-body'); const empty=document.getElementById('inv-empty');
        const rows=inventoryFiltered();
        const pageSize=inventoryState.pageSize; const page=inventoryState.page;
        const total=rows.length; const pages=Math.max(1, Math.ceil(total/pageSize));
        if(page>pages){ inventoryState.page=1; }
        const start=(inventoryState.page-1)*pageSize;
        const pageRows=rows.slice(start,start+pageSize);
        body.innerHTML= pageRows.map(d=>{
          const low=(d.stock||0) <= (d.reorder_level||0);
          const badge = low? "<span class='text-[10px] px-1.5 py-0.5 rounded bg-rose-600/30 text-rose-300 border border-rose-500/30'>Low</span>" : "<span class='text-[10px] px-1.5 py-0.5 rounded bg-emerald-600/20 text-emerald-300 border border-emerald-500/30'>OK</span>";
          const pend=d.pending_quantity??0; const daily=d.daily_avg??0; const days=d.days_supply??'—';
          const ds= typeof days==='number'? days : '—';
          return `<tr class='hover:bg-slate-700/40 ${low? 'bg-rose-950/20':''}'>
            <td class='px-3 py-2 text-slate-500 font-medium'>${d.id}</td>
            <td class='px-3 py-2'>${escapeHTML(d.name)}</td>
            <td class='px-3 py-2 text-slate-400'>${escapeHTML(d.dosage||'')}</td>
            <td class='px-3 py-2 ${low? 'text-rose-300 font-semibold':'text-slate-200'}'>${d.stock??0}</td>
            <td class='px-3 py-2 text-slate-400'>${d.reorder_level??0}</td>
            <td class='px-3 py-2 text-slate-300'>${pend}</td>
            <td class='px-3 py-2 text-slate-300'>${daily}</td>
            <td class='px-3 py-2 text-slate-300'>${ds}</td>
            <td class='px-3 py-2'>${badge}</td>
            <td class='px-3 py-2 text-right'>
              <div class='inline-flex gap-1'>
                <button class='text-[10px] px-2 py-1 rounded bg-slate-700 hover:bg-slate-600' data-inv-adjust='${d.id}' title='Quick delta adjust'>Adjust</button>
                <button class='text-[10px] px-2 py-1 rounded bg-indigo-700/80 hover:bg-indigo-600' data-inv-batch='${d.id}' title='Add batch'>Batch</button>
                <button class='text-[10px] px-2 py-1 rounded bg-rose-700/80 hover:bg-rose-600' data-inv-remove='${d.id}' title='Remove stock'>Remove</button>
              </div>
            </td>
          </tr>`;
        }).join('');
        empty.classList.toggle('hidden', !!rows.length);
        document.getElementById('inv-page-info').textContent=`Page ${inventoryState.page} / ${Math.max(1, Math.ceil(total/pageSize))} • ${total} items`;
        document.getElementById('inv-prev').disabled= inventoryState.page<=1;
        document.getElementById('inv-next').disabled= inventoryState.page>=pages;
        updateInventoryMetrics();
      }
      async function fetchInventoryTransactions(){
        try { const trx= await call('/api/inventory/transactions?limit=300'); window.__inv_trx = trx; renderInventoryTransactions(); } catch(e){ console.error('trx load', e); }
      }
      function renderInventoryTransactions(){
        const list=document.getElementById('inv-trx'); if(!list){ return; }
        const filter=document.getElementById('inv-trx-filter').value;
        const empty=document.getElementById('inv-trx-empty');
        let rows=(window.__inv_trx||[]).slice();
        if(filter){ const f=filter.toLowerCase(); rows=rows.filter(r=> (r.reason||'').toLowerCase().includes(f)); }
        if(!rows.length){ list.innerHTML=''; empty.classList.remove('hidden'); return; } else { empty.classList.add('hidden'); }
        list.innerHTML= rows.map(r=>{
          const sign=r.delta>0? '+' : ''; const color=r.delta>0? 'text-emerald-300' : 'text-rose-300';
          return `<li class='px-2 py-1 flex justify-between items-center hover:bg-slate-700/40'>
            <span class='text-slate-500'>#${r.id}</span>
            <span class='flex-1 px-2 truncate'>${escapeHTML(r.reason||'—')}</span>
            <span class='${color} font-mono text-[11px]'>${sign}${r.delta}</span>
          </li>`; }).join('');
      }
      // EVENT HANDLERS
      document.addEventListener('input', e=>{ if(e.target.id==='inv-search'){ inventoryState.page=1; renderInventory(); } });
      document.addEventListener('change', e=>{ if(e.target.id==='inv-low-toggle'){ inventoryState.page=1; renderInventory(); } if(e.target.id==='inv-trx-filter'){ renderInventoryTransactions(); } if(e.target.id==='inv-pagesize'){ inventoryState.pageSize=parseInt(e.target.value,10)||25; inventoryState.page=1; renderInventory(); }});
  document.addEventListener('change', e=>{ if(e.target.id==='analytics-range-select'){ renderAnalytics && renderAnalytics(); }});
  document.addEventListener('click', e=>{ if(e.target && e.target.id==='analytics-refresh'){ renderAnalytics && renderAnalytics(); } });
      const inventoryClickHandlers={
        'inv-refresh': ()=> loadInventoryData(),
        'inv-prev': ()=>{ if(inventoryState.page>1){ inventoryState.page--; renderInventory(); } },
        'inv-next': ()=>{ inventoryState.page++; renderInventory(); },
        'inv-trx-refresh': ()=> fetchInventoryTransactions(),
        'inv-export': ()=>{ const rows=inventoryFiltered().map(d=>({id:d.id,name:d.name,dosage:d.dosage,stock:d.stock,reorder_level:d.reorder_level,pending:d.pending_quantity,daily_avg:d.daily_avg,days_supply:d.days_supply,status:(d.stock||0)<= (d.reorder_level||0)?'LOW':'OK'})); if(!rows.length){ toast('No data','error'); return; } downloadFile('inventory.csv', toCSV(rows)); },
        'inv-adjust-close': ()=> closeInventoryAdjust(),
        'inv-adjust-cancel': ()=> closeInventoryAdjust()
      };
  document.addEventListener('click', e=>{ const t=e.target; if(t.dataset && t.dataset.sort){ const key=t.dataset.sort; if(inventoryState.sort.key===key){ inventoryState.sort.dir= inventoryState.sort.dir==='asc'? 'desc':'asc'; } else { inventoryState.sort.key=key; inventoryState.sort.dir='asc'; } renderInventory(); return; } if(t.matches && t.matches('button[data-inv-adjust]')){ openInventoryAdjust(Number(t.getAttribute('data-inv-adjust'))); return; } if(t.matches && t.matches('button[data-inv-batch]')){ openBatchModal(Number(t.getAttribute('data-inv-batch'))); return; } if(t.matches && t.matches('button[data-inv-remove]')){ openRemoveModal(Number(t.getAttribute('data-inv-remove'))); return; } const fn=inventoryClickHandlers[t.id]; if(fn){ fn(); } });
      // Global refresh buttons wiring
      // Single delegated refresh handler (dedup & robust)
      if(!window.__refreshDelegated){
        window.__refreshDelegated=true;
        document.addEventListener('click', async e=>{
          const id=e.target && e.target.id;
          if(!id || !id.startsWith('refresh-')) return;
          const actions={
            'refresh-dashboard': async ()=>{ await Promise.all([refreshPatients(), refreshDrugs(), refreshDeliveries()]); loadStats(); if(typeof renderActivity==='function') renderActivity(); },
            'refresh-patients': async ()=>{ await refreshPatients(); renderPatients && renderPatients(); renderAllPatients && renderAllPatients(); },
            'refresh-drugs': async ()=>{ await refreshDrugs(); renderDrugs && renderDrugs(); },
            'refresh-deliveries': async ()=>{ await refreshDeliveries(); renderDeliveries && renderDeliveries(); renderAllDeliveries && renderAllDeliveries(); loadStats(); },
            'refresh-history': async ()=>{ await refreshDeliveries(); renderHistory && renderHistory(); },
            'refresh-analytics': async ()=>{ await refreshDeliveries(); buildAnalytics && buildAnalytics(); },
            'refresh-calendar': async ()=>{ await refreshDeliveries(); renderCalendar && renderCalendar(); },
            'refresh-alerts': async ()=>{ await refreshDrugs(); loadStats(); },
            'refresh-settings': async ()=>{ loadSettings && loadSettings(); toast('Defaults loaded','success'); },
            // 'refresh-all-patients' removed (merged into patients view)
            'refresh-all-deliveries': async ()=>{ await refreshDeliveries(); renderAllDeliveries && renderAllDeliveries(); }
          };
          const fn=actions[id]; if(!fn) return;
          setLoading(true, 'Refreshing');
          try { await fn(); }
          catch(err){ console.error('refresh failed', err); toast('Refresh failed','error'); }
          finally { setLoading(false); }
        });
      }
  function openInventoryAdjust(id){ const modal=document.getElementById('inv-adjust-modal'); const drug=inventoryState.merged.find(d=> d.id===id); if(!drug){ return; } modal.classList.remove('hidden'); modal.classList.add('flex'); modal.dataset.drugId=id; document.getElementById('inv-adjust-name').value=`${drug.name} (${drug.dosage||''})`; document.getElementById('inv-adjust-current').value=drug.stock||0; document.getElementById('inv-adjust-reorder').value=drug.reorder_level||0; document.getElementById('inv-adjust-delta').value=''; document.getElementById('inv-adjust-reason').value='manual'; document.getElementById('inv-adjust-error').textContent=''; ['batch_no','isbn','producer','transporter','mfg_date','exp_date','notes'].forEach(f=>{ const el=document.getElementById('inv-adjust-'+f); if(el) el.value=''; }); document.getElementById('inv-adjust-batch-extra').classList.add('hidden'); }
      function closeInventoryAdjust(){ const modal=document.getElementById('inv-adjust-modal'); modal.classList.add('hidden'); modal.classList.remove('flex'); }
      document.getElementById('inv-adjust-delta').addEventListener('input', e=>{ const v=parseInt(e.target.value,10); const box=document.getElementById('inv-adjust-batch-extra'); if(!isNaN(v) && v>0){ box.classList.remove('hidden'); } else { box.classList.add('hidden'); } });
  const adjustBatchToggle=document.getElementById('inv-adjust-batch-toggle'); if(adjustBatchToggle){ adjustBatchToggle.addEventListener('click', ()=>{ document.getElementById('inv-adjust-batch-extra').classList.toggle('hidden'); }); }
      document.getElementById('inv-adjust-form').addEventListener('submit', async e=>{ e.preventDefault(); const modal=document.getElementById('inv-adjust-modal'); const id=Number(modal.dataset.drugId); const delta=parseInt(document.getElementById('inv-adjust-delta').value,10); const reason=document.getElementById('inv-adjust-reason').value||'manual'; const errEl=document.getElementById('inv-adjust-error'); errEl.textContent=''; if(isNaN(delta)||!delta){ errEl.textContent='Enter a non-zero number'; return; } const spin=document.getElementById('inv-adjust-spin'); spin.classList.remove('hidden'); try { if(delta>0){ // require batch metadata
            const batch_no=document.getElementById('inv-adjust-batch_no').value.trim(); if(!batch_no){ throw new Error('Batch No required'); }
            const mfg=document.getElementById('inv-adjust-mfg_date').value; const exp=document.getElementById('inv-adjust-exp_date').value; if(mfg && exp && exp < mfg){ throw new Error('Expiry before manufacturing'); }
            await call('/api/drug_batches',{method:'POST', body: JSON.stringify({drug_id:id, batch_no, isbn:document.getElementById('inv-adjust-isbn').value||null, producer:document.getElementById('inv-adjust-producer').value||null, transporter:document.getElementById('inv-adjust-transporter').value||null, mfg_date:mfg||null, exp_date:exp||null, quantity:delta, notes:document.getElementById('inv-adjust-notes').value||null})});
            toast('Batch added','success');
          } else { // negative delta path
            await call('/api/inventory/adjust',{method:'POST', body: JSON.stringify({drug_id:id, delta, reason})}); toast('Reduced','success'); }
          await loadInventoryData(); fetchInventoryTransactions(); closeInventoryAdjust(); } catch(err){ console.error(err); errEl.textContent= err.message || 'Adjustment failed'; } finally { spin.classList.add('hidden'); } });
      // Batch / Removal Modals
      async function loadRecentBatchRemoval(drug_id){
        try {
          const [batches, removals] = await Promise.all([
            call(`/api/drug_batches?drug_id=${drug_id}`),
            call(`/api/drug_removals?drug_id=${drug_id}`)
          ]);
          const bList=document.getElementById('inv-batch-recent'); if(bList){ bList.innerHTML=(batches||[]).slice(0,8).map(b=>`<li class='flex justify-between gap-2'><span class='truncate'>${escapeHTML(b.batch_no||'#'+b.id)}</span><span class='text-emerald-300 font-mono'>+${b.quantity}</span></li>`).join('')||'<li class="text-slate-500">None</li>'; }
          const rList=document.getElementById('inv-batch-removals'); if(rList){ rList.innerHTML=(removals||[]).slice(0,8).map(r=>`<li class='flex justify-between gap-2'><span class='truncate'>${escapeHTML(r.reason||('#'+r.id))}</span><span class='text-rose-300 font-mono'>-${r.quantity}</span></li>`).join('')||'<li class="text-slate-500">None</li>'; }
          const rb=document.getElementById('inv-remove-recent-batches'); if(rb){ rb.innerHTML=(batches||[]).slice(0,8).map(b=>`<li class='flex justify-between gap-2'><span class='truncate'>${escapeHTML(b.batch_no||'#'+b.id)}</span><span class='text-emerald-300 font-mono'>+${b.quantity}</span></li>`).join('')||'<li class="text-slate-500">None</li>'; }
          const rr=document.getElementById('inv-remove-recent-removals'); if(rr){ rr.innerHTML=(removals||[]).slice(0,8).map(r=>`<li class='flex justify-between gap-2'><span class='truncate'>${escapeHTML(r.reason||('#'+r.id))}</span><span class='text-rose-300 font-mono'>-${r.quantity}</span></li>`).join('')||'<li class="text-slate-500">None</li>'; }
        }catch(e){ console.warn('recent batch/removal load failed', e); }
      }
      function openBatchModal(id, drugOverride){ const modal=document.getElementById('inv-batch-modal'); let drug = drugOverride || (inventoryState.merged||[]).find(d=> d.id===id); if(!drug && window.__drugs){ drug = (window.__drugs||[]).find(d=> d.id===id); } if(!drug){ // minimal placeholder
          drug = {id, name: 'Drug '+id, dosage: ''};
      }
        modal.classList.remove('hidden'); modal.classList.add('flex'); modal.dataset.drugId=id; document.getElementById('inv-batch-drug-id').value=id; document.getElementById('inv-batch-drug-name').value=`${drug.name} (${drug.dosage||''})`; ['batch_no','isbn','producer','transporter','mfg_date','exp_date','quantity','notes'].forEach(f=>{ const el=document.getElementById('inv-batch-'+f); if(el) el.value=''; }); document.getElementById('inv-batch-error').textContent=''; loadRecentBatchRemoval(id); }
      function closeBatchModal(){ const m=document.getElementById('inv-batch-modal'); m.classList.add('hidden'); m.classList.remove('flex'); }
      function openRemoveModal(id){ const modal=document.getElementById('inv-remove-modal'); const drug=inventoryState.merged.find(d=> d.id===id); if(!drug) return; modal.classList.remove('hidden'); modal.classList.add('flex'); modal.dataset.drugId=id; document.getElementById('inv-remove-drug-id').value=id; document.getElementById('inv-remove-drug-name').value=`${drug.name} (${drug.dosage||''})`; ['batch_no','quantity','reason','notes'].forEach(f=>{ const el=document.getElementById('inv-remove-'+f); if(el) el.value=''; }); document.getElementById('inv-remove-error').textContent=''; loadRecentBatchRemoval(id); }
      function closeRemoveModal(){ const m=document.getElementById('inv-remove-modal'); m.classList.add('hidden'); m.classList.remove('flex'); }
      document.getElementById('inv-batch-close').addEventListener('click', closeBatchModal);
      document.getElementById('inv-batch-cancel').addEventListener('click', closeBatchModal);
      document.getElementById('inv-remove-close').addEventListener('click', closeRemoveModal);
      document.getElementById('inv-remove-cancel').addEventListener('click', closeRemoveModal);
    document.getElementById('inv-batch-form').addEventListener('submit', async e=>{
  e.preventDefault(); const id=Number(document.getElementById('inv-batch-drug-id').value); const qty=parseInt(document.getElementById('inv-batch-quantity').value,10); const mfg=document.getElementById('inv-batch-mfg_date').value; const exp=document.getElementById('inv-batch-exp_date').value; const errEl=document.getElementById('inv-batch-error'); errEl.textContent=''; if(isNaN(qty)||qty<=0){ errEl.textContent='Quantity must be positive'; return; } if(mfg && exp && exp < mfg){ errEl.textContent='Expiry must be after manufacturing date'; return; } const spin=document.getElementById('inv-batch-spin'); spin.classList.remove('hidden'); try { await call('/api/drug_batches',{method:'POST', body: JSON.stringify({drug_id:id, batch_no:document.getElementById('inv-batch-batch_no').value||null, isbn:document.getElementById('inv-batch-isbn').value||null, producer:document.getElementById('inv-batch-producer').value||null, transporter:document.getElementById('inv-batch-transporter').value||null, mfg_date:mfg||null, exp_date:exp||null, quantity:qty, notes:document.getElementById('inv-batch-notes').value||null })}); toast('Batch added','success'); await loadInventoryData(); fetchInventoryTransactions(); try { fetchInsights(); fetchInsightsSummary(); } catch{} closeBatchModal(); const df=document.getElementById('drug-form'); if(df){ df.reset(); } } catch(err){ console.error(err); errEl.textContent='Failed to add batch'; } finally { spin.classList.add('hidden'); } });
      document.getElementById('inv-remove-form').addEventListener('submit', async e=>{
        e.preventDefault(); const id=Number(document.getElementById('inv-remove-drug-id').value); const qty=parseInt(document.getElementById('inv-remove-quantity').value,10); const reason=document.getElementById('inv-remove-reason').value.trim(); const errEl=document.getElementById('inv-remove-error'); errEl.textContent=''; if(isNaN(qty)||qty<=0){ errEl.textContent='Quantity must be positive'; return; } if(!reason){ errEl.textContent='Reason required'; return; } const spin=document.getElementById('inv-remove-spin'); spin.classList.remove('hidden'); try { await call('/api/drug_removals',{method:'POST', body: JSON.stringify({drug_id:id, batch_no:document.getElementById('inv-remove-batch_no').value||null, reason, quantity:qty, notes:document.getElementById('inv-remove-notes').value||null })}); toast('Stock removed','success'); await loadInventoryData(); fetchInventoryTransactions(); try { fetchInsights(); fetchInsightsSummary(); } catch{} closeRemoveModal(); } catch(err){ console.error(err); errEl.textContent= (err && err.detail) || 'Removal failed'; } finally { spin.classList.add('hidden'); } });
  // override activateTab to ensure loadInventoryData only once until manual refresh
  const origActivateInv=activateTab; // inventoryBooted defined globally at script top
  activateTab=function(tab){ origActivateInv(tab); if(tab==='inventory'){ if(!inventoryBooted){ inventoryBooted=true; loadInventoryData(); fetchInventoryTransactions(); } } };
  // Removed old delivery-form stock check (replaced with unified validation in primary submit handler above)
      // Removed duplicate activateTab override that referenced missing loadInventorySummary()

    // --- Improved boot sequence ---
    async function boot(){
      loadPrefs();
  // First, auto-detect a working API base (tries 8000 & 5000 on localhost/127.0.0.1 and current origin)
  try { await detectAPIBase(); } catch(e){ console.warn('API base detection failed', e); }
  await checkAPI();
      try {
        await Promise.all([refreshPatients(), refreshDrugs()]);
        await refreshDeliveries();
      } catch(e){ console.error('Initial data load failed', e); }
      loadStats();
  renderAllPatients(); renderAllDeliveries();
      renderAlerts();
      renderAnalytics && renderAnalytics();
      renderInventory(); // empty render before first tab open
      fetchInventoryTransactions();
      renderCalendar();
      activateTab(loadPref('activeTab','dashboard'));
    }
    boot();
    // --- AI Insights Feature ---
        function safeTextify(v){
          // Pretty + safe stringify for arbitrary values (avoids raw [object Object])
          if(v===null || v===undefined) return '';
          const stripMd = (s)=> s.replace(/\*\*(.+?)\*\*/g,'$1').replace(/__(.+?)__/g,'$1').replace(/\*(.+?)\*/g,'$1');
          const primitive = (x)=> (typeof x==='string' || typeof x==='number' || typeof x==='boolean');
          // Fast path strings – also try to pretty print compact JSON
          if(typeof v === 'string'){
            const trimmed=v.trim();
            if((trimmed.startsWith('{')||trimmed.startsWith('[')) && trimmed.length < 6000){
              try { const parsed = JSON.parse(trimmed); return cleanupArtifacts(stripMd(prettyFormat(parsed))); } catch{/* fallthrough */}
            }
            return cleanupArtifacts(stripMd(v));
          }
          if(primitive(v)) return String(v);
          try { return cleanupArtifacts(stripMd(prettyFormat(v))); } catch(e){ try { return cleanupArtifacts(stripMd(JSON.stringify(v))); } catch { return String(v); } }
        }
        function prettyFormat(obj, opts){
          opts = opts || {};
            const maxDepth = opts.maxDepth || 4;
            const maxItems = opts.maxItems || 40;
            const seen = new WeakSet();
            function fmt(x, depth){
              if(x===null) return 'null';
              const t=typeof x;
              if(t==='string') return x.length>240? JSON.stringify(x.slice(0,240)+'…') : JSON.stringify(x);
              if(t==='number' || t==='boolean') return String(x);
              if(t==='function') return '[Function]';
              if(t==='object'){
                if(seen.has(x)) return '[Circular]';
                seen.add(x);
                if(Array.isArray(x)){
                  if(!x.length) return '[]';
                  if(depth>=maxDepth) return `[Array(${x.length})]`;
                  const items = x.slice(0,maxItems).map(i=>fmt(i, depth+1));
                  if(x.length>maxItems) items.push('…');
                  return '[\n'+ indent(items.join(',\n')) +'\n]';
                }
                // Plain object
                const keys = Object.keys(x);
                if(!keys.length) return '{}';
                if(depth>=maxDepth) return `{… ${keys.length} keys}`;
                const out=[];
                for(const k of keys.slice(0,maxItems)){
                  try { out.push(JSON.stringify(k)+': '+fmt(x[k], depth+1)); } catch { out.push(JSON.stringify(k)+': [Error]'); }
                }
                if(keys.length>maxItems) out.push('…');
                return '{\n'+ indent(out.join(',\n')) +'\n}';
              }
              try { return JSON.stringify(x); } catch { return String(x); }
            }
            function indent(s){ return s.split(/\n/).map(l=>'  '+l).join('\n'); }
            return fmt(obj,0);
        }
        function cleanupArtifacts(s){
          if(!s) return s;
          // Remove stray [object Object] tokens left from accidental coercions
          s = s.replace(/\[object Object\]/g,'');
          // Collapse bullet patterns like "*   text" -> "* text"
          s = s.replace(/\*\s{2,}/g,'* ');
          // Trim excessive internal whitespace sequences (>3 spaces)
          s = s.replace(/ {3,}/g,'  ');
          // Remove doubled blank lines (keep at most 1)
          s = s.replace(/\n{3,}/g,'\n\n');
          return s.trim();
        }
    async function fetchInsightsSummary(){
      const sumEl=document.getElementById('ai-summary'); const badge=document.getElementById('ai-badge');
      if(!sumEl) return;
      sumEl.innerHTML='<span class="spinner mr-3"></span>Generating summary…';
      try {
  const res= await fetch(API_BASE+'/api/ai/summary?ts='+(Date.now()));
        const data= await res.json();
        if(badge){ badge.textContent= data.ai? 'AI' : 'Heuristic'; badge.classList.toggle('bg-indigo-600', !!data.ai); badge.classList.toggle('text-white', !!data.ai); }
  sumEl.textContent = safeTextify(data.summary || '(No summary)');
      } catch(e){ console.error('summary', e); sumEl.textContent='Failed to load summary'; }
    }
    async function fetchInsights(){
      try {
  const r= await fetch(API_BASE+'/api/insights?ts='+(Date.now()));
        const d= await r.json();
        // Could render structured insights later (risk patients, inventory issues)
        window.__insights=d; renderStructuredInsights();
      } catch(e){ console.error('insights', e); }
    }
    function renderStructuredInsights(){
      const wrap=document.getElementById('insights-structured'); if(!wrap) return;
      const data=window.__insights; if(!data){ return; }
      // Adherence
      const adhEl=document.getElementById('adherence-summary');
      const riskUl=document.getElementById('risk-patients');
      if(adhEl){
        const a=data.adherence||{};
        const primary = a.broad_percent ?? a.effective_percent ?? a.overall_percent;
        if(primary!=null){
          const parts=[];
          if(a.overall_percent!=null) parts.push(`Overall: ${a.overall_percent}%`);
          if(a.effective_percent!=null) parts.push(`Effective: ${a.effective_percent}%`);
          if(a.broad_percent!=null) parts.push(`Broad: ${a.broad_percent}%`);
          const raw = `D ${a.delivered||0} / M ${a.missed||0} / P ${a.pending||0} / C ${a.cancelled||0}` + (a.overdue_pending? ` / O ${a.overdue_pending}`:'');
          adhEl.innerHTML = `<span class='font-medium text-indigo-300'>Real adherence: ${primary}%</span><span class='block text-[11px] mt-1 text-slate-400'>${parts.join(' | ')}</span><span class='ml-0 block text-[11px] text-slate-500'>(${raw})</span>`;
        } else adhEl.textContent='No adherence data';
      }
      if(riskUl){
        const rp=(data.adherence && data.adherence.risk_patients)||[];
        if(!rp.length){ riskUl.innerHTML='<li class="text-slate-500 text-[11px]">No risk patients in horizon.</li>'; }
        else { riskUl.innerHTML= rp.map(p=>`<li class='flex items-center gap-2'><span class='px-2 py-0.5 rounded bg-rose-600/20 text-rose-300 text-[10px]'>Missed ${p.missed}</span><span class='flex-1 truncate'>${escapeHTML(p.name)}</span><button class='text-[10px] px-2 py-0.5 rounded bg-slate-700 hover:bg-slate-600 border border-slate-600' data-explain-risk='${p.patient_id}'>Ask</button></li>`).join(''); }
      }
      // Inventory issues
      const invUl=document.getElementById('inventory-issues');
      if(invUl){
        const issues=(data.inventory && data.inventory.issues)||[];
        if(!issues.length){ invUl.innerHTML='<li class="text-slate-500 text-[11px]">No inventory issues.</li>'; }
        else { invUl.innerHTML= issues.map(i=>`<li class='flex items-center gap-2'><span class='px-2 py-0.5 rounded ${i.severity==='CRITICAL'?'bg-rose-600/20 text-rose-300':'bg-amber-600/20 text-amber-300'} text-[10px]'>${i.severity}</span><span class='flex-1 truncate'>${escapeHTML(i.name)} (stock ${i.stock}${i.days_supply? ', ~'+i.days_supply+'d':''})</span><button class='text-[10px] px-2 py-0.5 rounded bg-slate-700 hover:bg-slate-600 border border-slate-600' data-explain-inv='${i.drug_id}'>Ask</button></li>`).join(''); }
      }
      // Recommendations
      const recOl=document.getElementById('recommendations-list');
      if(recOl){
        const recs=data.recommendations||[];
        if(!recs.length){ recOl.innerHTML='<li class="text-slate-500 text-[11px] list-none">No recommendations.</li>'; }
        else { recOl.innerHTML= recs.map((r,idx)=>`<li class='flex items-start gap-2'><span class='flex-1'>${escapeHTML(r)}</span><button class='mt-0.5 text-[10px] px-2 py-0.5 rounded bg-slate-700 hover:bg-slate-600 border border-slate-600' data-explain-rec='${idx}'>Ask</button></li>`).join(''); }
      }
      const disc=document.getElementById('insights-disclaimer'); if(disc){ disc.textContent = data.disclaimer||''; }
        // attach AI patient buttons
        document.querySelectorAll('[data-patient-ai]').forEach(btn=>{
          if(btn.dataset.bound) return; btn.dataset.bound='1';
          btn.addEventListener('click', async (e)=>{
            e.stopPropagation(); const id=btn.getAttribute('data-patient-ai'); if(!id) return;
            showInlineModal('Patient AI Summary', `<div class='text-[12px] text-slate-400'>Loading…</div>`);
            try{ const r= await fetch(API_BASE+`/api/ai/patient_summary?patient_id=${id}&ts=${Date.now()}`); const d= await r.json(); const safe = (s)=>escapeHTML(String(s||''));
              const dl=d.recent_deliveries||[]; const rows=dl.slice(0,12).map(x=>`<tr><td class='px-2 py-1 text-[11px]'>${x.id}</td><td class='px-2 py-1 text-[11px]'>${x.scheduled_for}</td><td class='px-2 py-1 text-[11px]'>${x.status}</td><td class='px-2 py-1 text-[11px]'>${x.quantity}</td></tr>`).join('')||'<tr><td class="text-[11px] px-2 py-1 text-slate-500" colspan=4>No recent</td></tr>';
              showInlineModal('Patient AI Summary', `<div class='space-y-3'>
                <div class='text-sm font-medium text-slate-200'>${safe(d.patient?.name)} <span class='text-xs text-slate-400'>#${safe(d.patient?.id)}</span></div>
                <div class='text-[11px] text-slate-400'>${safe(d.summary)}</div>
                <div class='text-[11px] text-slate-400'>30d Adherence: ${d.adherence_percent_30d??'—'}%</div>
                <table class='w-full border border-slate-700 rounded text-[11px]'><thead><tr class='bg-slate-800'><th class='px-2 py-1 text-left'>ID</th><th class='px-2 py-1 text-left'>When</th><th class='px-2 py-1 text-left'>Status</th><th class='px-2 py-1 text-left'>Qty</th></tr></thead><tbody>${rows}</tbody></table>
              </div>`);
            }catch(err){ showInlineModal('Patient AI Summary', `<div class='text-[11px] text-rose-400'>Failed: ${escapeHTML(String(err))}</div>`); }
          });
        });
    }

      // Simple inline modal helper
      function showInlineModal(title, html){
        let host=document.getElementById('inline-modal-host');
        if(!host){ host=document.createElement('div'); host.id='inline-modal-host'; host.className='fixed inset-0 z-50 flex items-center justify-center bg-slate-900/70 p-4'; document.body.append(host); }
        host.innerHTML=`<div class='bg-slate-800 border border-slate-700 rounded max-w-lg w-full shadow-lg'>
          <div class='flex items-center justify-between px-4 py-2 border-b border-slate-700'>
            <h2 class='text-sm font-medium text-slate-200'>${title}</h2>
            <button id='inline-modal-close' class='text-slate-400 hover:text-slate-200 text-xs'>✕</button>
          </div>
          <div class='p-4 max-h-[60vh] overflow-y-auto text-sm'>${html}</div>
        </div>`;
        host.querySelector('#inline-modal-close').onclick=()=> host.remove();
      }

      // Adherence explain button
      document.addEventListener('click', async (e)=>{
        const btn = e.target; if(!(btn instanceof HTMLElement)) return;
        if(btn.id==='btn-explain-adherence'){
          showInlineModal('Adherence Explanation', `<div class='text-[12px] text-slate-400'>Loading…</div>`);
          try{ const r= await fetch(API_BASE+`/api/ai/explain/adherence?ts=${Date.now()}`); const d= await r.json(); const safe=(s)=>escapeHTML(String(s||''));
            const counts=d.counts||{}; const rates=d.rates||{};
            showInlineModal('Adherence Explanation', `<div class='space-y-3 text-[12px]'>
              <div class='text-slate-300 whitespace-pre-line'>${safe(d.explanation)}</div>
              <div class='grid grid-cols-2 gap-2 text-[11px]'>
                ${Object.entries(counts).map(([k,v])=>`<div class='bg-slate-800/60 border border-slate-700 rounded px-2 py-1'><span class='uppercase tracking-wide text-[9px] text-slate-500'>${k}</span><div class='text-slate-200'>${v??'—'}</div></div>`).join('')}
              </div>
              <div class='flex flex-wrap gap-2'>${Object.entries(rates).filter(([,v])=>v!=null).map(([k,v])=>`<span class='text-[10px] px-2 py-1 rounded bg-indigo-600/20 text-indigo-300 border border-indigo-600/30'>${k.replace('_percent','')}: ${v}%</span>`).join('')}</div>
            </div>`);
          }catch(err){ showInlineModal('Adherence Explanation', `<div class='text-[11px] text-rose-400'>Failed: ${escapeHTML(String(err))}</div>`); }
        }
      });
    function crossExamine(kind, id){
      const data=window.__insights||{};
      let question='';
      if(kind==='summary'){
        question = 'Explain how the current operational summary was produced, citing supporting data and noting uncertainties.';
      } else if(kind==='challenge'){
        question = 'Critique the current operational summary: possible overstatements, missing risks, and additional data needed.';
      } else if(kind==='adherence'){
        question = 'Explain adherence calculation and main drivers.';
      } else if(kind==='risk_patient'){
        const rp=((data.adherence||{}).risk_patients||[]).find(p=> String(p.patient_id)===String(id));
        question = 'Analyze adherence risk factors for patient id '+id+'.';
      } else if(kind==='inventory_issue'){
        const issue=((data.inventory||{}).issues||[]).find(i=> String(i.drug_id)===String(id));
        question = 'Explain inventory issue and reorder rationale for drug id '+id+'.';
      } else if(kind==='recommendation'){
        question = 'Justify recommendation #'+id+' and underlying data.';
      }
  if(question && window.askRag){ const inc = document.getElementById('rag-include-context')?.checked || false; askRag(question, inc); }
    }
    function appendChat(role,text){
      const log=document.getElementById('ai-chat-log');
      if(!log) return;
  const item=document.createElement('div');
      item.className='flex items-start gap-2';
  const badge= role==='user'? 'bg-indigo-600 text-white' : 'bg-slate-700 text-slate-300';
  // Structured rendering attempt (JSON -> graphical) for assistant messages only
  const container=document.createElement('div');
  container.className='flex-1 text-slate-300 text-sm';
  let structured=false;
  if(role==='assistant'){
    const structEl = tryRenderStructured(text);
    if(structEl){
      structured=true;
      const wrap=document.createElement('div');
      wrap.className='space-y-2';
      const toolbar=document.createElement('div');
      toolbar.className='flex items-center gap-2 text-[10px] text-slate-500';
      const toggleBtn=document.createElement('button');
      toggleBtn.textContent='Raw';
      toggleBtn.className='px-2 py-0.5 rounded bg-slate-700 hover:bg-slate-600 border border-slate-600';
      const viewRaw=document.createElement('pre');
      viewRaw.className='hidden whitespace-pre-wrap bg-slate-800/60 border border-slate-700 rounded p-2 text-[11px] overflow-x-auto';
      viewRaw.textContent=safeTextify(text);
      toggleBtn.addEventListener('click',()=>{
        const rawShown=!viewRaw.classList.contains('hidden');
        if(rawShown){ viewRaw.classList.add('hidden'); structEl.classList.remove('hidden'); toggleBtn.textContent='Raw'; }
        else { viewRaw.classList.remove('hidden'); structEl.classList.add('hidden'); toggleBtn.textContent='Structured'; }
      });
      toolbar.appendChild(toggleBtn);
      wrap.appendChild(toolbar);
      wrap.appendChild(structEl);
      wrap.appendChild(viewRaw);
      container.appendChild(wrap);
    }
  }
  if(!structured){
    const renderedMsg = safeTextify(text);
    const div=document.createElement('div');
    div.className='whitespace-pre-wrap';
    div.textContent=renderedMsg; // already cleaned -> safe as textContent
    container.appendChild(div);
  }
  item.innerHTML=`<span class='text-[10px] px-2 py-1 rounded ${badge} capitalize'>${role}</span>`;
  item.appendChild(container);
      log.append(item); log.scrollTop=log.scrollHeight;
    }
    // Attempt to parse JSON and return a structured DOM element (table / recursive tree). Returns null if not JSON.
    function tryRenderStructured(raw){
      if(typeof raw !== 'string') return null;
      const trimmed = raw.trim();
      if(!(trimmed.startsWith('{') || trimmed.startsWith('['))) return null;
      let data; try { data=JSON.parse(trimmed); } catch{ return null; }
      // Recursive renderer
      const seen=new WeakSet();
      function renderVal(val, depth){
        if(val===null) return spanAtom('null','text-slate-500');
        if(typeof val==='string') return spanAtom(val.length>260? val.slice(0,260)+'…' : val,'text-emerald-300');
        if(typeof val==='number') return spanAtom(String(val),'text-indigo-300');
        if(typeof val==='boolean') return spanAtom(String(val),'text-orange-300');
        if(typeof val==='object'){
          if(seen.has(val)) return spanAtom('[Circular]','text-rose-400');
          seen.add(val);
          if(Array.isArray(val)){
            if(val.length===0) return spanAtom('[]','text-slate-500');
            // Array of homogenous objects -> table preview
            const objs = val.filter(v=> v && typeof v==='object' && !Array.isArray(v));
            const primitiveArr = val.every(v=> v===null || ['string','number','boolean'].includes(typeof v));
            if(objs.length>=1 && objs.length===val.length){
              const allKeys = Array.from(new Set(objs.flatMap(o=> Object.keys(o)))).slice(0,12);
              const table=document.createElement('table');
              table.className='w-full border border-slate-700 rounded text-[11px]';
              const thead=document.createElement('thead');
              thead.innerHTML='<tr class="bg-slate-800">'+allKeys.map(k=>`<th class='px-2 py-1 text-left font-medium text-slate-300'>${escapeHTML(k)}</th>`).join('')+'</tr>';
              table.appendChild(thead);
              const tbody=document.createElement('tbody');
              val.slice(0,40).forEach(row=>{
                const tr=document.createElement('tr'); tr.className='border-t border-slate-700/60';
                allKeys.forEach(k=>{
                  const td=document.createElement('td'); td.className='px-2 py-1 text-slate-400 align-top max-w-[220px]';
                  const cell=row[k];
                  if(cell && typeof cell==='object') td.textContent = JSON.stringify(cell).slice(0,80);
                  else td.textContent = typeof cell==='string'? cell.slice(0,120) : (cell===null? '' : String(cell));
                  tr.appendChild(td);
                });
                tbody.appendChild(tr);
              });
              if(val.length>40){
                const tr=document.createElement('tr');
                const td=document.createElement('td'); td.colSpan=allKeys.length; td.className='px-2 py-1 text-center text-[10px] text-slate-500';
                td.textContent = `… ${val.length-40} more rows truncated`; tr.appendChild(td); tbody.appendChild(tr);
              }
              table.appendChild(tbody);
              return table;
            }
            if(primitiveArr){
              const ul=document.createElement('ul'); ul.className='list-disc pl-4 space-y-0.5';
              val.slice(0,50).forEach(x=> { const li=document.createElement('li'); li.className='text-[11px] text-slate-400'; li.textContent=String(x); ul.appendChild(li); });
              if(val.length>50){ const li=document.createElement('li'); li.className='text-[10px] text-slate-500'; li.textContent=`… ${val.length-50} more`; ul.appendChild(li);}            
              return ul;
            }
            // Fallback: collapsible list
            const details=document.createElement('details'); if(depth<1) details.open=true;
            const summary=document.createElement('summary'); summary.className='cursor-pointer text-[11px] text-slate-400'; summary.textContent=`Array(${val.length})`;
            details.appendChild(summary);
            val.slice(0,60).forEach((el,i)=>{
              const div=document.createElement('div'); div.className='ml-3 border-l border-slate-700 pl-2 mt-1';
              div.appendChild(renderVal(el, depth+1)); details.appendChild(div);
            });
            if(val.length>60){ const more=document.createElement('div'); more.className='ml-3 text-[10px] text-slate-500'; more.textContent=`… ${val.length-60} more`; details.appendChild(more);} 
            return details;
          }
          // Plain object
          const keys = Object.keys(val);
          if(!keys.length) return spanAtom('{}','text-slate-500');
          const details=document.createElement('details'); if(depth<1) details.open=true;
          const summary=document.createElement('summary'); summary.className='cursor-pointer text-[11px] text-slate-400'; summary.textContent=`Object(${keys.length})`;
          details.appendChild(summary);
          keys.slice(0,80).forEach(k=>{
            const row=document.createElement('div'); row.className='ml-3 border-l border-slate-700 pl-2 mt-1 flex gap-2';
            const keySpan=document.createElement('span'); keySpan.className='text-indigo-300 text-[11px] min-w-[90px] truncate'; keySpan.textContent=k+':';
            row.appendChild(keySpan);
            const valWrap=document.createElement('div'); valWrap.className='flex-1 text-[11px]';
            valWrap.appendChild(renderVal(val[k], depth+1));
            row.appendChild(valWrap);
            details.appendChild(row);
          });
          if(keys.length>80){ const more=document.createElement('div'); more.className='ml-3 text-[10px] text-slate-500'; more.textContent=`… ${keys.length-80} more`; details.appendChild(more);} 
          return details;
        }
        return spanAtom(String(val),'text-slate-400');
      }
      function spanAtom(text, cls){ const s=document.createElement('span'); s.className=cls; s.textContent=text; return s; }
      return renderVal(data,0);
    }
    async function sendChat(message){
      const btn=document.getElementById('ai-chat-send');
      btn.disabled=true; btn.textContent='Sending…';
      try {
        const history=(window.__aiChatHistory||[]);
        history.push({role:'user', content: message});
        appendChat('user', message);
        const res= await fetch(API_BASE+'/api/ai/chat',{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({history})});
        const data= await res.json();
  if(data.reply){ appendChat('assistant', data.reply); window.__aiChatHistory=data.history; }
        else { appendChat('assistant', '(No reply)'); }
        // Automatically offer deeper RAG answer suggestion for analytical queries
  if(/^(why|how many|list|which)/i.test(message) && window.askRag){
          const suggest = document.createElement('div');
          suggest.className='mt-2 text-[11px] text-slate-500';
          suggest.innerHTML = 'Need a data-grounded answer? <button class="underline text-indigo-400" id="rag-suggest-btn">Run RAG lookup</button>';
          const log=document.getElementById('ai-chat-log');
          if(log){ log.lastElementChild && log.lastElementChild.appendChild(suggest); }
          document.addEventListener('click', function handler(ev){ if(ev.target && ev.target.id==='rag-suggest-btn'){ window.askRag(message); document.removeEventListener('click', handler); } });
        }
      } catch(e){ console.error('chat', e); appendChat('assistant','Error sending message'); }
      finally { btn.disabled=false; btn.textContent='Send'; }
    }
    // ---- RAG Answering ----
    async function askRag(question, includeContext=false){
      const statusEl=document.getElementById('rag-status');
      const ansEl=document.getElementById('rag-answer');
      const ctxEl=document.getElementById('rag-context-keys');
      statusEl.textContent='Querying…'; ansEl.textContent='';
      try {
        const res= await fetch(API_BASE+'/api/ai/answer',{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({question, include_context: includeContext})});
        const data= await res.json();
        if(!res.ok){ ansEl.textContent = 'Error: '+ (data.answer||data.detail||res.status); statusEl.textContent=''; return; }
  ansEl.textContent = safeTextify(data.answer || '(No answer)');
        statusEl.textContent = data.ai? 'AI model response' : 'Heuristic fallback response';
        if(data.context_keys){ ctxEl.textContent = data.context_keys.join(', '); }
        if(includeContext && data.context_excerpt){ ctxEl.textContent = (ctxEl.textContent+'\n--- excerpt ---\n'+data.context_excerpt).slice(0,6000); }
      } catch(e){ console.error('rag answer', e); ansEl.textContent='Failed: '+e; statusEl.textContent=''; }
    }
    const ragForm=document.getElementById('rag-form');
    if(ragForm){
      ragForm.addEventListener('submit', e=>{
        e.preventDefault();
        const inp=document.getElementById('rag-input');
        const q=(inp.value||'').trim();
        if(!q) return;
        inp.value='';
  const includeCtx=document.getElementById('rag-include-context')?.checked || false;
  askRag(q, includeCtx);
      });
    }
    const ragToggle=document.getElementById('rag-toggle-context');
    if(ragToggle){ ragToggle.addEventListener('click', ()=>{ const el=document.getElementById('rag-context-keys'); el.classList.toggle('hidden'); ragToggle.textContent = el.classList.contains('hidden')? 'Show Context Keys':'Hide Context Keys'; }); }
    // Expose for cross examination follow-up to escalate to RAG if user wants deeper data
    window.askRag=askRag;
    document.addEventListener('click', e=>{ if(e.target && e.target.id==='insights-refresh'){ fetchInsights(); fetchInsightsSummary(); } });
    document.addEventListener('click', e=>{
      const t=e.target;
      if(!t) return;
      if(t.id==='insights-toggle-structured'){
        const wrap=document.getElementById('insights-structured');
        if(!wrap) return;
        wrap.classList.toggle('hidden');
        t.textContent= wrap.classList.contains('hidden')? 'Show Data':'Hide Data';
        if(!wrap.classList.contains('hidden')) renderStructuredInsights();
        return;
      }
      if(t.id==='insights-explain-summary'){ crossExamine('summary'); return; }
      if(t.id==='insights-challenge'){ crossExamine('challenge'); return; }
      if(t.dataset.explainAdherence!==undefined || t.hasAttribute('data-explain-adherence')){ crossExamine('adherence'); return; }
      if(t.dataset && t.dataset.explainRisk){ crossExamine('risk_patient', t.dataset.explainRisk); return; }
      if(t.dataset && t.dataset.explainInv){ crossExamine('inventory_issue', t.dataset.explainInv); return; }
  if(t.dataset && t.dataset.explainRec){ crossExamine('recommendation', parseInt(t.dataset.explainRec,10)); }
    });
    const chatForm=document.getElementById('ai-chat-form');
    if(chatForm){
      chatForm.addEventListener('submit', e=>{ e.preventDefault(); const input=document.getElementById('ai-chat-input'); const v=(input.value||'').trim(); if(!v){ return; } input.value=''; if(v.startsWith('/img ')){ generateImage(v.substring(5).trim()); } else { sendChat(v); } });
    }
    async function generateImage(prompt){
      const gal=document.getElementById('ai-image-gallery'); if(!gal) return;
      const w=parseInt(document.getElementById('ai-img-width')?.value||'512',10);
      const h=parseInt(document.getElementById('ai-img-height')?.value||'512',10);
      const style=document.getElementById('ai-img-style')?.value||'cool';
      const holder=document.createElement('div'); holder.className='relative rounded overflow-hidden bg-slate-700 flex items-center justify-center text-[10px] text-slate-300'; holder.style.aspectRatio = (w&&h)? `${w}/${h}` : '1/1'; holder.textContent='Generating…'; gal.prepend(holder);
      try {
        const res= await fetch(API_BASE+'/api/ai/image',{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({prompt, width:w, height:h, style})});
        const data= await res.json();
        if(!res.ok){ holder.textContent='Error'; return; }
        const img=document.createElement('img'); img.src=data.image; img.alt=prompt; img.className='w-full h-full object-cover'; holder.textContent=''; holder.appendChild(img); const cap=document.createElement('div'); cap.className='absolute bottom-0 left-0 right-0 bg-black/40 text-[9px] px-1 py-0.5 truncate'; cap.textContent=`${prompt} (${data.style||style})`; holder.appendChild(cap);
      } catch(err){ holder.textContent='Failed'; }
    }
    document.getElementById('ai-rewrite-btn')?.addEventListener('click', async ()=>{
      const log=document.getElementById('ai-chat-log'); if(!log) return; const last=log.querySelector('div:last-child div.flex-1'); if(!last) return;
      const original= last.textContent||''; const mode=document.getElementById('ai-rewrite-mode')?.value||'simplify';
      const rewEl=document.createElement('div'); rewEl.className='text-[10px] text-slate-500'; rewEl.textContent='(rewriting…)'; last.parentElement?.appendChild(rewEl);
      try { const res= await fetch(API_BASE+'/api/ai/rewrite',{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({text: original, mode})}); const data= await res.json(); if(res.ok && data.rewritten){ appendChat('assistant', data.rewritten); } else { appendChat('assistant', 'Rewrite failed'); } } catch(e){ appendChat('assistant','Rewrite error'); }
    });
    // Lazy load when tab first opened
    const origActivate=activateTab;
    let insightsBoot=false;
    activateTab=function(name){
      origActivate(name);
      if(name==='insights' && !insightsBoot){ insightsBoot=true; fetchInsights(); fetchInsightsSummary(); }
    };
    </script>
  </body>
  </html>
