<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MedDelivery - Drug Delivery Management System</title>
  <meta name="description" content="Efficient drug delivery management system for healthcare professionals" />
  <meta name="author" content="MedDelivery Team" />

  <meta property="og:title" content="MedDelivery - Drug Delivery Management System" />
  <meta property="og:description" content="Efficient drug delivery management system for healthcare professionals" />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="https://lovable.dev/opengraph-image-p98pqg.png" />

  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:site" content="@lovable_dev" />
  <meta name="twitter:image" content="https://lovable.dev/opengraph-image-p98pqg.png" />

  <!DOCTYPE html>
  <html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Friendly Med Pal 2.0</title>
    <link rel="icon" href="/favicon.ico" />
    <!-- Early theme class to avoid flash -->
    <script>
      // Tailwind config (dark mode removed)
      tailwind.config = {};
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body { font-feature-settings: "cv02","cv03","cv04","cv11"; background: linear-gradient(140deg,#0f172a,#020617 70%) fixed; position:relative; }
      body::before{content:"";position:fixed;inset:0;background:radial-gradient(circle at 20% 20%, rgba(99,102,241,0.35), transparent 60%), radial-gradient(circle at 80% 70%, rgba(14,165,233,0.25), transparent 65%);pointer-events:none;z-index:-2;}
      body::after{content:"";position:fixed;inset:0;background:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.85" numOctaves="3" stitchTiles="stitch"/></filter><rect width="100%" height="100%" filter="url(%23n)" opacity="0.15"/></svg>');mix-blend-mode:overlay;pointer-events:none;z-index:-1;opacity:.25;}
      .fade-enter { opacity:0; transform: translateY(4px); }
      .fade-enter-active { transition: all .25s; opacity:1; transform: translateY(0); }
      .spinner { width:18px; height:18px; border:3px solid rgba(255,255,255,.35); border-top-color: #6366f1; border-radius:50%; animation: spin 0.8s linear infinite; }
      @keyframes spin { to { transform: rotate(360deg);} }
      .glass { background: linear-gradient(145deg, rgba(30,41,59,.85), rgba(15,23,42,.7)); backdrop-filter: blur(20px) saturate(160%); -webkit-backdrop-filter: blur(20px) saturate(160%); border:1px solid rgba(255,255,255,0.06); box-shadow: 0 4px 16px -4px rgba(0,0,0,.55), 0 0 0 1px rgba(255,255,255,0.04) inset; }
      .card-hover { transition: all .45s cubic-bezier(.4,.2,.2,1); }
      .card-hover:hover { transform: translateY(-4px); box-shadow: 0 10px 28px -6px rgba(0,0,0,.55), 0 0 0 1px rgba(255,255,255,0.05) inset; }
  .heading-gradient { background: linear-gradient(92deg,#fff 0%,#93c5fd 40%,#818cf8 60%,#c7d2fe 90%); -webkit-background-clip: text; background-clip:text; color:transparent; }
      #main-nav { position:relative; }
      #nav-indicator { position:absolute; left:0; top:0; height:30px; border-radius:999px; background:rgba(100,116,139,0.3); backdrop-filter:blur(12px); border:1px solid rgba(255,255,255,0.07); transition: all .5s cubic-bezier(.65,.05,.36,1); box-shadow:0 4px 12px -4px rgba(0,0,0,.55); }
      .pill-btn { position:relative; z-index:1; }
    </style>
  </head>
  <body class="min-h-screen bg-slate-900 text-slate-100 transition-colors">
    <div class="max-w-6xl mx-auto p-6 space-y-10">
      <header class="flex flex-col gap-4">
        <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-2">
          <div>
            <h1 class="text-3xl font-bold tracking-tight flex items-center gap-2">Friendly Med Pal <span class="text-xs font-medium px-2 py-0.5 rounded bg-indigo-600/20 text-indigo-300 border border-indigo-500/30">v2</span></h1>
            <p class="text-slate-500 dark:text-slate-400 text-sm">Drug delivery & adherence tracking dashboard</p>
          </div>
          <div class="flex items-center gap-3 text-xs text-slate-400">
            <span id="api-indicator" class="inline-flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-slate-300 animate-pulse" id="api-dot"></span> API: checking</span>
          </div>
        </div>
        <div class="relative max-w-xl">
          <input id="global-search" placeholder="Search patients, drugs, deliveriesâ€¦" class="w-full bg-slate-800/60 border border-slate-700 rounded px-3 py-2 pr-8 text-xs placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-indigo-600" />
          <svg class="w-4 h-4 absolute right-2 top-1/2 -translate-y-1/2 text-slate-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="7"/><path d="m21 21-4.35-4.35"/></svg>
          <div id="global-search-results" class="hidden absolute z-40 mt-1 inset-x-0 bg-slate-800 border border-slate-700 rounded shadow-lg max-h-72 overflow-auto text-xs"></div>
        </div>
      </header>
      <nav id="main-nav" class="flex flex-wrap gap-1 text-sm mt-2 p-1 rounded-full bg-slate-800/60 backdrop-blur border border-slate-700/70">
        <span id="nav-indicator"></span>
        <button data-tab="dashboard" class="tab-btn pill-btn px-4 py-1.5 rounded-full bg-indigo-600 text-white shadow-inner">Dashboard</button>
        <button data-tab="patients" class="tab-btn pill-btn px-4 py-1.5 rounded-full text-slate-300 hover:text-white">Patients</button>
        <button data-tab="drugs" class="tab-btn pill-btn px-4 py-1.5 rounded-full text-slate-300 hover:text-white">Drugs</button>
        <button data-tab="deliveries" class="tab-btn pill-btn px-4 py-1.5 rounded-full text-slate-300 hover:text-white">Deliveries</button>
        <button data-tab="history" class="tab-btn pill-btn px-4 py-1.5 rounded-full text-slate-300 hover:text-white">History</button>
        <button data-tab="analytics" class="tab-btn pill-btn px-4 py-1.5 rounded-full text-slate-300 hover:text-white">Analytics</button>
        <button data-tab="calendar" class="tab-btn pill-btn px-4 py-1.5 rounded-full text-slate-300 hover:text-white">Calendar</button>
        <button data-tab="alerts" class="tab-btn pill-btn px-4 py-1.5 rounded-full text-slate-300 hover:text-white">Alerts</button>
        <button data-tab="settings" class="tab-btn pill-btn px-4 py-1.5 rounded-full text-slate-300 hover:text-white">Settings</button>
      </nav>

      <section data-view="dashboard" class="space-y-8">
    <div class="relative overflow-hidden rounded-2xl glass p-10 card-hover">
          <div class="absolute inset-0 opacity-[0.15] pointer-events-none" style="background-image: radial-gradient(circle at 25% 15%, #6366f1 0, transparent 60%), radial-gradient(circle at 75% 85%, #0ea5e9 0, transparent 55%);"></div>
          <div class="relative space-y-4">
      <h2 class="text-3xl font-semibold tracking-tight heading-gradient">Welcome back ðŸ‘‹</h2>
      <p class="text-sm text-slate-300/80 leading-relaxed max-w-prose">Monitor medication logistics, track adherence, and keep patient therapy on schedule. Use quick stats & distribution to spot issues early.</p>
            <div class="flex flex-wrap gap-2">
              <button id="seed-btn" class="text-xs px-3 py-1.5 rounded bg-indigo-600 hover:bg-indigo-500 text-white flex items-center gap-2 disabled:opacity-50" title="Insert demo data">Seed Demo Data</button>
              <button id="export-all" class="text-xs px-3 py-1.5 rounded bg-slate-700 hover:bg-slate-600 border border-slate-600" title="Export all data to CSV">Export All CSV</button>
            </div>
          </div>
        </div>
        <div id="stats" class="grid gap-4 sm:grid-cols-3"></div>
        <div class="grid gap-6 md:grid-cols-2">
          <div id="status-distribution" class="glass rounded-xl p-5 card-hover hidden">
            <div class="flex items-center justify-between mb-3"><h3 class="text-sm font-medium flex items-center gap-2">Delivery Status Distribution <span id="dist-total" class="text-[11px] font-normal text-slate-400"></span></h3><canvas id="dist-chart" width="120" height="120" class="w-16 h-16"></canvas></div>
            <div id="dist-bars" class="space-y-3"></div>
          </div>
          <div id="activity-panel" class="glass rounded-xl p-5 flex flex-col card-hover">
            <div class="flex items-center mb-3"><h3 class="text-sm font-medium flex-1">Recent Activity</h3><button id="clear-activity" class="text-[10px] px-2 py-1 rounded bg-slate-700 hover:bg-slate-600">Clear</button></div>
            <div id="activity-empty" class="text-[11px] text-slate-500">No activity yet. Actions you take will appear here.</div>
            <ul id="activity-log" class="space-y-2 text-[11px] overflow-auto max-h-64 soft-scroll"></ul>
          </div>
        </div>
      </section>

      <!-- Patients View -->
  <section data-view="patients" class="bg-slate-800 border border-slate-700 rounded-lg shadow p-5 space-y-4 hidden">
  <h2 class="font-semibold flex items-center gap-2">Patients <input id="patient-filter" placeholder="Filter" class="ml-3 flex-1 max-w-[160px] text-xs border border-slate-600 rounded px-2 py-1 bg-slate-700 placeholder-slate-400 text-slate-100" /><button id="export-patients" class="text-[10px] px-2 py-1 rounded bg-slate-700 hover:bg-slate-600 border border-slate-600 ml-auto">Export</button></h2>
          <form id="patient-form" class="grid gap-3 text-sm">
            <input name="name" required placeholder="Name" class="border border-slate-600 rounded px-3 py-2 bg-slate-700 placeholder-slate-400 text-slate-100" />
            <input name="age" type="number" min="0" placeholder="Age" class="border border-slate-600 rounded px-3 py-2 bg-slate-700 placeholder-slate-400 text-slate-100" />
            <input name="condition" placeholder="Condition" class="border border-slate-600 rounded px-3 py-2 bg-slate-700 placeholder-slate-400 text-slate-100" />
            <div class="flex items-center gap-3">
              <button class="bg-indigo-600 hover:bg-indigo-500 text-white rounded px-4 py-2 font-medium disabled:opacity-50 flex items-center gap-2" id="patient-submit"><span>Add Patient</span><span class="hidden spinner" id="patient-spinner"></span></button>
              <p class="text-xs text-red-500" id="patient-error"></p>
            </div>
          </form>
    <ul id="patient-list" class="text-xs space-y-1 max-h-48 overflow-auto divide-y divide-slate-100"></ul>
      </section>

      <!-- Drugs View -->
  <section data-view="drugs" class="bg-slate-800 border border-slate-700 rounded-lg shadow p-5 space-y-4 hidden">
  <h2 class="font-semibold flex items-center gap-2">Drugs <input id="drug-filter" placeholder="Filter" class="ml-3 flex-1 max-w-[160px] text-xs border border-slate-600 rounded px-2 py-1 bg-slate-700 placeholder-slate-400 text-slate-100" /><button id="export-drugs" class="text-[10px] px-2 py-1 rounded bg-slate-700 hover:bg-slate-600 border border-slate-600 ml-auto">Export</button></h2>
          <form id="drug-form" class="grid gap-3 text-sm">
            <input name="name" required placeholder="Name" class="border border-slate-600 rounded px-3 py-2 bg-slate-700 placeholder-slate-400 text-slate-100" />
            <input name="dosage" placeholder="Dosage" class="border border-slate-600 rounded px-3 py-2 bg-slate-700 placeholder-slate-400 text-slate-100" />
            <div class="flex items-center gap-3">
              <button class="bg-indigo-600 hover:bg-indigo-500 text-white rounded px-4 py-2 font-medium disabled:opacity-50 flex items-center gap-2" id="drug-submit"><span>Add Drug</span><span class="hidden spinner" id="drug-spinner"></span></button>
              <p class="text-xs text-red-500" id="drug-error"></p>
            </div>
          </form>
    <ul id="drug-list" class="text-xs space-y-1 max-h-48 overflow-auto divide-y divide-slate-100"></ul>
      </section>

      <!-- Deliveries View -->
  <section data-view="deliveries" class="bg-slate-800 border border-slate-700 rounded-lg shadow p-5 space-y-4 hidden">
  <h2 class="font-semibold flex items-center gap-4">Deliveries <span class="text-xs font-normal text-slate-400" id="refresh-countdown"></span><label class="ml-auto inline-flex items-center gap-1 text-xs cursor-pointer select-none"><input type="checkbox" id="auto-refresh" class="accent-indigo-500" checked /> Auto</label><button id="toggle-overdue" class="text-[10px] px-2 py-1 rounded border border-slate-600 bg-slate-700 hover:bg-slate-600" title="Toggle overdue pending deliveries">Overdue</button><button id="export-deliveries" class="text-[10px] px-2 py-1 rounded bg-slate-700 hover:bg-slate-600 border border-slate-600">Export</button></h2>
    <div id="delivery-status-filters" class="flex flex-wrap gap-2 text-[11px]"></div>
        <form id="delivery-form" class="grid gap-3 md:grid-cols-2 text-sm">
  <select name="patient_id" required class="border border-slate-600 rounded px-3 py-2 bg-slate-700 text-slate-100"></select>
  <select name="drug_id" required class="border border-slate-600 rounded px-3 py-2 bg-slate-700 text-slate-100"></select>
  <input type="datetime-local" name="scheduled_for" required class="border border-slate-600 rounded px-3 py-2 md:col-span-2 bg-slate-700 text-slate-100" />
  <input name="notes" placeholder="Notes" class="border border-slate-600 rounded px-3 py-2 md:col-span-2 bg-slate-700 placeholder-slate-400 text-slate-100" />
          <div class="flex items-center gap-3 md:col-span-2">
            <button class="bg-indigo-600 hover:bg-indigo-500 text-white rounded px-4 py-2 font-medium flex items-center gap-2 disabled:opacity-50" id="delivery-submit"><span>Schedule Delivery</span><span class="hidden spinner" id="delivery-spinner"></span></button>
            <p class="text-xs text-red-500" id="delivery-error"></p>
          </div>
        </form>
        <div id="deliveries" class="space-y-2 text-xs"></div>
      </section>

      <!-- History View -->
    <section data-view="history" class="bg-slate-800 border border-slate-700 rounded-lg shadow p-5 space-y-4 hidden">
    <h2 class="font-semibold flex items-center gap-4">History <span class="text-xs font-normal text-slate-400" id="history-count"></span></h2>
        <div class="flex flex-wrap gap-3 text-xs items-end">
          <label class="flex flex-col gap-1">Status
            <select id="history-status" class="border border-slate-600 rounded px-2 py-1 bg-slate-700 text-slate-100">
              <option value="">All</option>
              <option>pending</option>
              <option>delivered</option>
              <option>missed</option>
              <option>cancelled</option>
            </select>
          </label>
          <label class="flex flex-col gap-1">Search
            <input id="history-search" placeholder="patient/drug/id" class="border border-slate-600 rounded px-2 py-1 bg-slate-700 placeholder-slate-400 text-slate-100" />
          </label>
          <button id="history-refresh" class="ml-auto px-3 py-1 rounded bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600">Refresh</button>
        </div>
    <div id="history-list" class="divide-y divide-slate-100 text-xs max-h-80 overflow-auto"></div>
      </section>

      <!-- Analytics View -->
      <section data-view="analytics" class="bg-slate-800 border border-slate-700 rounded-lg shadow p-5 space-y-5 hidden">
        <h2 class="font-semibold flex items-center gap-3">Analytics <span id="analytics-range" class="text-xs font-normal text-slate-400"></span></h2>
        <div class="grid gap-4 md:grid-cols-2">
          <div class="space-y-3">
            <h3 class="text-sm font-medium flex items-center gap-2">Daily Delivery Volume <button id="analytics-refresh" class="text-[10px] px-2 py-0.5 rounded bg-slate-700 hover:bg-slate-600">Reload</button></h3>
            <canvas id="daily-line" height="160" class="w-full bg-slate-900/40 rounded border border-slate-700"></canvas>
          </div>
          <div class="space-y-3">
            <h3 class="text-sm font-medium">Status Mix (Last 14 days)</h3>
            <div id="analytics-status" class="text-[11px] space-y-2"></div>
          </div>
        </div>
        <div class="space-y-2">
          <h3 class="text-sm font-medium">Top Patients by Deliveries</h3>
          <ol id="top-patients" class="text-[11px] space-y-1 list-decimal list-inside"></ol>
        </div>
      </section>

      <!-- Calendar View -->
      <section data-view="calendar" class="bg-slate-800 border border-slate-700 rounded-lg shadow p-5 space-y-5 hidden">
        <div class="flex items-center gap-3">
          <h2 class="font-semibold flex-1" id="cal-title">Calendar</h2>
          <div class="flex gap-1">
            <button id="cal-prev" class="px-2 py-1 text-xs rounded bg-slate-700 hover:bg-slate-600">Prev</button>
            <button id="cal-today" class="px-2 py-1 text-xs rounded bg-slate-700 hover:bg-slate-600">Today</button>
            <button id="cal-next" class="px-2 py-1 text-xs rounded bg-slate-700 hover:bg-slate-600">Next</button>
          </div>
        </div>
        <div id="cal-grid" class="grid grid-cols-7 gap-2 text-center text-[11px]"></div>
        <div>
          <h3 class="text-sm font-medium mb-2">Selected Day</h3>
          <div id="cal-day-list" class="space-y-2 text-[11px] max-h-60 overflow-auto"></div>
        </div>
      </section>

      <!-- Alerts View -->
      <section data-view="alerts" class="bg-slate-800 border border-slate-700 rounded-lg shadow p-5 space-y-4 hidden">
        <h2 class="font-semibold flex items-center gap-2">Alerts <span id="alert-count" class="text-xs font-normal text-slate-400"></span></h2>
        <div id="alert-list" class="space-y-2 text-[11px]"></div>
      </section>

      <!-- Settings View -->
      <section data-view="settings" class="bg-slate-800 border border-slate-700 rounded-lg shadow p-5 space-y-6 hidden">
        <h2 class="font-semibold">Settings</h2>
        <form id="settings-form" class="space-y-4 text-sm max-w-md">
          <div class="flex flex-col gap-1">
            <label for="set-refresh" class="text-xs uppercase tracking-wide text-slate-400">Auto Refresh Interval (seconds)</label>
            <input type="number" min="5" max="300" id="set-refresh" class="bg-slate-700 border border-slate-600 rounded px-3 py-2" />
            <p class="text-[11px] text-slate-500">Controls deliveries + stats auto-refresh cadence.</p>
          </div>
          <div class="flex flex-col gap-1">
            <label for="set-activity-display" class="text-xs uppercase tracking-wide text-slate-400">Activity Display Limit</label>
            <input type="number" min="10" max="200" id="set-activity-display" class="bg-slate-700 border border-slate-600 rounded px-3 py-2" />
          </div>
          <div class="flex flex-col gap-1">
            <label for="set-activity-store" class="text-xs uppercase tracking-wide text-slate-400">Activity Store Limit</label>
            <input type="number" min="50" max="1000" id="set-activity-store" class="bg-slate-700 border border-slate-600 rounded px-3 py-2" />
          </div>
          <div class="flex items-center gap-2">
            <button class="bg-indigo-600 hover:bg-indigo-500 text-white rounded px-4 py-2 text-sm" type="submit">Save Settings</button>
            <span id="settings-status" class="text-[11px] text-slate-400"></span>
          </div>
        </form>
        <div class="text-[11px] text-slate-500">Shortcuts: Alt+1..8 switch tabs, / focus search, Ctrl+Shift+S seed, Ctrl+Shift+E export all.</div>
      </section>

      <footer class="text-center text-xs text-slate-400 py-8">&copy; 2025 Friendly Med Pal 2.0</footer>
    </div>

    <!-- Patient Detail Modal -->
    <div id="patient-modal" class="hidden fixed inset-0 z-50 items-start justify-center pt-20 px-4 bg-slate-900/70 backdrop-blur-sm">
      <div class="w-full max-w-lg bg-slate-800 border border-slate-700 rounded-lg shadow-xl flex flex-col max-h-[80vh]">
        <div class="flex items-center gap-2 px-4 py-3 border-b border-slate-700">
          <h3 id="pm-title" class="font-semibold text-sm flex-1">Patient</h3>
          <button id="pm-close" class="text-slate-400 hover:text-slate-200 text-lg leading-none">&times;</button>
        </div>
        <div id="pm-body" class="p-4 space-y-4 overflow-auto text-xs"></div>
      </div>
    </div>

    <template id="tpl-stat">
  <div class="bg-slate-800 border border-slate-700 rounded-lg p-4 shadow flex flex-col gap-1">
        <span class="text-[10px] uppercase tracking-wide text-slate-400" data-part="label"></span>
        <span class="text-2xl font-semibold" data-part="value"></span>
      </div>
    </template>

    <div id="toast-wrap" class="fixed top-4 right-4 z-50 space-y-2 w-64"></div>
    <div id="loading-overlay" class="hidden fixed inset-0 bg-slate-900/30 backdrop-blur-sm flex items-center justify-center z-40">
      <div class="bg-white px-6 py-4 rounded shadow flex items-center gap-3 text-sm"><span class="spinner !w-6 !h-6 !border-4 !border-slate-300 !border-t-indigo-600"></span> <span id="loading-text">Working...</span></div>
    </div>

    <script>
      const API_BASE = 'http://127.0.0.1:8000';
      let globalLoading = 0;
      function setLoading(on, label='Working...'){
        globalLoading += on?1:-1; if(globalLoading<0) globalLoading=0;
        const ov = document.getElementById('loading-overlay');
        const txt = document.getElementById('loading-text');
        if(label) txt.textContent = label;
        if(globalLoading>0) ov.classList.remove('hidden'); else ov.classList.add('hidden');
      }
      function toast(msg, type='info'){
        const wrap=document.getElementById('toast-wrap');
        const el=document.createElement('div');
        el.className='fade-enter bg-white dark:bg-slate-800 border text-slate-700 dark:text-slate-200 text-xs px-3 py-2 rounded shadow flex items-start gap-2';
        const colors={info:'border-slate-200 dark:border-slate-700', success:'border-emerald-300 dark:border-emerald-600', error:'border-red-300 dark:border-red-600'};
        el.className += ' '+(colors[type]||colors.info);
        el.innerHTML=`<span>${msg}</span><button class='ml-auto text-slate-400 hover:text-slate-600 dark:hover:text-slate-300'>&times;</button>`;
        el.querySelector('button').onclick=()=>{el.remove();};
        wrap.append(el);
        requestAnimationFrame(()=>{el.classList.add('fade-enter-active');});
        setTimeout(()=>{el.classList.remove('fade-enter-active'); el.style.opacity='0'; setTimeout(()=>el.remove(),250);}, 4000);
      }
  function savePref(key,val){ try{ localStorage.setItem(key, String(val)); }catch{} }
  function loadPref(key,def){ try{ const v=localStorage.getItem(key); return v!==null?v:def; }catch{ return def; } }

      async function call(path, opts={}) {
        const res = await fetch(API_BASE + path, {headers:{'Content-Type':'application/json'}, ...opts});
        if(!res.ok){
          let msg;
          try { msg = (await res.json()).detail || await res.text(); } catch { msg = res.statusText; }
          throw new Error(res.status + ' ' + msg);
        }
        return res.json();
      }

      function stat(label, value){
        const node = document.getElementById('tpl-stat').content.cloneNode(true);
        node.querySelector('[data-part=label]').textContent = label;
        node.querySelector('[data-part=value]').textContent = value;
        return node;
      }

      async function loadStats(){
        // Try dedicated stats endpoint first; fall back to manual aggregation.
        const wrap = document.getElementById('stats');
        wrap.innerHTML='';
        try {
          const s = await call('/api/stats');
          wrap.append(stat('Patients', s.patients ?? s.total_patients ?? 'â€”'));
          wrap.append(stat('Drugs', s.drugs ?? s.total_drugs ?? 'â€”'));
          wrap.append(stat('Deliveries', s.deliveries ?? s.total_deliveries ?? 'â€”'));
          if(s.status_breakdown){
            renderStatusDistribution(s.status_breakdown);
          }
        } catch {
          try {
            const [patients, drugs, deliveries] = await Promise.all([
              call('/api/patients'), call('/api/drugs'), call('/api/deliveries')
            ]);
            wrap.append(stat('Patients', patients.length));
            wrap.append(stat('Drugs', drugs.length));
            wrap.append(stat('Pending', deliveries.filter(d=>d.status==='pending').length));
            renderStatusDistribution(deliveries.reduce((acc,d)=>{acc[d.status]=(acc[d.status]||0)+1;return acc;},{}));
          } catch(err){
            console.error('Stats fallback fetch failed', err);
            wrap.innerHTML='<div class="text-xs text-red-500">Failed to load stats</div>';
          }
        }
      }

      function renderStatusDistribution(breakdown){
        const total = Object.values(breakdown).reduce((a,b)=>a+b,0);
        const box = document.getElementById('status-distribution');
        const bars = document.getElementById('dist-bars');
        if(!total){ box.classList.add('hidden'); return; }
        box.classList.remove('hidden');
        document.getElementById('dist-total').textContent = total + ' total';
        const order=['pending','delivered','missed','cancelled'];
        const color={pending:'bg-amber-500', delivered:'bg-emerald-500', missed:'bg-red-500', cancelled:'bg-slate-500'};
        bars.innerHTML='';
        order.filter(k=>breakdown[k]).forEach(k=>{
          const count = breakdown[k];
          const pct = ((count/total)*100).toFixed(1);
          const row=document.createElement('div');
          row.innerHTML=`<div class='flex justify-between text-[11px] mb-1'><span class='flex items-center gap-2'><span class='inline-block w-2 h-2 rounded-full ${color[k]||'bg-slate-500'}'></span>${k}</span><span>${count} â€¢ ${pct}%</span></div><div class='h-2 w-full rounded bg-slate-700 overflow-hidden'><div class='h-full ${color[k]||'bg-slate-500'}' style='width:${pct}%' aria-label='${k} ${pct}%'></div></div>`;
          bars.append(row);
        });
        drawDonutChart(breakdown, total);
        // Inject adherence metric (delivered / (delivered+missed+cancelled))
        try {
          const denom=(breakdown.delivered||0)+(breakdown.missed||0)+(breakdown.cancelled||0);
          if(denom){
            const adherence=((breakdown.delivered||0)/denom*100).toFixed(1)+'%';
            const title=box.querySelector('h3');
            if(title){
              let badge=title.querySelector('.adherence-badge');
              if(!badge){
                badge=document.createElement('span');
                badge.className='adherence-badge ml-2 text-[10px] px-1.5 py-0.5 rounded bg-indigo-600/30 text-indigo-300 border border-indigo-600/40';
                title.append(badge);
              }
              badge.textContent='Adherence '+adherence;
            }
          }
        } catch{}
      }

      function drawDonutChart(breakdown,total){
        const cv=document.getElementById('dist-chart'); if(!cv){ return; } const ctx=cv.getContext('2d'); const segments=['pending','delivered','missed','cancelled'].filter(s=>breakdown[s]); if(!segments.length){ ctx.clearRect(0,0,cv.width,cv.height); return; }
        const colors={pending:'#f59e0b',delivered:'#10b981',missed:'#ef4444',cancelled:'#64748b'}; let start= -Math.PI/2; ctx.clearRect(0,0,cv.width,cv.height); const r=Math.min(cv.width,cv.height)/2; const cx=cv.width/2, cy=cv.height/2; segments.forEach(s=>{ const val=breakdown[s]; const angle=(val/total)*Math.PI*2; ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,r,start,start+angle); ctx.closePath(); ctx.fillStyle=colors[s]; ctx.fill(); start+=angle; }); ctx.globalCompositeOperation='destination-out'; ctx.beginPath(); ctx.arc(cx,cy,r*0.55,0,Math.PI*2); ctx.fill(); ctx.globalCompositeOperation='source-over'; }

      function drawLineChart(canvasId, points){
        const cv=document.getElementById(canvasId); if(!cv){ return; }
        const ctx=cv.getContext('2d'); const w=cv.width=cv.clientWidth; const h=cv.height=cv.clientHeight;
        ctx.clearRect(0,0,w,h);
        if(!points.length){ ctx.fillStyle='#64748b'; ctx.font='12px sans-serif'; ctx.fillText('No data',8,16); return; }
  const ys=points.map(p=>p.y);
  const maxY=Math.max(...ys,1);
        // grid
        ctx.strokeStyle='#1e293b'; ctx.lineWidth=1; for(let i=0;i<=4;i++){ const y=h-(i/4)*h; ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke(); }
        // line
        ctx.strokeStyle='#6366f1'; ctx.lineWidth=2; ctx.beginPath(); points.forEach((p,i)=>{ const px=(i/(points.length-1))*w; const py= h - (p.y/maxY)*h; if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py); }); ctx.stroke();
        // area
        ctx.fillStyle='rgba(99,102,241,0.15)'; ctx.lineTo(w,h); ctx.lineTo(0,h); ctx.closePath(); ctx.fill();
        // points
        ctx.fillStyle='#6366f1'; points.forEach((p,i)=>{ const px=(i/(points.length-1))*w; const py= h - (p.y/maxY)*h; ctx.beginPath(); ctx.arc(px,py,3,0,Math.PI*2); ctx.fill(); });
      }

      let activityStore=[];
      let ACTIVITY_DISPLAY_LIMIT = Number(loadPref('activityDisplayLimit',50));
      let ACTIVITY_STORE_LIMIT = Number(loadPref('activityStoreLimit',200));
      function persistActivity(){ try{ localStorage.setItem('activityLog', JSON.stringify(activityStore.slice(0,200))); }catch{} }
      function loadActivity(){
        try { activityStore=JSON.parse(localStorage.getItem('activityLog')||'[]'); }catch{ activityStore=[]; }
        const list=document.getElementById('activity-log'); const empty=document.getElementById('activity-empty');
        list.innerHTML='';
        if(!activityStore.length){ empty.classList.remove('hidden'); return; }
        empty.classList.add('hidden');
        activityStore.forEach(a=>{
          const li=document.createElement('li'); li.className='flex items-start gap-2';
            li.innerHTML=`<span class='mt-0.5 w-1.5 h-1.5 rounded-full bg-indigo-500'></span><div class='flex-1'><div class='font-medium'>${a.action}</div><div class='text-[10px] text-slate-500'>${a.time}${a.meta? ' â€¢ '+a.meta:''}</div></div>`;
          list.append(li);
        });
      }
      function logActivity(action, meta=''){
        const list=document.getElementById('activity-log'); const empty=document.getElementById('activity-empty'); if(!list){ return; }
        if(empty){ empty.classList.add('hidden'); }
        const time=new Date().toLocaleTimeString();
        const li=document.createElement('li'); li.className='flex items-start gap-2';
        li.innerHTML=`<span class='mt-0.5 w-1.5 h-1.5 rounded-full bg-indigo-500'></span><div class='flex-1'><div class='font-medium'>${action}</div><div class='text-[10px] text-slate-500'>${time}${meta? ' â€¢ '+meta:''}</div></div>`;
        list.prepend(li);
        activityStore.unshift({action,time,meta});
        while(activityStore.length>ACTIVITY_STORE_LIMIT){ activityStore.pop(); }
        persistActivity();
        while(list.children.length>ACTIVITY_DISPLAY_LIMIT){ list.lastChild.remove(); }
      }
  document.addEventListener('click', e=>{ if(e.target && e.target.id==='clear-activity'){ const list=document.getElementById('activity-log'); if(list){ list.innerHTML=''; } activityStore=[]; persistActivity(); const empty=document.getElementById('activity-empty'); if(empty){ empty.classList.remove('hidden'); } }});

      function escapeHTML(str){ return str.replace(/[&<>"]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c])); }
      function confirmAction(msg){ return window.confirm(msg); }

      async function refreshPatients(){
        const pts = await call('/api/patients');
        window.__patients = pts;
        const list = document.getElementById('patient-list');
        list.innerHTML='';
        const sel = document.querySelector('select[name=patient_id]');
        sel.innerHTML='<option value="" disabled selected>Select patient</option>';
        filterPatients().forEach(p=>{
          const li=document.createElement('li');
          li.className='py-1 flex items-center justify-between gap-2';
          li.innerHTML = `<span class='truncate'>${p.id}. <strong>${escapeHTML(p.name)}</strong>${p.age? ' ('+p.age+')':''} ${p.condition?'<span class="ml-1 text-[10px] px-1 py-0.5 rounded bg-slate-100 dark:bg-slate-700">'+escapeHTML(p.condition)+'</span>':''}</span>`;
          const actions=document.createElement('div');
          actions.className='flex gap-1';
          const details=document.createElement('button'); details.className='px-2 py-0.5 text-[10px] rounded bg-indigo-600/70 hover:bg-indigo-600'; details.textContent='Details'; details.onclick=()=> openPatientModal(p.id);
          const edit=document.createElement('button'); edit.className='px-2 py-0.5 text-[10px] rounded bg-slate-700 hover:bg-slate-600'; edit.textContent='Edit';
          edit.onclick=async()=>{
            const name=prompt('Name', p.name); if(name===null) return;
            const age=prompt('Age', p.age||''); if(age===null) return;
            const condition=prompt('Condition', p.condition||''); if(condition===null) return;
            try {
              await call(`/api/patients/${p.id}`, {method:'PATCH', body: JSON.stringify({name, age: age?Number(age):null, condition})});
              toast('Patient updated','success');
              refreshPatients();
            } catch(e){
              console.error('Patient update failed', e);
              toast('Update failed','error');
            }
          };
          const del=document.createElement('button'); del.className='px-2 py-0.5 text-[10px] rounded bg-red-600/80 hover:bg-red-600'; del.textContent='Del';
          del.onclick=async()=>{
            if(!confirmAction('Delete patient and related deliveries?')) { return; }
            try {
              await call(`/api/patients/${p.id}`, {method:'DELETE'});
              toast('Patient deleted','success');
              refreshPatients();
              refreshDeliveries();
              loadStats();
            } catch(e){
              console.error('Patient delete failed', e);
              toast('Delete failed','error');
            }
          };
          actions.append(details, edit, del); li.append(actions); list.append(li);
          const opt=document.createElement('option'); opt.value=p.id; opt.textContent=p.name; sel.append(opt);
        });
      }

      async function refreshDrugs(){
        const drugs = await call('/api/drugs');
        window.__drugs = drugs;
        const list = document.getElementById('drug-list');
        list.innerHTML='';
        const sel = document.querySelector('select[name=drug_id]');
        sel.innerHTML='<option value="" disabled selected>Select drug</option>';
        filterDrugs().forEach(d=>{
          const li=document.createElement('li');
            li.className='py-1 flex items-center justify-between gap-2';
            li.innerHTML = `<span class='truncate'>${d.id}. <strong>${escapeHTML(d.name)}</strong>${d.dosage? ' <span class="text-[10px] px-1 py-0.5 rounded bg-indigo-100 dark:bg-indigo-600/30">'+escapeHTML(d.dosage)+'</span>':''}</span>`;
          const actions=document.createElement('div'); actions.className='flex gap-1';
          const edit=document.createElement('button'); edit.className='px-2 py-0.5 text-[10px] rounded bg-slate-700 hover:bg-slate-600'; edit.textContent='Edit';
          edit.onclick=async()=>{
            const name=prompt('Name', d.name);
            if(name===null){ return; }
            const dosage=prompt('Dosage', d.dosage||'');
            if(dosage===null){ return; }
            try {
              await call(`/api/drugs/${d.id}`, {method:'PATCH', body: JSON.stringify({name, dosage})});
              toast('Drug updated','success');
              refreshDrugs();
            } catch(e){
              console.error('Drug update failed', e);
              toast('Update failed','error');
            }
          };
          const del=document.createElement('button'); del.className='px-2 py-0.5 text-[10px] rounded bg-red-600/80 hover:bg-red-600'; del.textContent='Del';
          del.onclick=async()=>{ if(!confirmAction('Delete drug and related deliveries?')) { return; } try { await call(`/api/drugs/${d.id}`, {method:'DELETE'}); toast('Drug deleted','success'); refreshDrugs(); refreshDeliveries(); loadStats(); } catch(e){ console.error('Drug delete failed', e); toast('Delete failed','error'); } };
          actions.append(edit, del); li.append(actions); list.append(li);
          const opt=document.createElement('option'); opt.value=d.id; opt.textContent=d.name; sel.append(opt);
        });
      }

      function statusBadge(status){
        const colors={pending:'bg-amber-100 text-amber-700 dark:bg-amber-500/20 dark:text-amber-300', delivered:'bg-emerald-100 text-emerald-700 dark:bg-emerald-500/20 dark:text-emerald-300', missed:'bg-red-100 text-red-700 dark:bg-red-500/20 dark:text-red-300', cancelled:'bg-slate-200 text-slate-700 dark:bg-slate-600/40 dark:text-slate-300'};
        return `<span class="px-2 py-0.5 rounded text-[10px] font-medium ${colors[status]||'bg-slate-200'}">${status}</span>`;
      }
      let deliveryStatusFilter='';
      function buildDeliveryStatusFilters(){
        const container=document.getElementById('delivery-status-filters');
  if(!container){ return; }
  container.innerHTML='';
        ['all','pending','delivered','missed','cancelled'].forEach(st=>{
          const btn=document.createElement('button');
          const active = (st==='all' && !deliveryStatusFilter) || deliveryStatusFilter===st;
          btn.className='px-2 py-1 rounded border text-[11px] '+(active?'bg-indigo-600 border-indigo-600 text-white':'border-slate-600 hover:bg-slate-700');
          btn.textContent=st;
          btn.onclick=()=>{ deliveryStatusFilter = (st==='all')?'':st; buildDeliveryStatusFilters(); refreshDeliveries(); };
          container.append(btn);
        });
      }
      let overdueOnly=false;
      async function refreshDeliveries(){
        const deliveries = await call('/api/deliveries');
        window.__deliveries = deliveries;
        const wrap = document.getElementById('deliveries');
        wrap.innerHTML='';
        const now=Date.now();
        const filteredAll = deliveryStatusFilter? deliveries.filter(d=>d.status===deliveryStatusFilter): deliveries;
        const filtered = overdueOnly? filteredAll.filter(d=> d.status==='pending' && new Date(d.scheduled_for).getTime() < now): filteredAll;
        filtered.forEach(d=>{
          const row = document.createElement('div');
          row.className='group border rounded p-2 flex flex-col gap-2 hover:shadow transition bg-white dark:bg-slate-900/40 border-slate-200 dark:border-slate-700';
          const top = document.createElement('div');
          top.className='flex flex-wrap items-center justify-between gap-2';
          const overdue = d.status==='pending' && new Date(d.scheduled_for).getTime() < now;
          if(overdue){ row.classList.add('border-red-500','animate-pulse'); }
          top.innerHTML = `<span class='font-medium'>#${d.id} ${statusBadge(d.status)}${overdue? ' <span class="ml-1 px-1.5 py-0.5 rounded bg-red-600/20 text-red-400 text-[10px]">overdue</span>':''}</span><span class='text-[11px] text-slate-500 dark:text-slate-400'>P${d.patient_id} â€¢ D${d.drug_id} â€¢ ${d.scheduled_for}</span>`;
          const actions = document.createElement('div');
          actions.className='flex flex-wrap';
          ['pending','delivered','missed','cancelled'].forEach(st=>{
            const b=document.createElement('button');
            b.textContent=st;
            b.className='text-[10px] px-2 py-1 rounded border mr-1 mb-1 '+(d.status===st?'bg-indigo-600 border-indigo-600 text-white':'border-slate-300 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-700');
            b.onclick=async()=>{ await call(`/api/deliveries/${d.id}/status`, {method:'PATCH', body: JSON.stringify({status: st})}); toast('Status updated','success'); refreshDeliveries(); loadStats(); };
            actions.append(b);
          });
          const del=document.createElement('button'); del.textContent='Delete'; del.className='text-[10px] px-2 py-1 rounded border mb-1 bg-red-600/80 hover:bg-red-600 border-red-700 text-white';
          del.onclick=async()=>{
            if(!confirmAction('Delete this delivery?')) { return; }
            try {
              await call(`/api/deliveries/${d.id}`, {method:'DELETE'});
              toast('Delivery deleted','success');
              refreshDeliveries();
              loadStats();
            } catch(e){
              console.error('Delete delivery failed', e);
              toast('Delete failed','error');
            }
          };
          actions.append(del);
          const notes = document.createElement('div');
          notes.className='hidden text-[11px] text-slate-600 dark:text-slate-400 pl-1';
          notes.textContent = d.notes? 'Notes: '+d.notes : 'No notes';
          row.onclick=(e)=>{ if(e.target.tagName==='BUTTON'){ return; } notes.classList.toggle('hidden'); };
          row.append(top, actions, notes);
          wrap.append(row);
        });
        renderHistory();
        // Recompute distribution if we have raw list and no stats endpoint breakdown (fallback)
        try { renderStatusDistribution(deliveries.reduce((a,d)=>{a[d.status]=(a[d.status]||0)+1; return a;},{})); } catch {}
      }

      document.getElementById('patient-form').addEventListener('submit', async e=>{
        e.preventDefault();
        const fd = new FormData(e.target);
        const body = Object.fromEntries(fd.entries());
        body.age = body.age? Number(body.age): null;
        const btn=document.getElementById('patient-submit'); const sp=document.getElementById('patient-spinner'); const err=document.getElementById('patient-error');
        err.textContent=''; btn.disabled=true; sp.classList.remove('hidden');
        try { await call('/api/patients', {method:'POST', body: JSON.stringify(body)}); e.target.reset(); toast('Patient added','success'); refreshPatients(); loadStats(); }
        catch(ex){ err.textContent=ex.message; toast('Add patient failed','error'); }
        finally { btn.disabled=false; sp.classList.add('hidden'); }
      });

      document.getElementById('drug-form').addEventListener('submit', async e=>{
        e.preventDefault();
        const fd = new FormData(e.target);
        const body = Object.fromEntries(fd.entries());
        const btn=document.getElementById('drug-submit'); const sp=document.getElementById('drug-spinner'); const err=document.getElementById('drug-error');
        err.textContent=''; btn.disabled=true; sp.classList.remove('hidden');
        try { await call('/api/drugs', {method:'POST', body: JSON.stringify(body)}); e.target.reset(); toast('Drug added','success'); refreshDrugs(); loadStats(); }
        catch(ex){ err.textContent=ex.message; toast('Add drug failed','error'); }
        finally { btn.disabled=false; sp.classList.add('hidden'); }
      });

      document.getElementById('delivery-form').addEventListener('submit', async e=>{
        e.preventDefault();
        const fd = new FormData(e.target);
        const body = Object.fromEntries(fd.entries());
        const btn=document.getElementById('delivery-submit'); const sp=document.getElementById('delivery-spinner'); const err=document.getElementById('delivery-error');
        err.textContent=''; btn.disabled=true; sp.classList.remove('hidden');
        try { await call('/api/deliveries', {method:'POST', body: JSON.stringify(body)}); e.target.reset(); toast('Delivery scheduled','success'); refreshDeliveries(); loadStats(); }
        catch(ex){ err.textContent=ex.message; toast('Schedule failed','error'); }
        finally { btn.disabled=false; sp.classList.add('hidden'); }
      });

    async function checkAPI(){
        const dot = document.getElementById('api-dot');
        try {
          await call('/api/health');
          dot.className='w-2 h-2 rounded-full bg-green-500';
          document.getElementById('api-indicator').lastChild.textContent='';
        } catch {
          dot.className='w-2 h-2 rounded-full bg-red-500 animate-pulse';
        }
      }

  function filterPatients(){ const term=(document.getElementById('patient-filter').value||'').toLowerCase(); if(!window.__patients){ return []; } return window.__patients.filter(p=> p.name.toLowerCase().includes(term) || (p.condition||'').toLowerCase().includes(term)); }
  function filterDrugs(){ const term=(document.getElementById('drug-filter').value||'').toLowerCase(); if(!window.__drugs){ return []; } return window.__drugs.filter(d=> d.name.toLowerCase().includes(term) || (d.dosage||'').toLowerCase().includes(term)); }
    document.getElementById('patient-filter').addEventListener('input', ()=> refreshPatients());
    document.getElementById('drug-filter').addEventListener('input', ()=> refreshDrugs());
    const themeBtn=document.getElementById('theme-toggle');
  // Dark theme removed; placeholder functions retained for other prefs.
    let countdown = 10; const cdEl=document.getElementById('refresh-countdown'); const auto=document.getElementById('auto-refresh');
  let refreshInterval = Number(loadPref('refreshInterval',10));
  setInterval(()=>{ if(!auto.checked){ cdEl.textContent=''; return; } countdown--; if(countdown<=0){ countdown=refreshInterval; refreshDeliveries(); loadStats(); renderAnalytics(); renderAlerts(); renderCalendar(); } cdEl.textContent='Refresh in '+countdown+'s'; },1000);
    function renderHistory(){
      const list = document.getElementById('history-list'); if(!list) return;
      const deliveries = (window.__deliveries||[]).slice();
      const status = (document.getElementById('history-status').value||'').trim();
      const term = (document.getElementById('history-search').value||'').toLowerCase();
      const filtered = deliveries.filter(d=>{
        if(status && d.status!==status) return false;
        if(term){ const hay = `#${d.id} p${d.patient_id} d${d.drug_id} ${d.notes||''}`.toLowerCase(); if(!hay.includes(term)) return false; }
        return true;
      });
      document.getElementById('history-count').textContent = filtered.length+ ' / '+deliveries.length;
      list.innerHTML = filtered.map(d=>`<div class='py-2 flex flex-col gap-1'>
        <div class='flex justify-between'><span class='font-medium'>#${d.id}</span><span class='text-[10px] uppercase tracking-wide'>${d.status}</span></div>
        <div class='text-[10px] text-slate-500 dark:text-slate-400'>P${d.patient_id} â€¢ D${d.drug_id} â€¢ ${d.scheduled_for}</div>
        <div class='text-[10px] text-slate-600 dark:text-slate-300'>${d.notes? d.notes: '<em class="not-italic text-slate-400">no notes</em>'}</div>
      </div>`).join('');
    }
    document.getElementById('history-status').addEventListener('change', renderHistory);
    document.getElementById('history-search').addEventListener('input', renderHistory);
    document.getElementById('history-refresh').addEventListener('click', (e)=>{ e.preventDefault(); refreshDeliveries(); });

    // Tabs
    const tabButtons = document.querySelectorAll('#main-nav .tab-btn');
    function activateTab(name){
      document.querySelectorAll('[data-view]').forEach(v=>{
        const show = v.getAttribute('data-view')===name;
        v.classList.toggle('hidden', !show);
      });
      tabButtons.forEach(b=>{
        const active = b.getAttribute('data-tab')===name;
        b.classList.toggle('bg-indigo-600', active);
        b.classList.toggle('text-white', active);
        b.classList.toggle('shadow', active);
        if(!active){
          b.classList.add('border','border-slate-300','dark:border-slate-600');
        } else {
          b.classList.remove('border','border-slate-300','dark:border-slate-600');
        }
      });
      savePref('activeTab', name);
      // Move nav indicator (new design)
      try {
        const ind=document.getElementById('nav-indicator');
        const activeBtn=[...tabButtons].find(b=> b.getAttribute('data-tab')===name);
        if(ind && activeBtn){
          const rect=activeBtn.getBoundingClientRect();
          const parentRect=activeBtn.parentElement.getBoundingClientRect();
          ind.style.width=rect.width+'px';
          ind.style.transform=`translateX(${rect.left-parentRect.left}px)`;
        }
      } catch{}
    }
    tabButtons.forEach(b=> b.addEventListener('click', ()=> activateTab(b.getAttribute('data-tab'))));
    activateTab(loadPref('activeTab','dashboard'));
    async function boot(){
        await checkAPI();
        buildDeliveryStatusFilters();
        try {
          await Promise.all([refreshPatients(), refreshDrugs()]);
          await refreshDeliveries();
          await loadStats();
          renderAnalytics();
          initCalendar();
          renderCalendar();
          renderAlerts();
        } catch(err){
          console.error('Initial boot failed', err);
          toast('Initial load failed','error');
        }
      }
      document.getElementById('seed-btn').addEventListener('click', async ()=>{
        if(!confirmAction('Insert demo data? This may duplicate existing records.')) return;
        const btn=document.getElementById('seed-btn'); btn.disabled=true; btn.textContent='Seeding...';
        setLoading(true,'Seeding demo data');
        try { await call('/api/seed', {method:'POST'}); toast('Seed complete','success'); logActivity('Seed data inserted'); await Promise.all([refreshPatients(), refreshDrugs(), refreshDeliveries(), loadStats()]); }
  catch(e){ console.error('Seed failed', e); toast('Seed failed','error'); }
        finally { setLoading(false); btn.disabled=false; btn.textContent='Seed Demo Data'; }
      });
      // CSV Export helpers
  function toCSV(rows){ if(!rows.length){ return ''; } const headers=Object.keys(rows[0]); const esc=v=> '"'+String(v??'').replace(/"/g,'""')+'"'; return [headers.join(','), ...rows.map(r=>headers.map(h=>esc(r[h])).join(','))].join('\n'); }
      function downloadFile(name, content){ const blob=new Blob([content],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1000); }
      document.getElementById('export-patients').addEventListener('click', ()=>{ if(!window.__patients){ toast('No data','error'); return; } downloadFile('patients.csv', toCSV(window.__patients)); });
      document.getElementById('export-drugs').addEventListener('click', ()=>{ if(!window.__drugs){ toast('No data','error'); return; } downloadFile('drugs.csv', toCSV(window.__drugs)); });
  document.getElementById('export-deliveries').addEventListener('click', ()=>{ if(!window.__deliveries){ toast('No data','error'); return; } downloadFile('deliveries.csv', toCSV(window.__deliveries)); });
  document.getElementById('toggle-overdue').addEventListener('click', (e)=>{ overdueOnly=!overdueOnly; e.target.classList.toggle('bg-red-600/40', overdueOnly); e.target.classList.toggle('text-red-300', overdueOnly); refreshDeliveries(); });
  document.getElementById('export-all').addEventListener('click', ()=>{ const parts=[]; if(window.__patients){ parts.push({name:'patients', rows:window.__patients}); } if(window.__drugs){ parts.push({name:'drugs', rows:window.__drugs}); } if(window.__deliveries){ parts.push({name:'deliveries', rows:window.__deliveries}); } if(!parts.length){ toast('No data','error'); return; } parts.forEach(p=> downloadFile(p.name+'.csv', toCSV(p.rows))); });
      // Global search
      const gs=document.getElementById('global-search'); const gsBox=document.getElementById('global-search-results');
      if(gs){
        gs.addEventListener('input', ()=>{
          const q=gs.value.trim().toLowerCase();
          if(!q){ gsBox.classList.add('hidden'); gsBox.innerHTML=''; return; }
          const results=[];
          (window.__patients||[]).forEach(p=>{ if(p.name.toLowerCase().includes(q) || String(p.id)===q) results.push({type:'Patient', id:p.id, label:p.name}); });
          (window.__drugs||[]).forEach(d=>{ if(d.name.toLowerCase().includes(q) || String(d.id)===q) results.push({type:'Drug', id:d.id, label:d.name}); });
          (window.__deliveries||[]).forEach(dv=>{ if(String(dv.id)===q || dv.status.toLowerCase().includes(q)) results.push({type:'Delivery', id:dv.id, label:dv.status+' #'+dv.id}); });
          if(!results.length){ gsBox.innerHTML='<div class="p-3 text-[11px] text-slate-500">No matches</div>'; gsBox.classList.remove('hidden'); return; }
          gsBox.innerHTML=results.slice(0,40).map(r=>`<button data-gs-type='${r.type}' data-gs-id='${r.id}' class='w-full text-left px-3 py-2 hover:bg-slate-700 flex items-center gap-2'><span class='text-[10px] px-1.5 py-0.5 rounded bg-slate-700 border border-slate-600'>${r.type[0]}</span><span class='flex-1 truncate'>${r.label}</span><span class='text-slate-500 text-[10px]'>#${r.id}</span></button>`).join('');
          gsBox.classList.remove('hidden');
        });
        gsBox.addEventListener('click', e=>{
          const btn = e.target.closest('button[data-gs-type]');
          if(!btn){
            return;
          }
          const t = btn.getAttribute('data-gs-type');
          if(t==='Patient'){
            activateTab('patients');
          } else if(t==='Drug'){
            activateTab('drugs');
          } else if(t==='Delivery'){
            activateTab('deliveries');
          }
          gsBox.classList.add('hidden');
          gs.value='';
        });
        document.addEventListener('click', e=>{ if(!gs.contains(e.target) && !gsBox.contains(e.target)) gsBox.classList.add('hidden'); });
      }
      // Patient modal logic
      function openPatientModal(id){
        const modal=document.getElementById('patient-modal'); const body=document.getElementById('pm-body'); const title=document.getElementById('pm-title');
        const p=(window.__patients||[]).find(x=>x.id===id); if(!p){ return; }
        const deliveries=(window.__deliveries||[]).filter(d=>d.patient_id===id);
        title.textContent='Patient #'+p.id+' â€“ '+p.name;
        body.innerHTML=`<div class='space-y-3'>
          <div><div class='text-[10px] uppercase text-slate-400 mb-1'>Info</div><div class='text-xs'>Age: ${p.age??'â€”'}${p.condition? ' â€¢ Condition: '+escapeHTML(p.condition):''}${p.contact? ' â€¢ Contact: '+escapeHTML(p.contact):''}</div></div>
          <div><div class='text-[10px] uppercase text-slate-400 mb-1'>Deliveries (${deliveries.length})</div><div class='space-y-2 max-h-48 overflow-auto'>${deliveries.map(d=>`<div class='flex items-center justify-between text-[11px] border-b border-slate-700 pb-1'><span>#${d.id}</span><span>${statusBadge(d.status)}</span><span>${d.scheduled_for}</span></div>`).join('') || '<div class="text-[11px] text-slate-500">No deliveries</div>'}</div></div>
        </div>`;
        modal.classList.remove('hidden'); modal.classList.add('flex');
      }
      document.getElementById('pm-close').addEventListener('click', ()=>{ const m=document.getElementById('patient-modal'); m.classList.add('hidden'); m.classList.remove('flex'); });
      document.getElementById('patient-modal').addEventListener('click', e=>{ if(e.target.id==='patient-modal'){ document.getElementById('pm-close').click(); }});

      // Analytics rendering
      function aggregateDeliveriesByDay(days=14){
        const map=new Map();
        (window.__deliveries||[]).forEach(d=>{ const day=d.scheduled_for? d.scheduled_for.substring(0,10):''; if(!day){ return; } const obj=map.get(day)||{pending:0,delivered:0,missed:0,cancelled:0,total:0}; obj[d.status]=(obj[d.status]||0)+1; obj.total++; map.set(day,obj); });
        const allDays=[...map.keys()].sort();
        const recent=allDays.slice(-days);
        return recent.map(day=>({day, ...(map.get(day))}));
      }
      function renderAnalytics(){
        const data=aggregateDeliveriesByDay(14); const rangeEl=document.getElementById('analytics-range'); if(rangeEl){ if(data.length){ rangeEl.textContent = data[0].day+' â†’ '+data[data.length-1].day; } else { rangeEl.textContent='(no data)'; } }
        // line chart
        const points=data.map((d,i)=>({x:i,y:d.total})); drawLineChart('daily-line', points);
        // status mix
        const statusBox=document.getElementById('analytics-status'); if(statusBox){
          const sum={pending:0,delivered:0,missed:0,cancelled:0}; data.forEach(d=>{ ['pending','delivered','missed','cancelled'].forEach(k=> sum[k]+= d[k]||0); });
          const total=Object.values(sum).reduce((a,b)=>a+b,0);
          if(!total){ statusBox.innerHTML='<div class="text-slate-500">No recent data</div>'; } else {
            statusBox.innerHTML=['pending','delivered','missed','cancelled'].filter(k=>sum[k]).map(k=>{ const pct=((sum[k]/total)*100).toFixed(1); return `<div class='flex justify-between'><span class='capitalize'>${k}</span><span>${sum[k]} â€¢ ${pct}%</span></div>`; }).join('');
          }
        }
        const top=document.getElementById('top-patients'); if(top){
          const counts={}; (window.__deliveries||[]).forEach(d=>{ counts[d.patient_id]=(counts[d.patient_id]||0)+1; });
          const sorted=Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,5);
          top.innerHTML= sorted.length? sorted.map(([pid,c])=>{ const p=(window.__patients||[]).find(pp=>pp.id==pid); return `<li>${p? p.name: 'Patient '+pid} â€“ <span class='text-slate-400'>${c}</span></li>`; }).join('') : '<li class="list-none text-slate-500">No data</li>';
        }
      }
      document.getElementById('analytics-refresh').addEventListener('click', ()=> renderAnalytics());

      // Calendar
      let calDate = new Date();
      function startOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(),1); }
      function endOfMonth(d){ return new Date(d.getFullYear(), d.getMonth()+1,0); }
      function fmtDate(d){ return d.toISOString().substring(0,10); }
      function initCalendar(){ document.getElementById('cal-prev').addEventListener('click', ()=>{ calDate=new Date(calDate.getFullYear(), calDate.getMonth()-1,1); renderCalendar(); }); document.getElementById('cal-next').addEventListener('click', ()=>{ calDate=new Date(calDate.getFullYear(), calDate.getMonth()+1,1); renderCalendar(); }); document.getElementById('cal-today').addEventListener('click', ()=>{ calDate=new Date(); renderCalendar(); }); }
      function renderCalendar(){
        const grid=document.getElementById('cal-grid'); if(!grid){ return; }
        const title=document.getElementById('cal-title');
        const monthStart=startOfMonth(calDate); const monthEnd=endOfMonth(calDate);
        title.textContent= calDate.toLocaleString(undefined,{month:'long', year:'numeric'});
        const firstDow=monthStart.getDay(); const days=monthEnd.getDate();
        grid.innerHTML='';
        const deliveries=(window.__deliveries||[]); const dailyMap={};
        deliveries.forEach(d=>{ const day=d.scheduled_for? d.scheduled_for.substring(0,10):''; if(day){ dailyMap[day]=(dailyMap[day]||0)+1; } });
        for(let i=0;i<firstDow;i++){ const pad=document.createElement('div'); pad.className='opacity-0'; grid.append(pad); }
        const todayStr=fmtDate(new Date());
        for(let day=1; day<=days; day++){
          const dateStr= fmtDate(new Date(calDate.getFullYear(), calDate.getMonth(), day));
          const btn=document.createElement('button'); const count=dailyMap[dateStr]||0;
          btn.className='rounded-lg border border-slate-700 bg-slate-900/40 hover:bg-slate-700 flex flex-col items-center justify-center py-2 gap-1 relative';
          if(dateStr===todayStr){ btn.classList.add('ring-2','ring-indigo-500'); }
          let badge='';
          if(count){ badge = "<span class='text-[10px] px-1 rounded bg-indigo-600/30 text-indigo-300'>"+count+"</span>"; }
          btn.innerHTML = "<span class='text-[11px] font-medium'>"+day+"</span>"+badge;
          btn.onclick=()=> selectCalendarDay(dateStr);
          grid.append(btn);
        }
      }
      function selectCalendarDay(dateStr){ const list=document.getElementById('cal-day-list'); if(!list){ return; } const deliveries=(window.__deliveries||[]).filter(d=> d.scheduled_for && d.scheduled_for.startsWith(dateStr)); list.innerHTML= deliveries.length? deliveries.map(d=> `<div class='border border-slate-700 rounded p-2 flex justify-between'><span class='font-medium'>#${d.id}</span><span>${statusBadge(d.status)}</span><span class='text-slate-400'>${d.scheduled_for.substring(11,16)||''}</span></div>`).join('') : `<div class='text-slate-500'>No deliveries on ${dateStr}</div>`; }

      // Alerts (overdue & missed)
      function renderAlerts(){ const list=document.getElementById('alert-list'); if(!list){ return; } const now=Date.now(); const deliveries=(window.__deliveries||[]); const alerts=deliveries.filter(d=> (d.status==='pending' && new Date(d.scheduled_for).getTime()<now) || d.status==='missed'); list.innerHTML= alerts.length? alerts.map(d=> `<div class='border border-red-600/40 bg-red-600/10 rounded p-2 flex flex-col gap-1'><div class='flex justify-between text-[11px]'><span class='font-medium'>#${d.id}</span><span>${statusBadge(d.status)}</span></div><div class='text-[10px] text-slate-400'>Scheduled: ${d.scheduled_for}</div></div>`).join('') : '<div class="text-slate-500 text-[11px]">No alerts ðŸŽ‰</div>'; const c=document.getElementById('alert-count'); if(c){ c.textContent= alerts.length+' issue'+(alerts.length!==1?'s':''); } }

      // Keyboard shortcuts
      document.addEventListener('keydown', e=>{
        if(e.key==='/' && document.activeElement!==document.getElementById('global-search')){ e.preventDefault(); const g=document.getElementById('global-search'); if(g){ g.focus(); g.select(); } }
        if(e.altKey){ const map={1:'dashboard',2:'patients',3:'drugs',4:'deliveries',5:'history',6:'analytics',7:'calendar',8:'alerts',9:'settings'}; const tab=map[e.key]; if(tab){ e.preventDefault(); activateTab(tab); } }
        if(e.ctrlKey && e.shiftKey && e.key.toLowerCase()==='e'){ e.preventDefault(); document.getElementById('export-all').click(); }
        if(e.ctrlKey && e.shiftKey && e.key.toLowerCase()==='s'){ e.preventDefault(); document.getElementById('seed-btn').click(); }
        if(e.key==='Escape'){ const modal=document.getElementById('patient-modal'); if(modal && !modal.classList.contains('hidden')){ document.getElementById('pm-close').click(); } }
      });

      // Settings form
      document.getElementById('set-refresh').value= refreshInterval;
      document.getElementById('set-activity-display').value= ACTIVITY_DISPLAY_LIMIT;
      document.getElementById('set-activity-store').value= ACTIVITY_STORE_LIMIT;
      document.getElementById('settings-form').addEventListener('submit', e=>{ e.preventDefault(); const r=Number(document.getElementById('set-refresh').value)||10; const ad=Number(document.getElementById('set-activity-display').value)||50; const as=Number(document.getElementById('set-activity-store').value)||200; refreshInterval=Math.min(Math.max(r,5),300); countdown=refreshInterval; ACTIVITY_DISPLAY_LIMIT=Math.min(Math.max(ad,10),200); ACTIVITY_STORE_LIMIT=Math.min(Math.max(as,50),1000); savePref('refreshInterval', refreshInterval); savePref('activityDisplayLimit', ACTIVITY_DISPLAY_LIMIT); savePref('activityStoreLimit', ACTIVITY_STORE_LIMIT); const stat=document.getElementById('settings-status'); stat.textContent='Saved'; setTimeout(()=> stat.textContent='',2000); });

      loadActivity();
      boot();
      setInterval(checkAPI, 5000);
    </script>
  </body>
  </html>
